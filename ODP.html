<!DOCTYPE html>
<!-- saved from url=(0109)file:///C:/Users/zhaoguanghui03/Desktop/ODP%E6%95%99%E7%A8%8B%20_%20%E7%99%BE%E5%BA%A6%E6%89%8B%E5%86%8C.html -->
<html lang="zh-CN"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="author" content="">

<title>ODP教程 | 百度手册</title>

<!-- Bootstrap core CSS -->
<link href="./ODP_files/bootstrap.min.css" rel="stylesheet">

<!-- Documentation extras -->
<link href="./ODP_files/docs.css" rel="stylesheet">
<link href="./ODP_files/github.css" rel="stylesheet">
<link href="./ODP_files/autosuggest.css" rel="stylesheet">
<script src="./ODP_files/jquery.min.js.下载"></script>
<style>

</style>
<!--[if lt IE 9]><script src="../docs-assets/js/ie8-responsive-file-warning.js"></script><![endif]-->

<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
<![endif]-->

<style id="holderjs-style" type="text/css"></style><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Hover_Arrow {position: absolute; width: 15px; height: 11px; cursor: pointer}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 2px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 2px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; color: #666666}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuRadioCheck {position: absolute; left: 1em}
.MathJax_MenuLabel {padding: 2px 2em 4px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #CCCCCC; margin: 4px 1px 0px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: Highlight; color: HighlightText}
.MathJax_Menu_Close {position: absolute; width: 31px; height: 31px; top: -15px; left: -15px}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style type="text/css">.MathJax_Display {text-align: center; margin: 1em 0em; position: relative; display: block; width: 100%}
.MathJax .merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
#MathJax_Tooltip {background-color: InfoBackground; color: InfoText; border: 1px solid black; box-shadow: 2px 2px 5px #AAAAAA; -webkit-box-shadow: 2px 2px 5px #AAAAAA; -moz-box-shadow: 2px 2px 5px #AAAAAA; -khtml-box-shadow: 2px 2px 5px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true'); padding: 3px 4px; z-index: 401; position: absolute; left: 0; top: 0; width: auto; height: auto; display: none}
.MathJax {display: inline; font-style: normal; font-weight: normal; line-height: normal; font-size: 100%; font-size-adjust: none; text-indent: 0; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; direction: ltr; border: 0; padding: 0; margin: 0}
.MathJax img, .MathJax nobr, .MathJax a {border: 0; padding: 0; margin: 0; max-width: none; max-height: none; vertical-align: 0; line-height: normal; text-decoration: none}
img.MathJax_strut {border: 0 !important; padding: 0 !important; margin: 0 !important; vertical-align: 0 !important}
.MathJax span {display: inline; position: static; border: 0; padding: 0; margin: 0; vertical-align: 0; line-height: normal; text-decoration: none}
.MathJax nobr {white-space: nowrap ! important}
.MathJax img {display: inline ! important; float: none ! important}
.MathJax * {transition: none; -webkit-transition: none; -moz-transition: none; -ms-transition: none; -o-transition: none}
.MathJax_Processing {visibility: hidden; position: fixed; width: 0; height: 0; overflow: hidden}
.MathJax_Processed {display: none!important}
.MathJax_ExBox {display: block; overflow: hidden; width: 1px; height: 60ex}
.MathJax .MathJax_EmBox {display: block; overflow: hidden; width: 1px; height: 60em}
.MathJax .MathJax_HitBox {cursor: text; background: white; opacity: 0; filter: alpha(opacity=0)}
.MathJax .MathJax_HitBox * {filter: none; opacity: 1; background: transparent}
#MathJax_Tooltip * {filter: none; opacity: 1; background: transparent}
@font-face {font-family: MathJax_Main; src: url('http://man.baidu.com/_static/MathJax/fonts/HTML-CSS/TeX/woff/MathJax_Main-Regular.woff') format('woff'), url('http://man.baidu.com/_static/MathJax/fonts/HTML-CSS/TeX/otf/MathJax_Main-Regular.otf') format('opentype')}
@font-face {font-family: MathJax_Main; src: url('http://man.baidu.com/_static/MathJax/fonts/HTML-CSS/TeX/woff/MathJax_Main-Bold.woff') format('woff'), url('http://man.baidu.com/_static/MathJax/fonts/HTML-CSS/TeX/otf/MathJax_Main-Bold.otf') format('opentype'); font-weight: bold}
@font-face {font-family: MathJax_Main; src: url('http://man.baidu.com/_static/MathJax/fonts/HTML-CSS/TeX/woff/MathJax_Main-Italic.woff') format('woff'), url('http://man.baidu.com/_static/MathJax/fonts/HTML-CSS/TeX/otf/MathJax_Main-Italic.otf') format('opentype'); font-style: italic}
@font-face {font-family: MathJax_Math; src: url('http://man.baidu.com/_static/MathJax/fonts/HTML-CSS/TeX/woff/MathJax_Math-Italic.woff') format('woff'), url('http://man.baidu.com/_static/MathJax/fonts/HTML-CSS/TeX/otf/MathJax_Math-Italic.otf') format('opentype'); font-style: italic}
@font-face {font-family: MathJax_Caligraphic; src: url('http://man.baidu.com/_static/MathJax/fonts/HTML-CSS/TeX/woff/MathJax_Caligraphic-Regular.woff') format('woff'), url('http://man.baidu.com/_static/MathJax/fonts/HTML-CSS/TeX/otf/MathJax_Caligraphic-Regular.otf') format('opentype')}
@font-face {font-family: MathJax_Size1; src: url('http://man.baidu.com/_static/MathJax/fonts/HTML-CSS/TeX/woff/MathJax_Size1-Regular.woff') format('woff'), url('http://man.baidu.com/_static/MathJax/fonts/HTML-CSS/TeX/otf/MathJax_Size1-Regular.otf') format('opentype')}
@font-face {font-family: MathJax_Size2; src: url('http://man.baidu.com/_static/MathJax/fonts/HTML-CSS/TeX/woff/MathJax_Size2-Regular.woff') format('woff'), url('http://man.baidu.com/_static/MathJax/fonts/HTML-CSS/TeX/otf/MathJax_Size2-Regular.otf') format('opentype')}
@font-face {font-family: MathJax_Size3; src: url('http://man.baidu.com/_static/MathJax/fonts/HTML-CSS/TeX/woff/MathJax_Size3-Regular.woff') format('woff'), url('http://man.baidu.com/_static/MathJax/fonts/HTML-CSS/TeX/otf/MathJax_Size3-Regular.otf') format('opentype')}
@font-face {font-family: MathJax_Size4; src: url('http://man.baidu.com/_static/MathJax/fonts/HTML-CSS/TeX/woff/MathJax_Size4-Regular.woff') format('woff'), url('http://man.baidu.com/_static/MathJax/fonts/HTML-CSS/TeX/otf/MathJax_Size4-Regular.otf') format('opentype')}
.MathJax .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style><style type="text/css">@font-face {font-family: MathJax_AMS; src: url('http://man.baidu.com/_static/MathJax/fonts/HTML-CSS/TeX/woff/MathJax_AMS-Regular.woff') format('woff'), url('http://man.baidu.com/_static/MathJax/fonts/HTML-CSS/TeX/otf/MathJax_AMS-Regular.otf') format('opentype')}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style></head>
<body><div id="MathJax_Message" style="display: none;"></div><div style="visibility: hidden; overflow: hidden; position: absolute; top: 0px; height: 1px; width: auto; padding: 0px; border: 0px; margin: 0px; text-align: left; text-indent: 0px; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal;"><div id="MathJax_Hidden"></div></div><div id="MathJax_Message" style="display: none;"></div>
<a class="sr-only" href="http://man.baidu.com/inf/odp/tutorial/#content">Skip to main content</a>

<!-- Docs master nav -->
<header class="navbar navbar-inverse navbar-fixed-top bs-docs-nav" role="banner">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="http://man.baidu.com/" class="navbar-brand">百度手册</a>
    </div>
    <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
      <ul class="nav navbar-nav">
        <li>
                    </li><li><a href="http://man.baidu.com/inf/odp">ODP主页</a></li>
                    <li><a href="http://nginx.baidu.com/book/nginx_user_manual/">Nginx</a></li>
                    <li><a href="http://man.baidu.com/inf/hhvm">HHVM</a></li>
                    <li><a href="http://man.baidu.com/inf/odp/ral2">RAL</a></li>
                  
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li class="navbar-right search">
          <input type="text" id="scm_path" class="form-control col-md-4" placeholder="模块名" autocomplete="off">
        </li>
        <li class="navbar-right"><a href="http://man.baidu.com/howto">如何编辑</a></li>
      </ul>
    </nav>
  </div>
</header>

<div class="bs-header" id="content">
  <div class="container">
    <h1>ODP教程</h1>
    <p>
      Online Develop Platform，在线业务开发平台的使用教程。
      <a type="button" class="btn btn-default btn-xs" role="button" href="http://man.baidu.com/inf/odp/tutorial/meta?edit=1&amp;source=inf/odp/tutorial/">
        <span class="glyphicon glyphicon-edit"></span> 编辑
      </a>
    </p>
    <p class="last-update">Last update: 17th November, 2016, Thursday</p>
  </div>
</div>

<div class="container bs-docs-container">
  <div class="row">
    <div class="col-md-3">
      <div class="bs-sidebar hidden-print affix-top" role="complementary">
        <ul class="nav bs-sidenav">

                                  <li class="active">
                                        <a href="http://man.baidu.com/inf/odp/tutorial/#简介" file="/inf/odp/tutorial/introduction">简介</a>
                        </li>
                                  <li>
                                        <a href="http://man.baidu.com/inf/odp/tutorial/#ODP安装" file="/inf/odp/tutorial/../../odp3/install">ODP 安装</a>
                        </li>
                                  <li>
                                        <a href="http://man.baidu.com/inf/odp/tutorial/#老版本ODP安装" file="/inf/odp/tutorial/03">老版本 ODP 安装</a>
                        </li>
                                  <li>
                                        <a href="http://man.baidu.com/inf/odp/tutorial/#ODP文件环境介绍" file="/inf/odp/tutorial/04">ODP 文件环境介绍</a>
                        </li>
                                  <li>
                                        <a href="http://man.baidu.com/inf/odp/tutorial/#APP-CG工具的使用" file="/inf/odp/tutorial/05">APP-CG 工具的使用</a>
                        </li>
                                  <li>
                                        <a href="http://man.baidu.com/inf/odp/tutorial/#AP框架" file="/inf/odp/tutorial/06">AP 框架</a>
                        </li>
                                  <li>
                                        <a href="http://man.baidu.com/inf/odp/tutorial/#业务层规范" file="/inf/odp/tutorial/07">业务层规范</a>
                        </li>
                                  <li>
                                        <a href="http://man.baidu.com/inf/odp/tutorial/#数据库交互" file="/inf/odp/tutorial/08">数据库交互</a>
                        </li>
                                  <li>
                                        <a href="http://man.baidu.com/inf/odp/tutorial/#SAF框架" file="/inf/odp/tutorial/09">SAF 框架</a>
                        </li>
                                  <li>
                                        <a href="http://man.baidu.com/inf/odp/tutorial/#ODP基础库" file="/inf/odp/tutorial/10">ODP 基础库</a>
                        </li>
                                  <li>
                                        <a href="http://man.baidu.com/inf/odp/tutorial/#RAL" file="/inf/odp/tutorial/11">RAL</a>
                        </li>
                                  <li>
                                        <a href="http://man.baidu.com/inf/odp/tutorial/#Ksarch服务" file="/inf/odp/tutorial/12">Ksarch 服务</a>
                        </li>
                                  <li>
                                        <a href="http://man.baidu.com/inf/odp/tutorial/#PhpTest单元测试框架" file="/inf/odp/tutorial/13">PhpTest 单元测试框架</a>
                        </li>
                                  <li>
                                        <a href="http://man.baidu.com/inf/odp/tutorial/#OCM工具" file="/inf/odp/tutorial/02">OCM 工具</a>
                        </li>
                                  <li>
                                        <a href="http://man.baidu.com/inf/odp/tutorial/#常见问题" file="/inf/odp/tutorial/faq">常见问题</a>
                        </li>
                                  <li>
                                        <a href="http://man.baidu.com/inf/odp/tutorial/#联系我们" file="/inf/odp/tutorial/../contact">联系我们</a>
                        </li>
                  </ul>
      </div>
    </div>
    <div class="col-md-9" role="main">

                <div class="bs-docs-section">
              <div class="page-header">
          <h1 id="简介">简介
            <a class="btn btn-edit btn-primary pull-right">
              <span class="glyphicon glyphicon-edit"></span> 编辑本段
            </a>
          </h1>
        </div>
                <h3>重要新闻</h3>

<p><b><font color="red">odp已支持php7</font></b>，<a href="http://agroup.baidu.com/share/md/0e4fb4db38bd4bbfb6cfdaef36671b7f">详情</a></p>

<h3>一、概述</h3>

<p>ODP是公司发布的在线业务开发平台，面向全百度的在线业务支撑平台，专注于总结大社区类业务模式，其提供了标准的webserver环境、标准php环境、AP框架、SAF社区业务框架、基础库、RAL资源访问层、KSARCH通用服务等组件，统一业务的逻辑和部署结构，为测试、运维等提供一致的视图。</p>

<p>ODP作为百度内部PHP开发的标准框架，覆盖了公司大部分把PHP作为业务开发语言的团队，影响超过千人以上PHP工程师的开发，对RD/QA的学习、开发和测试效率提升100%以上。</p>

<p><a href="http://hetu.baidu.com/api/platform/index?platformId=515">ODP介绍PPT</a></p>

<p><a href="http://learn.baidu.com/courseInfo.html?courseId=745">ODP视频教程</a></p>

<h3>二、ODP全景介绍</h3>

<p>现阶段，ODP的全景图示如下：</p>

<p style="text-align: center; margin: 30px 0px; text-indent: 0px;"><img src="./ODP_files/odp_0_1.jpg" alt="ODP 全景"><div class="legend">图 1 : ODP 全景</div></p><div class="legend">图 1 : ODP 全景</div><p></p>

<h3>三、ODP核心</h3>

<p>ODP核心包含了ODP的核心功能组件，包括运行环境、核心基础库、数据交互层、框架等。</p>

<p>横向看，ODP核心通过库、框架、工具等集成支持了各类规范和模式，也为全流程支持提供接口。</p>

<p>向上看，ODP核心直接为产品线业务提供运行环境和研发支持。</p>

<p>向下看，ODP核心通过数据交互层将底层的通用服务提供给业务。</p>

<p>ODP核心支持插件机制(参见《ODP组件规范》)，各技术组和产品线可通过插件向ODP增加新功能，比如基础库、测试框架、工具等，ODP目前已集成的插件包括：</p>

<ol>
<li><p>测试插件：phptest、pcheck等测试框架和检查工具。</p></li>
<li><p>前端插件：Smarty模板插件。</p></li>
<li><p>国际化插件：i18n、layerproxy等国际化相关的库和框架。</p></li>
<li><p>通用服务插件：Passport插件、ksarch服务插件。</p></li>
</ol>

<h3>四、基础服务</h3>

<p>ODP核心通过数据交互层将底层的通用服务提供给业务，目前，ODP为大社区类业务集成了较为完备的通用服务支持。</p>

<ol>
<li><p>MySQL 集群</p>

<p>为 DBA 和运维提供统一的 MySQL 存储服务，具有高可用、高性能、自动读写分离等工业级特性。</p></li>
<li><p>Ksarch通用服务</p>

<p>Ksarch为大社区类业务提供了大量成熟稳定的通用服务，如反作弊、检索、提交、高性能、kv存储、memcached等。</p></li>
</ol>

<h3>五、规范与模式</h3>

<p>基于公司内外已有的经验、教训，并结合公司现状，ODP总结和抽取出适合大社区类业务的开发规范，以及针对大社区类业务的最佳开发实践、开发模式。</p>

<p>目前，ODP内含的主要规范和模式包括：</p>

<ol>
<li><p>ODP APP规范</p>

<p>本规范规定了基于ODP的业务开发、测试和部署规范，包括APP的MVC结构、逻辑分层、SVN结构、可测性、部署等，是ODP最为重要的规范。</p></li>
<li><p>配套工具</p>

<p>app-cg(app代码框架生成)，pcheck(代码静态检查工具)，build.sh(标准打包工具)</p></li>
<li><p>ODP组件规范</p>

<p>本规范规定了ODP组件包括插件的相关规范，包括组件行为、组件构成、SVN结构、部署等，是ODP2.0新增的重要规范。</p></li>
<li><p>ODP子系统指南</p>

<p>本指南给出了子系统划分和抽象的一般性原则，并介绍了ODP子系统框架的使用，是ODP2.0新增的重要规范。</p></li>
<li><p>ODP PHP编码规范</p>

<p>本规范基于公司的PHP编码规范进行了强化。</p></li>
</ol>

<p>ODP中的规范和模式不同于公司以往的规范或模式，ODP非常注重规范和模式的实际落地，因此结合了大量的框架、基础库和工具，以保证这一点。</p>

<h3>六、全流程支持</h3>

<p>为了实现产品快速开发的目的，必须打通产品开发的各个环节，提供全流程的支持。对此，ODP结合公司现状，提供了一定程度的全流程支持，主要有：</p>

<ol>
<li><p>测试</p>

<p>ODP的业务层次、代码规范等与QA规范对接，符合QA的可测性要求，同时，ODP内置标准的测试框架和工具，极大方便了测试工作。</p></li>
<li><p>前端</p>

<p>ODP的前端部署结构和业务分层与 FIS(FE集成解决方案)规范对接，并集成了符合FIS规范的Smarty模板库。</p></li>
<li><p>运维</p>

<p>ODP整体结构符合百度现有的运维规范，支持现有的初始化平台、Noah等运维平台，并提供了一键安装、组件管理等运维工具，从而为运维提供了同构化的视图。</p></li>
</ol>

            </div>
                <div class="bs-docs-section">
              <div class="page-header">
          <h1 id="ODP安装">ODP 安装
            <a class="btn btn-edit btn-primary pull-right">
              <span class="glyphicon glyphicon-edit"></span> 编辑本段
            </a>
          </h1>
        </div>
                <h3>系统要求</h3>

<ul>
<li>64位Linux系统</li>
<li>HHVM要求系统内核版本 &gt;= 2.6.32，如不使用HHVM则不需要</li>
</ul>

<h3>版本选择</h3>

<h4>ODP 3.1版本列表</h4>

<p>ODP 3.1提供4个版本，从该版本开始不再提供集成lighttpd的安装包。</p>

<pre><code class="bash">PHP 5.2.17版：
5d69d538a239451f02afcfce3c5e9de6  odp-3.1.0-develop-nginx.tar.gz
af0431c0adb08e1f0e4e30d034e3f38e  odp-3.1.0-online-nginx.tar.gz

PHP 5.4.33版：
6f722a282e657394958ac133383d5025  odp-3.1.0-develop-nginx-php-5.4.tar.gz
15e9925b83ef73c7a52447bc84a2b58b  odp-3.1.0-online-nginx-php-5.4.tar.gz
</code></pre>

<h4>ODP 3.0版本列表</h4>

<p>ODP 3.0有8个版本可以选择：</p>

<pre><code class="bash">PHP 5.2.17版：
e082b525dc814bc9a80d3569152a6c73  odp-3.0.2-develop-lighttpd.tar.gz
f1e8acdcf5905cf21a52fec7c5d47304  odp-3.0.2-develop-nginx.tar.gz
3bf0b8fa58ca11eeb23a4049b0738099  odp-3.0.2-online-lighttpd.tar.gz
4a5c994f50973691f3d5746941f84536  odp-3.0.2-online-nginx.tar.gz

PHP 5.4.33版：
c27c417506ec8a18a399f86ca32be3ac  odp-3.0.2-develop-lighttpd-php-5.4.tar.gz
ebfa1298a55f2989291fcba8b8d76b64  odp-3.0.2-develop-nginx-php-5.4.tar.gz
20530de07f169260d58619cb8116ec74  odp-3.0.2-online-lighttpd-php-5.4.tar.gz
e968b16001b2834e116c0e07db229aad  odp-3.0.2-online-nginx-php-5.4.tar.gz
</code></pre>

<p>nginx和lighttpd是不同的webserver实现，推荐使用<a href="http://nginx.baidu.com/">nginx</a>。</p>

<p>不同php版本的区别：php 5.2.17是百度内部广泛使用的版本，对已有app兼容性好；php 5.4.33提供更多语法和功能，但对已有app可能存在兼容性问题，请注意回归自己的业务。</p>

<p>develop版和online版的区别：</p>

<ol>
<li>develop版多出xdebug、phpunit等开发用的组件</li>
<li>develop默认配置的资源占用更少，如php-fpm进程数、hhvm jit内存等配置较小的值，方便在低端机器运行</li>
<li>develop版的配置更偏重调试（如输出错误到页面），而online版配置更偏重安全（如开启防攻击、错误重定向）</li>
</ol>

<p>建议：</p>

<ol>
<li>线下功能开发测试使用develop版，上线前再用online版回归一下</li>
<li>压力测试使用online版，但需要去掉webserver的防攻击策略</li>
<li>线上部署使用online版</li>
</ol>

<h3>安装</h3>

<p>选择版本后，安装只须下载解压相应安装包，并执行<code>bin/odp_install</code>即可：</p>

<pre><code class="bash">mkdir /home/work/odp  <span class="comment"><span class="comment"># 想要安装ODP的目录</span></span>
cd /home/work/odp
wget <span class="string"><span class="string">'http://odp.baidu.com/download/odp-3.1.0-develop-nginx.tar.gz'</span></span>
tar xzf odp-3.1.0-*.tar.gz
bin/odp_install
</code></pre>

<p>出现类似如下输出，说明安装成功了：</p>

<pre><code class="bash">On first use, install package: hhvm Nginx odp PHP
On first use, install binary: nginx php php-cgi
</code></pre>

<p>如果是自己PC上装的系统，还需要删除ral的bns配置：</p>

<pre><code class="bash">rm conf/ral/services/ak.conf
</code></pre>

<p>原因是自己装的系统没有bns的naming-agent，这会导致ral获取bns信息超时，php和hhvm启动很慢。如果确实需要使到这些服务请改成ip方式访问。</p>

<p>查看安装信息：</p>

<pre><code class="bash">bin/ocm list    <span class="comment"><span class="comment">#查看安装的ODP组件列表</span></span>
php/bin/php -m  <span class="comment"><span class="comment">#查看php扩展的加载情况</span></span>
<span class="keyword"><span class="keyword">echo</span></span> <span class="string"><span class="string">'p get_loaded_extensions()'</span></span> | hhvm/bin/hhvm -m debug  <span class="comment"><span class="comment">#查看hhvm的扩展加载情况</span></span>
</code></pre>

<h3>启动服务</h3>

<p>ODP weberver端口默认为8080，如果端口已被占用，则需要修改相应配置文件中的端口：</p>

<p>注意：请选择8000-9000之间的端口，其他端口可能会受到防火墙规则的限制。</p>

<ul>
<li>Nginx: <code>webserver/conf/vhost/php.conf</code></li>
<li>Lighttpd: <code>webserver/conf/lighttpd.conf</code></li>
</ul>

<p>启动php或hhvm：</p>

<pre><code class="bash">php/sbin/php-fpm start
hhvm/bin/hhvm_control start
</code></pre>

<p>启动nginx或lighttpd：</p>

<pre><code class="bash">webserver/loadnginx.sh start
webserver/bin/lighttpd.sh start
</code></pre>

<h3>从php切换到hhvm</h3>

<p>如果使用hhvm，则需要切换webserver的配置到hhvm。Nginx配置切换需要修改<code>webserver/conf/vhost/php.conf</code>：</p>

<pre><code class="bash">    <span class="comment"><span class="comment">#set $php_upstream 'unix:${ODP_ROOT}/var/php-cgi.sock';   #注释掉这行</span></span>
    <span class="keyword"><span class="keyword">set</span></span> <span class="variable"><span class="variable">$php_upstream</span></span> <span class="string"><span class="string">'unix:${ODP_ROOT}/var/hhvm.sock'</span></span>;           <span class="comment"><span class="comment">#这行去掉注释</span></span>
</code></pre>

<p>Lighttpd配置切换需要修改<code>webserver/conf/lighttpd.conf</code>：</p>

<pre><code class="perl">  <span class="comment"><span class="comment">#proxy-core.backends = ( "unix:${ODP_ROOT}/var/php-cgi.sock" )  #注释掉这行</span></span>
  proxy-core.backends = ( <span class="string"><span class="string">"unix:<span class="subst"><span class="subst">${ODP_ROOT}</span></span>/var/hhvm.sock"</span></span> )          <span class="comment"><span class="comment">#这行去掉注释</span></span>
</code></pre>

            </div>
                <div class="bs-docs-section">
              <div class="page-header">
          <h1 id="老版本ODP安装">老版本 ODP 安装
            <a class="btn btn-edit btn-primary pull-right">
              <span class="glyphicon glyphicon-edit"></span> 编辑本段
            </a>
          </h1>
        </div>
                <p>一般不建议安装ODP的老版本，但是仍然把安装方法列在下面，供读者参考。</p>

<h3>ODP 2.4.1版本环境安装步骤</h3>

<p>ODP 于 2013-5-14 日发布了 2.4.1（scm 地址见下）。此版本 ODP 安装包最大的特点是提供了 jumbo 工具，并在scm 上搭建了 ODP 环境组件库的软件源，与之前版本 ODP 安装包的安装过程完全不同，此教程针对这一版本安装包介绍安装过程。</p>

<p>在任意目录下执行如下 scp 命令，将获得 ODP 集成安装包 <code>odp_2-4-1.tar.gz</code>（最新的安装包版本，请到ODP之窗查看）。</p>

<p>此例子中用的版本号随 ODP 的升级同步更新。</p>

<pre><code class="ruby"><span class="variable"><span class="variable">$ </span></span>wget <span class="symbol"><span class="symbol">ftp:</span></span>/<span class="regexp"><span class="regexp">/getprod:getprod@product.scm.baidu.com:/data</span></span><span class="regexp"><span class="regexp">/prod-64/inf</span></span><span class="regexp"><span class="regexp">/odp/install</span></span><span class="regexp"><span class="regexp">/basic-env/basic</span></span>-env_2-<span class="number"><span class="number">4</span></span>-<span class="number"><span class="number">1_</span></span>BL/output/odp_2-<span class="number"><span class="number">4</span></span>-<span class="number"><span class="number">1</span></span>.tar.gz
<span class="variable"><span class="variable">$ </span></span>tar zxf odp_2-<span class="number"><span class="number">4</span></span>-<span class="number"><span class="number">1</span></span>.tar.gz
<span class="variable"><span class="variable">$ </span></span>cd install_odp
</code></pre>

<p>进入到 install_odp 目录之后便可使用 <code>install_odp.sh</code> 脚本来安装 ODP 环境。以下是 <code>install_odp.sh</code> 脚本支持的参数。</p>

<pre><code class="diff"><span class="deletion"><span class="deletion">-h 可查看安装脚本支持对参数设置；</span></span>
<span class="deletion"><span class="deletion">-v 命令查看安装包版本</span></span>
<span class="deletion"><span class="deletion">-d 参数用于指定ODP环境的完整路径</span></span>
<span class="deletion"><span class="deletion">-s 参数用于指定所需的webserver（lighttpd/nginx）</span></span>
<span class="deletion"><span class="deletion">-t 参数用于指定安装线上（online）还是线下（develop）版本的ODP环境</span></span>
</code></pre>

<blockquote class="bs-callout bs-callout-warning">
  <h4>注意</h4>
  
  <ol>
  <li>线上版本的ODP环境将不会安装以下组件：<code>app-cg</code> <code>pcheck</code> <code>phptest</code> <code>xdebug</code> <code>xhprof</code> <code>PhpDocumentor</code> <code>PHPUnit</code> <code>XML_Beautifier</code> <code>XML_Parser</code>；</li>
  <li>线上环境不建议安装 develop 版，因为 develop 版的 xdebug 扩展，会降低 PHP 运行速度好多倍。</li>
  </ol>
</blockquote>

<p>示例安装命令如下</p>

<pre><code class="ruby"><span class="variable"><span class="variable">$ </span></span>.<span class="regexp"><span class="regexp">/install_odp.sh -d=/home</span></span><span class="regexp"><span class="regexp">/chenyijie/odp</span></span> -s=nginx -t=develop
<span class="variable"><span class="variable">$ </span></span>.<span class="regexp"><span class="regexp">/install_odp.sh -d=/home</span></span><span class="regexp"><span class="regexp">/chenyijie/odp</span></span> -s=lighttpd -t=develop
<span class="variable"><span class="variable">$ </span></span>.<span class="regexp"><span class="regexp">/install_odp.sh -d=/home</span></span><span class="regexp"><span class="regexp">/chenyijie/odp</span></span> -s=nginx -t=online
<span class="variable"><span class="variable">$ </span></span>.<span class="regexp"><span class="regexp">/install_odp.sh -d=/home</span></span><span class="regexp"><span class="regexp">/chenyijie/odp</span></span> -s=lighttpd -t=online
</code></pre>

<blockquote class="bs-callout bs-callout-warning">
  <h4>注意</h4>
  
  <p>安装包默认将所安装的webserver监听端口设置为8080，安装完成后需要用户自行配置。可以设置的端口范围为8000-9000，如果安装时设置的端口号超出了这个范围（比如9362），将导致安装的ODP环境不可用的情况（这是由于公司对测试机端口所作的限制）</p>
  
  <p>lighttpd 请修改 <code>{ODP_ROOT}/webserver/conf/lighttpd.conf</code></p>
  
  <p>nginx 请修改 <code>{ODP_ROOT}/webserver/conf/vhost/php.conf</code></p>
</blockquote>

<p>在确保安装过程正确执行之后，便会在第三步指定的安装路径下面产生 ODP 环境目录。比如示例的设置便会在 <code>/home/chenyijie/</code> 路径下产生 odp 目录。接下来，我们进入到这个目录试着启动 lighttpd 服务器与 PHP 解析器。</p>

<pre><code class="ruby"><span class="variable"><span class="variable">$ </span></span>cd [<span class="constant"><span class="constant">ODP</span></span>安装目录]
<span class="variable"><span class="variable">$ </span></span>php/sbin/php-fpm start
<span class="variable"><span class="variable">$ </span></span>webserver/bin/lighttpd.sh start
<span class="variable"><span class="variable">$ </span></span>webserver/loadnginx.sh start
</code></pre>

<h3>ODP 2.3.0版本环境安装步骤</h3>

<p>ODP于2012-12-07日发布了最新的大版本2.3.0，安装包版本为2.3.0（scm地址见下），此版本ODP安装包最大的特点是提供了LIGHTTPD与NGINX两个安装套餐供用户选择，与之前版本ODP安装包的安装过程设置略有不同，此教程针对这一版本安装包介绍安装过程</p>

<ol>
<li>下载安装包</li>
</ol>

<p>在任意目录下执行如下scp命令，将获得ODP集成安装包basic-env_2-3-0_BL（最新的安装包版本，请到ODP之窗查看）。此例子中用的版本号随ODP的升级同步更新，最后的“.”不要忘了copy，表示scp到当前目录下。密码：getprod</p>

<pre><code class="css">$ <span class="tag"><span class="tag">scp</span></span> -<span class="tag"><span class="tag">r</span></span> <span class="tag"><span class="tag">getprod</span></span><span class="at_rule"><span class="at_rule">@product.scm.baidu.com:/data/prod-<span class="number"><span class="number">64</span></span>/inf/odp/install/basic-env/basic-env_2-<span class="number"><span class="number">3</span></span>-<span class="number"><span class="number">0</span></span>_BL ./
</span></span></code></pre>

<ol>
<li>设置安装路径等少量配置</li>
</ol>

<p>进入到安装包中的output目录，使用vi编辑器打开makefile.conf安装配置文件。</p>

<pre><code class="ruby"><span class="variable"><span class="variable">$ </span></span>cd basic-env_2-<span class="number"><span class="number">3</span></span>-<span class="number"><span class="number">0_</span></span>BL/output/ <span class="variable"><span class="variable">$ </span></span>vi makefile.conf
</code></pre>

<p>只需修改makefile.conf配置文件中的几个选项便可完成安装配置</p>

<pre><code class="cpp"><span class="keyword"><span class="keyword">export</span></span> PREFIX = /home/chenyijie/odp <span class="preprocessor"><span class="preprocessor">#设置ODP的安装目录</span></span>
<span class="keyword"><span class="keyword">export</span></span> INSTALL_PACKAGE = LIGHTTPD   <span class="preprocessor"><span class="preprocessor">#也可填 NGINX 设置ODP的安装套餐 除了WEBSERVER以外所有其他组件两个套餐保持一致</span></span>
<span class="keyword"><span class="keyword">export</span></span> ODP_WEBSERVER_PORT = <span class="number"><span class="number">8189</span></span>    <span class="preprocessor"><span class="preprocessor">#设置ODP中lighttpd/nginx服务器启动后使用的端口号</span></span>
<span class="keyword"><span class="keyword">export</span></span> IS_DEV=<span class="number"><span class="number">0</span></span>             <span class="preprocessor"><span class="preprocessor">#设置ODP安装环境：1表示为开发环境 ，0表示为线上等非开发环境</span></span>
</code></pre>

<ol>
<li><p>执行安装程序</p>

<p>$ make install v=2.3.0</p></li>
</ol>

<p>安装过程中如出现问题请到如下的URL地址查询：</p>

<p><a href="http://odp.baidu.com/odpwindow/Index/getFaqList?faqTypeId=5&amp;pageId=1">http://odp.baidu.com/odpwindow/Index/getFaqList?faqTypeId=5&amp;pageId=1</a></p>

<p>安装如果失败则需要在 output 目录下执行 <code>make clean</code> 命令，调整好以后再在此目录执行 <code>make install</code> 命令安装，否则安装会一直失败。</p>

<ol>
<li>测试安装结果</li>
</ol>

<p>首先，要先确认make install安装过程是否顺利执行，留意make install执行后输出的文字提示信息，由于ODP的扩展安装需要依赖一些第三方的库，因此，在不具有这些第三方库的机器上安装ODP环境的话，会导致安装失败。安装成功会出现提示。</p>

<p>在确保安装过程正确执行之后，便会在第三步指定的安装路径下面产生ODP环境目录。比如示例的设置便会在/home/chenyijie/路径下产生odp目录。接下来，我们进入到这个目录试着启动lighttpd服务器与PHP解析器。</p>

<pre><code class="ruby"><span class="variable"><span class="variable">$ </span></span>cd [<span class="constant"><span class="constant">ODP</span></span>安装目录]
<span class="variable"><span class="variable">$ </span></span>php/sbin/php-fpm start
<span class="variable"><span class="variable">$ </span></span>webserver/bin/lighttpd.sh start
</code></pre>

<p>现在，我们可以执行一些命令，来验证ODP的安装，比如：</p>

<pre><code class="ruby"><span class="variable"><span class="variable">$ </span></span>php/bin/ocm list              <span class="comment"><span class="comment"># 列出已安装的ODP组件</span></span>
<span class="variable"><span class="variable">$ </span></span>php/bin/ocm info smarty       <span class="comment"><span class="comment"># 查看smarty组件的信息，注意输出是utf-8编码</span></span>
<span class="variable"><span class="variable">$ </span></span>php/bin/ocm list-files smarty <span class="comment"><span class="comment"># 列出smarty组件已安装的文件</span></span>
</code></pre>

<p>在 ODP 2.3.0 环境下，<code>ocm list</code> 命令的运行结果如下。</p>

<pre><code class="perl">ak                      <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">26.0</span></span>
ap                      <span class="number"><span class="number">1.1</span></span>.<span class="number"><span class="number">2.5</span></span>
app-cg                  <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">2.0</span></span>
autoloader              <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">2.0</span></span>
conf                    <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">4.0</span></span>
<span class="keyword"><span class="keyword">crypt</span></span>                   <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">2.0</span></span>
db                      <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">8.1</span></span>
i18n                    <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">4.0</span></span>
init                    <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">5.1</span></span>
layerproxy              <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">1.1</span></span>
(lighttpd               <span class="number"><span class="number">1.5</span></span>.<span class="number"><span class="number">0</span></span>.<span class="number"><span class="number">1600</span></span>)
<span class="keyword"><span class="keyword">log</span></span>                     <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">6.1</span></span>
(nginx                  <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">7.0</span></span>)
ocm                     <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">2.2</span></span>
omp                     <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">5.0</span></span>
passport                <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">6.1</span></span>
pcheck                  <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">1.3</span></span>
php                     <span class="number"><span class="number">5.2</span></span>.<span class="number"><span class="number">17</span></span>
phpcas                  <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">2.6</span></span>
phptest                 <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">2.0</span></span>
pic                     <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">4.0</span></span>
profiler                <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">3.0</span></span>
ral                     <span class="number"><span class="number">1.1</span></span>.<span class="number"><span class="number">9.2</span></span>
ralrpc                  <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">2.0</span></span>
saf                     <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">10.3</span></span>
smarty                  <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">2.0</span></span>
string                  <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">2.0</span></span>
timer                   <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">1.0</span></span>
util                    <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">1.0</span></span>
uuap                    <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">2.2</span></span>
</code></pre>

<h3>2.2 版本安装步骤</h3>

<p>ODP 于 2012-10-23 日发布的大版本 2.2.2，安装包版本仍为 2.2.1（scm地址：getprod@product.scm.baidu.com:/data/prod-64/inf/odp/install/basic-env/basic-env_2-2-1-0_PD_BL）,安装中执行 <code>make install v=2.2.2</code> ,此教程以这个版本的 ODP 环境安装为例，2.2.1 以及 2.2.0 环境的安装参考教程中的说明，替换相应的安装包下载地址以及 <code>make install v=x.x.x</code> 命令中的v参数来安装，具体过程三个版本安装包均一致无变化。</p>

<p>ODP 于 2012-09-29 日发布的大版本 2.2.1，安装包版本为 2.2.1（scm地址：getprod@product.scm.baidu.com:/data/prod-64/inf/odp/install/basic-env/basic-env_2-2-1-0_PD_BL）,安装中执行 <code>make install v=2.2.1</code>
（2.2.1版本安装包安装的ODP环境中SAF与profiler组件存在缺陷，请直接安装更新版本的ODP环境来解决）</p>

<p>ODP 于 2012-09-07 日发布的大版本 2.2.0，安装包版本为 2.2.0（scm地址：getprod@product.scm.baidu.com:/data/prod-64/inf/odp/install/basic-env/basic-env_2-2-0_BL）,安装中执行 <code>make install v=2.2.0</code></p>

<ol>
<li>下载安装包</li>
</ol>

<p>在任意目录下执行如下scp命令，将获得ODP集成安装包basic-env_2-3-0_BL（最新的安装包版本，请到ODP之窗查看）。</p>

<pre><code class="python">$ <span class="comment"><span class="comment"># 此例子中用的版本号随ODP的升级同步更新，最后的“.”不要忘了copy，表示scp到当前目录下</span></span>
$ scp -r getprod<span class="decorator"><span class="decorator">@product.scm.baidu.com:/data/prod-64/inf/odp/install/basic-env/basic-env_2-2-1-1_PD_BL ./</span></span>
$ <span class="comment"><span class="comment"># 密码：getprod</span></span>
</code></pre>

<ol>
<li>设置安装路径等少量配置</li>
</ol>

<p>进入到安装包中的output目录，使用vi编辑器打开makefile.conf安装配置文件。</p>

<pre><code class="ruby"><span class="variable"><span class="variable">$ </span></span>cd basic-env_2-<span class="number"><span class="number">2</span></span>-<span class="number"><span class="number">1</span></span>-<span class="number"><span class="number">1_</span></span>PD_BL/output/
<span class="variable"><span class="variable">$ </span></span>vi makefile.conf
</code></pre>

<p>只需修改makefile.conf配置文件中的几个选项便可完成安装配置</p>

<pre><code class="cpp"><span class="keyword"><span class="keyword">export</span></span> PREFIX = /home/chenyijie/odp <span class="preprocessor"><span class="preprocessor">#设置ODP的安装目录</span></span>
<span class="keyword"><span class="keyword">export</span></span> ODP_LIGHTTPD_PORT = <span class="number"><span class="number">8189</span></span> <span class="preprocessor"><span class="preprocessor">#设置ODP中lighttpd服务器启动后使用的端口号</span></span>
<span class="keyword"><span class="keyword">export</span></span> IS_DEV=<span class="number"><span class="number">0</span></span> <span class="preprocessor"><span class="preprocessor">#设置ODP安装环境：1表示为开发环境 ，0表示为线上等非开发环境</span></span>
</code></pre>

<ol>
<li><p>执行安装程序</p>

<p>$ make install v=2.2.2</p></li>
<li><p>测试安装结果</p></li>
</ol>

<p>首先，要先确认make install安装过程是否顺利执行，留意make install执行后输出的文字提示信息，由于ODP的扩展安装需要依赖一些第三方的库，因此，在不具有这些第三方库的机器上安装ODP环境的话，会导致安装失败。安装成功会出现提示。</p>

<p>在确保安装过程正确执行之后，便会在第三步指定的安装路径下面产生ODP环境目录。比如示例的设置便会在/home/chenyijie/路径下产生odp目录。接下来，我们进入到这个目录试着启动lighttpd服务器与PHP解析器。</p>

<pre><code class="ruby"><span class="variable"><span class="variable">$ </span></span>cd [<span class="constant"><span class="constant">ODP</span></span>安装目录]
<span class="variable"><span class="variable">$ </span></span>php/sbin/php-fpm start
<span class="variable"><span class="variable">$ </span></span>webserver/bin/lighttpd.sh start
</code></pre>

<p>现在，我们可以执行一些命令，来验证ODP的安装，比如：</p>

<pre><code class="ruby"><span class="variable"><span class="variable">$ </span></span>php/bin/ocm list              <span class="comment"><span class="comment"># 列出已安装的ODP组件</span></span>
<span class="variable"><span class="variable">$ </span></span>php/bin/ocm info smarty       <span class="comment"><span class="comment"># 查看smarty组件的信息，注意输出是utf-8编码</span></span>
<span class="variable"><span class="variable">$ </span></span>php/bin/ocm list-files smarty <span class="comment"><span class="comment"># 列出smarty组件已安装的文件</span></span>
</code></pre>

<p>安装过程中如出现问题请到如下的URL地址查询：</p>

<p><a href="http://odp.baidu.com/odpwindow/Index/getFaqList?faqTypeId=5&amp;pageId=1">http://odp.baidu.com/odpwindow/Index/getFaqList?faqTypeId=5&amp;pageId=1</a></p>

<p>安装如果失败则需要在output目录下执行make clean命令，调整好以后再在此目录执行make install命令安装，否则安装会一直失败</p>

<h3>ODP 2.0环境 及1.0.1版本安装步骤</h3>

<ol>
<li>下载安装包</li>
</ol>

<p>在任意目录下执行如下scp命令，将获得ODP集成安装包basic-env_1-0-1_BL（最新的安装包版本，请到ODP之窗查看）。</p>

<pre><code class="ruby"><span class="variable"><span class="variable">$ </span></span><span class="comment"><span class="comment"># 最后的“.”不要忘了copy，表示scp到当前目录下</span></span>
<span class="variable"><span class="variable">$ </span></span>scp -r getprod<span class="variable"><span class="variable">@product</span></span>.scm.baidu.<span class="symbol"><span class="symbol">com:</span></span>/data/prod-<span class="number"><span class="number">64</span></span>/inf/odp/install/basic-env/basic-env_1-<span class="number"><span class="number">0</span></span>-<span class="number"><span class="number">1_</span></span>BL .
<span class="variable"><span class="variable">$ </span></span><span class="comment"><span class="comment"># 密码：getprod</span></span>
</code></pre>

<ol>
<li>设置安装路径等少量配置</li>
</ol>

<p>进入到安装包中的output目录，使用vi编辑器打开makefile.conf安装配置文件。</p>

<pre><code class="ruby"><span class="variable"><span class="variable">$ </span></span>cd basic-env_1-<span class="number"><span class="number">0</span></span>-<span class="number"><span class="number">1_</span></span>BL/output/
<span class="variable"><span class="variable">$ </span></span>vi makefile.conf
</code></pre>

<p>只需修改makefile.conf配置文件中的几个选项便可完成安装配置</p>

<pre><code class="cpp"><span class="keyword"><span class="keyword">export</span></span> PREFIX = /home/chenyijie/odp <span class="preprocessor"><span class="preprocessor">#设置ODP的安装目录</span></span>

<span class="keyword"><span class="keyword">export</span></span> ODP_LIGHTTPD_PORT = <span class="number"><span class="number">8189</span></span> <span class="preprocessor"><span class="preprocessor">#设置ODP中lighttpd服务器启动后使用的端口号</span></span>

<span class="keyword"><span class="keyword">export</span></span> IS_DEV=<span class="number"><span class="number">0</span></span> <span class="preprocessor"><span class="preprocessor">#设置ODP安装环境：1表示为开发环境 ，0表示为线上等非开发环境</span></span>
</code></pre>

<ol>
<li><p>执行安装程序</p>

<p>$ make install</p></li>
<li><p>测试安装结果</p></li>
</ol>

<p>首先，要先确认make install安装过程是否顺利执行，留意make install执行后输出的文字提示信息，由于ODP的扩展安装需要依赖一些第三方的库，因此，在不具有这些第三方库的机器上安装ODP环境的话，会导致安装失败。安装成功会出现如下图的提示：</p>

<pre><code class="perl"><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span>*
<span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span>*
[IMPORTANT]INTALL SUCCESS, NOW TO REMOVE TMP DIRS...
<span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span><span class="variable"><span class="variable">**</span></span>*
</code></pre>

<p>在确保安装过程正确执行之后，便会在第三步指定的安装路径下面产生ODP环境目录。比如示例的设置便会在/home/chenyijie/路径下产生odp目录。接下来，我们进入到这个目录试着启动lighttpd服务器与PHP解析器。</p>

<pre><code class="ruby"><span class="variable"><span class="variable">$ </span></span>cd [<span class="constant"><span class="constant">ODP</span></span>安装目录]
<span class="variable"><span class="variable">$ </span></span>php/sbin/php-fpm start
<span class="variable"><span class="variable">$ </span></span>webserver/bin/lighttpd.sh start
</code></pre>

<p>现在，我们可以执行一些命令，来验证ODP的安装，比如：</p>

<pre><code class="ruby"><span class="variable"><span class="variable">$ </span></span>php/bin/ocm list              <span class="comment"><span class="comment"># 列出已安装的ODP组件</span></span>
<span class="variable"><span class="variable">$ </span></span>php/bin/ocm info smarty       <span class="comment"><span class="comment"># 查看smarty组件的信息，注意输出是utf-8编码</span></span>
<span class="variable"><span class="variable">$ </span></span>php/bin/ocm list-files smarty <span class="comment"><span class="comment"># 列出smarty组件已安装的文件</span></span>
</code></pre>

<p>安装过程中如出现问题请到如下的URL地址查询：</p>

<p><a href="http://odp.baidu.com/odpwindow/Index/getFaqList?faqTypeId=5&amp;pageId=1">http://odp.baidu.com/odpwindow/Index/getFaqList?faqTypeId=5&amp;pageId=1</a></p>

<p>安装如果失败则需要在output目录下执行make cleanall命令，调整好以后再在此目录执行make install命令安装，否则安装会一直失败</p>

            </div>
                <div class="bs-docs-section">
              <div class="page-header">
          <h1 id="ODP文件环境介绍">ODP 文件环境介绍
            <a class="btn btn-edit btn-primary pull-right">
              <span class="glyphicon glyphicon-edit"></span> 编辑本段
            </a>
          </h1>
        </div>
                <p>经过以上四个简单的步骤，我们已经在机器上安装了 ODP 的环境，但是 ODP 环境都包含了那些内容呢？下面让我们来一探究竟。首先让我们进入到 odp 的安装目录中，例如上例中的 <code>/home/chenyijie/odp</code> 文件夹：</p>

<pre><code class="ruby">[chenyijie<span class="variable"><span class="variable">@cq01</span></span>-ksarch-rdtest0<span class="number"><span class="number">0</span></span>.vm odp] <span class="variable"><span class="variable">$ </span></span>pwd
/home/chenyijie/odp
[chenyijie<span class="variable"><span class="variable">@cq01</span></span>-ksarch-rdtest0<span class="number"><span class="number">0</span></span>.vm odp] <span class="variable"><span class="variable">$ </span></span>ls
app conf data install log php template webroot webserver
</code></pre>

<p>可以看到odp目录中包含了app等9个目录，下面我们来一一介绍。</p>

<h3>app</h3>

<p>app目录在ODP环境安装好之后是一个空目录，此目录为应用程序目录，用于放置产品线业务（app）代码。</p>

<h3>conf</h3>

<p>conf目录中包含了四个文件夹，十个文件，为配置目录，用于存放组件和app的配置。</p>

<table class="table table-striped table-bordered">
<thead>
<tr>
  <th>名称</th>
  <th>用途简介</th>
</tr>
</thead>
<tbody>
<tr>
  <td>app</td>
  <td>文件夹，用于存放app相关的配置文件</td>
</tr>
<tr>
  <td>db</td>
  <td>文件夹，存放数据库相关的配置文件：cluster.conf global.conf</td>
</tr>
<tr>
  <td>i18n</td>
  <td>文件夹，存放国际化相关的配置文件：feature.conf locale.conf</td>
</tr>
<tr>
  <td>ral</td>
  <td>文件夹，存放RAL（资源访问层）相关的配置文件，内容较复杂，见后续章节介绍</td>
</tr>
<tr>
  <td>idc.conf</td>
  <td>Conf组件的分机房配置与RAL组件的配置相关</td>
</tr>
<tr>
  <td>init.conf</td>
  <td>init组件的配置文件</td>
</tr>
<tr>
  <td>log.conf</td>
  <td>配置log目录下的日志如何打印的配置文件</td>
</tr>
<tr>
  <td>saf.conf</td>
  <td>SAF框架的配置文件</td>
</tr>
<tr>
  <td>smarty.conf</td>
  <td>Smarty模板的配置文件</td>
</tr>
<tr>
  <td>passport.conf</td>
  <td>Passport服务的配置文件</td>
</tr>
<tr>
  <td>pcheck.conf</td>
  <td>pcheck静态代码检查工具的配置文件</td>
</tr>
<tr>
  <td>phptest.conf</td>
  <td>phptest单元测试框架组件的配置文件</td>
</tr>
<tr>
  <td>layerproxy.conf</td>
  <td>layerproxy组件的配置文件</td>
</tr>
</tbody>
</table>

<h3>data目录</h3>

<p>data目录中共含有6个文件夹(ak,app,phpca,phptest,smarty,string)，为本地数据目录，用于放置组件和app生成的本机数据、缓存等。</p>

<h3>install目录</h3>

<p>install目录为ODP组件安装信息存储目录，ocm命令读取的即为该目录中的信息。</p>

<h3>log目录</h3>

<p>log目录中存放整个ODP环境运行中产生的日志文件，包括webserver日志、php日志、以及与ODP app相关的access、waring、failed日志。这个目录与我们调试、错误定位检测、监控等操作息息相关，学会查看此目录下的对应文件是使用ODP环境的基本技能之一。下表是log目录中可能出现（有些文件只有在程序输出日志时才会被产生，原始安装好的环境中不存在）的日志示例文件：</p>

<table class="table table-striped table-bordered">
<thead>
<tr>
  <th>名称</th>
  <th>用途简介</th>
</tr>
</thead>
<tbody>
<tr>
  <td>access_log.2012061812</td>
  <td>资源访问记录，该文件记录了客户端对服务器的所有请求，以及请求处理的结果状态码，按小时分日志</td>
</tr>
<tr>
  <td>error_log.2012061117</td>
  <td>web访问错误日志，按小时分日志</td>
</tr>
<tr>
  <td>lighttpd.log</td>
  <td>记录lighttpd上次的启动错误信息，成功则清空</td>
</tr>
<tr>
  <td>lighttpd.pid</td>
  <td>lighttpd进程pid记录日志</td>
</tr>
<tr>
  <td>php-error.log</td>
  <td>PHP相关的错误日志</td>
</tr>
<tr>
  <td>php-fpm.log</td>
  <td>php-fpm的日志</td>
</tr>
<tr>
  <td>php-fpm.pid</td>
  <td>php-fpm进程pid记录日志</td>
</tr>
<tr>
  <td>ral.log</td>
  <td>RAL进程的日志文件，查看RAL启动、配置更新加载、资源定位成功失败可查看该日志</td>
</tr>
<tr>
  <td>ral.log.wf</td>
  <td>RAL进程的日志文件，查看RAL启动、配置更新加载、资源定位成功失败可查看该日志</td>
</tr>
<tr>
  <td>ral.pid</td>
  <td>用于保存RAL进程的pid，并用于心跳，不可删除，该文件不存在说明ral进程未启动或已终止，工作进程会重新唤醒ral进程</td>
</tr>
<tr>
  <td>ral-worker.log</td>
  <td>RAL工作进程的配置文件，判读交互成功失败可查看该日志</td>
</tr>
<tr>
  <td>ral-worker.log.wf</td>
  <td>RAL工作进程的配置文件，判读交互成功失败可查看该日志</td>
</tr>
<tr>
  <td>ral-zoo.log</td>
  <td>RAL资源定位日志</td>
</tr>
</tbody>
</table>

<p>注：access_log与error_log文件在默认的情况下都是按照时间（每小时）的顺序来产生的，这个可以通过ODP环境中conf目录下的log.conf文件进行配置。</p>

<p>另外log目录中有一个与app的名字对应的文件夹，这个文件夹用来存放与app相关的日志文件，例如app的名字为newapp，则在这个文件夹下会生成相应的newapp.log.2012******、newapp.log.new.2012******、newapp.log.wf.2012******等文件，这些文件与access_log和error_log文件一样，也是按照时间的顺序来产生的，对应了我们在app的业务实现代码中使用Bd_Log通用库（后面章节会讲到）中的静态函数输出的跟踪调试信息，以及框架反馈的业务运行中产生的警告与错误信息。</p>

<p>对于不属于任何app的php程序，ODP将其作为特殊的unknown-app对待，日志名为unknown-app.log。</p>

<h3>php</h3>

<p>php目录是ODP环境包含的php安装后所在的目录，可以在此目录中查看php安装的扩展、以及对php解析的开启与关闭操作。php目录中包含的phplib目录为公共库目录，存放ODP和产品线的公共库，bin目录为PHP程序目录，存放PHP和ODP的工具程序。</p>

<h3>template</h3>

<p>template目录用于存放php的页面模板，ODP环境支持火麒麟与smarty模板技术，因此template目录下可以存放以.tpl为后缀的文件。</p>

<h3>webroot</h3>

<p>webroot目录为默认的web文档目录，用于存放静态文件，以及每个app的index.php。</p>

<h3>webserver</h3>

<p>webserver目录为webserver的安装目录，当前ODP支持lighttpd以及nginx两种服务器。</p>

            </div>
                <div class="bs-docs-section">
              <div class="page-header">
          <h1 id="APP-CG工具的使用">APP-CG 工具的使用
            <a class="btn btn-edit btn-primary pull-right">
              <span class="glyphicon glyphicon-edit"></span> 编辑本段
            </a>
          </h1>
        </div>
                <h3>&nbsp;Hello World程序</h3>

<p>到目前为止，我们已经在开发机上完成了 ODP 环境的安装，并对 ODP 环境有了一个初步的了解，那么怎样在 ODP 环境中开发 app 呢？</p>

<p>还是让我们以一个经典的 Hello World 示例来开始 ODP 开发的学习之旅吧。</p>

<p>首先我们进入到 odp 的安装目录的 webroot 目录中，使用 vi 新建一个 <code>index.php</code> 的文件，在 <code>index.php</code> 中添加如下 HTML 代码：</p>

<pre><code class="php"><span class="preprocessor"><span class="preprocessor">&lt;?php</span></span> <span class="variable"><span class="variable">$str</span></span> = <span class="string"><span class="string">"&lt;html&gt;
    &lt;title&gt;Hello World!&lt;/title&gt;
    &lt;body&gt;
        &lt;h1&gt;Hello World!&lt;/h1&gt;
    &lt;/body&gt;
&lt;/html&gt;"</span></span>;
<span class="keyword"><span class="keyword">echo</span></span> <span class="variable"><span class="variable">$str</span></span>;
</code></pre>

<p>此时，我们便可以通过浏览器来访问这个刚生成的页面了。在使用浏览器访问之前请确保 ODP 环境的 php 与 lighttpd 已经打开。在浏览器中输入开发机的IP地址及端口便可访问，例如本例中使用 <code>http://10.46.135.25:8189/</code> 这个地址来访问，浏览器里是否出现了如下图所示的无比亲切的字符串呢？</p>

<pre><code class="undefined">Hello World!
</code></pre>

<p>由于 <code>lighttpd.conf</code> 中有如下所示的配置，因此，无需输入访问文件名，默认也会访问 webroot 目录下的 <code>index.php</code> 文件。</p>

<pre><code class="cs"><span class="number"><span class="number">70</span></span> <span class="preprocessor"><span class="preprocessor"># files to check for <span class="keyword"><span class="keyword">if</span></span> .../ is requested</span></span>
<span class="number"><span class="number">71</span></span> index-file.names - ( <span class="string"><span class="string">"index.php"</span></span>, <span class="string"><span class="string">"index.html"</span></span>,
<span class="number"><span class="number">72</span></span>                      <span class="string"><span class="string">"index.htm"</span></span>, <span class="string"><span class="string">"default.htm"</span></span> , <span class="string"><span class="string">"index.wml"</span></span>)
</code></pre>

<p>可以将 <code>index.php</code> 文件改名为 <code>helloWorld.php</code>，修改lighttpd.conf，注释掉lighttpd serurity选项，重启lighttpd，这样就可以通过 <code>http://10.46.135.25:8189/helloWorld.php</code> 这个路径来访问 <code>helloWorld.php</code> 文件了。现在我们已经使用了 ODP 提供的 php+lighttpd 环境，但是怎样使用 ODP 提供的 AP、SAF 框架以及基础库提供的强大功能来开发 Web 应用呢？下面，我们使用 AP 框架来重新实现 Hello World 示例。</p>

<h3>用app-cg生成规范代码框架</h3>

<p>ODP 提供了一个 app-cg 的工具，app-cg 是一个基于 ap 框架的代码生成工具，生成的 APP 代码框架符合《ODP APP规范》，因此，我们可以通过使用app-cg 工具来帮助我们快速搭建开发环境，生成使用AP框架的已经分好层次的基础代码。</p>

<p>app-cg 工具安装于 <code>ODP_ROOT_PATH/php/phplib/app-cg</code> 目录中，例如第一章中的安装路径则对应为：<code>/home/chenyijie/odp/php/phplib/app-cg</code>。进入到此目录中，可以看到 <code>conf.php</code> 文件，这便是 app-cg 工具的配置文件，使用 vi 编辑器打开可以看到如下图所示的代码：</p>

<pre><code class="php"><span class="preprocessor"><span class="preprocessor">&lt;?php</span></span>
<span class="comment"><span class="comment">/**
 *<span class="phpdoc"><span class="phpdoc"> @name</span></span> conf.php
 *<span class="phpdoc"><span class="phpdoc"> @desc</span></span> app-cg的配置文件
 *<span class="phpdoc"><span class="phpdoc"> @author</span></span> 何威(he_wei@baidu.com)
 */</span></span>
<span class="variable"><span class="variable">$conf</span></span>- <span class="keyword"><span class="keyword">array</span></span>
(
    <span class="string"><span class="string">'AUTHOR'</span></span> -&gt; <span class="string"><span class="string">'何威(he_wei@baidu.com)'</span></span>,<span class="comment"><span class="comment">//开发人员</span></span>
    <span class="string"><span class="string">'PRODUCT_NAME'</span></span> -&gt; <span class="string"><span class="string">'newpro'</span></span>,<span class="comment"><span class="comment">//产品线名字, 不要包含下划线'_',请确保这也是一个合法的文件夹名</span></span>
    <span class="string"><span class="string">'APP_NAME'</span></span> -&gt; <span class="string"><span class="string">'newapp'</span></span>,<span class="comment"><span class="comment">//app名字,不要包含下划线'_',请确保这也是一个合法的文件夹名</span></span>
    <span class="string"><span class="string">'DEV_PC'</span></span> -&gt; <span class="string"><span class="string">'chenyijie@cq01-ksarch-rdtest00.vm'</span></span>,<span class="comment"><span class="comment">//开发机,用于生成makefile自动部署</span></span>
    <span class="string"><span class="string">'ROOT_PATH'</span></span> -&gt; <span class="string"><span class="string">'/home/chenyijie/odp'</span></span>,<span class="comment"><span class="comment">//部署根目录</span></span>
);
<span class="preprocessor"><span class="preprocessor">?&gt;</span></span>
</code></pre>

<p>下表是对各个参数设置的说明：</p>

<table class="table table-striped table-bordered">
<thead>
<tr>
  <th>参数</th>
  <th>示例值</th>
  <th>说明</th>
</tr>
</thead>
<tbody>
<tr>
  <td>AUTHOR</td>
  <td>何威(he_wei@baidu.com)</td>
  <td>开发人员，所设值会显示在app-cg产生的每个.php文件的头部注释@author字段后面</td>
</tr>
<tr>
  <td>PRODUCT_NAME</td>
  <td>newpro</td>
  <td>产品线名字,不要包含下划线，请确保这也是一个合法的文件夹名，app-cg会以产品线的名字来命名部署到ODP环境php/phplib/目录下的库文件根目录的名字</td>
</tr>
<tr>
  <td>APP_NAME</td>
  <td>newapp</td>
  <td>app名字，不要包含下划线，请确保这也是一个合法的文件夹名，一个产品中可以包含多个app，app可以理解为产品的一个模块。</td>
</tr>
<tr>
  <td>DEV_PC</td>
  <td>cq01-ksarch-rdtest00.vm</td>
  <td>部署ODP环境的机器名，用于生产makefile自动部署文件，指定部署的机器</td>
</tr>
<tr>
  <td>ROOT_PATH</td>
  <td>/home/chenyijie/odp</td>
  <td>指定文件在部署机器上的部署根目录，makefile会自动把PRODUCT_NAME指定的文件夹copy到DEV_PC指定的机器上的ROOT_PATH指定的目录下，当然ROOT_PATH指定的目录应该是在ODP环境中的目录</td>
</tr>
</tbody>
</table>

<p>接下来就可以运行run.php文件来产生示例代码了。</p>

<pre><code class="ruby">[chenyijie<span class="variable"><span class="variable">@cq01</span></span>-ksarch-rdtest0<span class="number"><span class="number">0</span></span>.vm app-cg] <span class="variable"><span class="variable">$ </span></span>~<span class="regexp"><span class="regexp">/odp/php</span></span><span class="regexp"><span class="regexp">/bin/php</span></span> run.php
<span class="constant"><span class="constant">DONE</span></span>
</code></pre>

<p>这里需要使用 php 命令来运行 <code>run.php</code> 脚本，注意需要制定 <code>php</code> 命令的路径，当出现“DONE”的时候，app-cg 就已经帮我们在 out 目录中生成了一个以 APP_NAME 指定的内容命名的文件夹。</p>

<pre><code class="ruby">[chenyijie<span class="variable"><span class="variable">@cq01</span></span>-ksarch-rdtest0<span class="number"><span class="number">0</span></span>.vm app-cg] <span class="variable"><span class="variable">$ </span></span>ls
newapp
</code></pre>

<p>newapp文件夹中的内容与结构如下图所示：</p>

<pre><code class="php">newapp          <span class="comment"><span class="comment">// 应用名称</span></span>
+--action       <span class="comment"><span class="comment">// 动作类目录</span></span>
|  +--api       <span class="comment"><span class="comment">// 子系统交互api目录</span></span>
|  |  --Sample.php  <span class="comment"><span class="comment">// 示例api服务端action</span></span>
|  --Sample.php <span class="comment"><span class="comment">// 示例普通action</span></span>
+--api          <span class="comment"><span class="comment">// saf api接口和服务类</span></span>
|  --<span class="keyword"><span class="keyword">Interface</span></span>.php  <span class="comment"><span class="comment">// 接口类</span></span>
|  --Service.php    <span class="comment"><span class="comment">// 实现类</span></span>
+--conf         <span class="comment"><span class="comment">// 配置目录</span></span>
|  +--newapp        <span class="comment"><span class="comment">// 配置目录，配置文件可以拆分</span></span>
|     --<span class="keyword"><span class="keyword">global</span></span>.conf <span class="comment"><span class="comment">// app全局配置文件</span></span>
|     --log.conf    <span class="comment"><span class="comment">// log示例配置文件</span></span>
+--controllers      <span class="comment"><span class="comment">// 控制类目录</span></span>
|  --Main.php       <span class="comment"><span class="comment">// 主控制类</span></span>
|  --Api.php        <span class="comment"><span class="comment">// api控制类</span></span>
+--doc          <span class="comment"><span class="comment">// 文档目录</span></span>
+--library      <span class="comment"><span class="comment">// 本地类根目录</span></span>
|  +--newapp        <span class="comment"><span class="comment">// app本地类目录</span></span>
|     --Util.php    <span class="comment"><span class="comment">// 示例本地类</span></span>
+--models       <span class="comment"><span class="comment">// 数据目录</span></span>
|  +--dao       <span class="comment"><span class="comment">// 数据获取目录</span></span>
|  |  --Sample.php  <span class="comment"><span class="comment">// 示例</span></span>
|  +--service       <span class="comment"><span class="comment">// 页面数据服务目录</span></span>
|     +--data       <span class="comment"><span class="comment">// 主题数据服务目录</span></span>
|     |  --Sample.php   <span class="comment"><span class="comment">// 示例</span></span>
|     +--page       <span class="comment"><span class="comment">// 页面数据服务目录</span></span>
|        --Sample.php   <span class="comment"><span class="comment">// 示例</span></span>
|        --SampleApi.php <span class="comment"><span class="comment">// api示例</span></span>
+--script       <span class="comment"><span class="comment">// 脚本目录</span></span>
|  --sampleScript.php   <span class="comment"><span class="comment">// 示例脚本</span></span>
+--test         <span class="comment"><span class="comment">// 测试目录</span></span>
+--Bootstrap.php    <span class="comment"><span class="comment">// ap框架的引导文件</span></span>
+--build.sh     <span class="comment"><span class="comment">// 打包脚本</span></span>
+--index.php        <span class="comment"><span class="comment">// 入口文件</span></span>
+--Makefile     <span class="comment"><span class="comment">// 自动部署脚本</span></span>
--readme.txt        <span class="comment"><span class="comment">// readme文件，告诉你如何部署和运行</span></span>
</code></pre>

<h3>部署代码到ODP环境</h3>

<p>下面，让我们看一下 <code>readme.txt</code> 文件，这里的内容将提示我们将 app-cg 生成的内容部署到 ODP 环境中。</p>

<pre><code class="java">可以按照以下步骤来部署和运行程序:
<span class="number"><span class="number">1.</span></span>请确保机器路径<span class="keyword"><span class="keyword">super</span></span><span class="annotation"><span class="annotation">@dbl</span></span>-space-test02.vm:/home/work已经安装了odp标准环境，请参考:http:<span class="comment"><span class="comment">//odp.bae.baidu.com</span></span>
<span class="number"><span class="number">2.</span></span>在当前目录执行shell命令make dev_pc;
<span class="number"><span class="number">3.</span></span>在webserver加入rewrite rule,将http:<span class="comment"><span class="comment">//yourhost/newapp为前缀的所有请求，路由到/home/work/webroot/newapp/index.php文件;</span></span>
<span class="number"><span class="number">4.</span></span>重启webserver;
<span class="number"><span class="number">5.</span></span>访问http:<span class="comment"><span class="comment">//yourhost/newapp/sample?id=1,出现GoodBye World!, 表示运行成功,否则请查看php错误日志;</span></span>
</code></pre>

<p>按照提示，我们在当前目录（/home/chenyijie/odp/php/phplib/app-cg/out/newapp）下执行 <code>make dev_pc</code> 命令，自动部署脚本便会将 newapp 文件夹拷贝到 DEV_PC 指定机器的 ROOT_PATH 目录中对应的目录中。脚本执行的过程中会提示你输入 DEV_PC 指定机器的登录密码。</p>

<p>这里如果不想重复输入密码的话，可以为机器之间添加信任关系，如果 DEV_PC 指定的是本机的话，则可以将 <code>~/.ssh/</code> 目录中 <code>id_rsa.pub</code> 中的内容添加到 <code>authorized_keys</code> 文件中，关于如何为机器之间添加信任关系，网上有很多介绍，在此不再赘述。</p>

<p>make 脚本执行完成后，便可以进入上面提到的机器路径查看 app-cg 产生并部署过去的文件了，这些文件都是放在以 APP_NAME 指定值命名的文件夹中的。比如部署机器 ODP 环境中的 app 目录下便会产生一个本例中指定的 newapp 目录。这些代码的解释在后面的章节进行，现在我们先将 app-cg 产生的代码在ODP环境中运行起来。</p>

<h3>修改webserver rewrite规则</h3>

<p>按照 readme.txt 文件中第三步的提示，我们还需要修改下 app-cg make 脚本部署机器上 ODP 环境中 webserver配置的URL rewrite规则。按照本章中示例的设置，我们进入到 <code>cq01-ksarch-rdtest00.vm</code> 机器上的 <code>/home/chenyijie/odp</code> 目录中。</p>

<h4>lighttpd</h4>

<p>如果webserver是lighttpd，修改 webserver/conf 目录下的 <code>lighttpd.conf</code> 文件。在文件的最后，我们可以看到如下所示的配置：</p>

<pre><code class="perl"><span class="number"><span class="number">382</span></span> url.rewrite-once - (
<span class="number"><span class="number">383</span></span>         <span class="comment"><span class="comment">#静态文件rewrite,遵守fis规范</span></span>
<span class="number"><span class="number">384</span></span>         <span class="string"><span class="string">"^/static/(.<span class="variable"><span class="variable">*)</span></span><span class="variable"><span class="variable">$"</span></span> -&gt; "</span></span>/static/<span class="variable"><span class="variable">$1</span></span><span class="string"><span class="string">",
385         #odp提供了通用的rewrite规则在最下面一行
386         #这个通用rewrite规则用于把/appname/abc?t-1这样的请求rewrite为/appname/index.php?t-1
387         #如果产品线有通用rewrite规则满足不了的需求，请使用下面注释示例单独配一个
388         #请保证通用rewrite规则始终在最后一行
389         #"</span></span>^<span class="regexp"><span class="regexp">/new_app(/</span></span>[^?]<span class="variable"><span class="variable">*)</span></span>?((\?.<span class="variable"><span class="variable">*)</span></span>?)<span class="variable"><span class="variable">$"</span></span> =&gt; <span class="string"><span class="string">"/new_app/index.php<span class="variable"><span class="variable">$1</span></span><span class="variable"><span class="variable">$2</span></span>"</span></span>,
<span class="number"><span class="number">390</span></span>         <span class="string"><span class="string">"^/([^/]<span class="variable"><span class="variable">*)</span></span>(/[^?]<span class="variable"><span class="variable">*)</span></span>?((\?.<span class="variable"><span class="variable">*)</span></span>?)<span class="variable"><span class="variable">$"</span></span> =&gt; "</span></span>/<span class="variable"><span class="variable">$1</span></span>/<span class="keyword"><span class="keyword">index</span></span>.php<span class="variable"><span class="variable">$2</span></span><span class="variable"><span class="variable">$3</span></span><span class="string"><span class="string">",
391 )
</span></span></code></pre>

<p>将上面倒数第二行最前面的#去掉，并在最后加上逗号“,”，修改此句中的 news_app 为 app-cg 的 conf.php 文件中 APP_NAME 指定的名字（本例中是newapp）便可完成第三步的配置操作。这里稍微讲一下rewrite的配置规则，“-&gt;“左侧的每一个括号按照出现的顺序匹配“-&gt;”右侧的<span class="MathJax_Preview"></span><span class="MathJax" id="MathJax-Element-1-Frame" role="textbox" aria-readonly="true"><nobr><span class="math" id="MathJax-Span-1" style="width: 1.61em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.313em; height: 0px; font-size: 120%;"><span style="position: absolute; clip: rect(1.789em 1000em 3.098em -0.473em); top: -2.735em; left: 0.003em;"><span class="mrow" id="MathJax-Span-2"><span class="mn" id="MathJax-Span-3" style="font-family: MathJax_Main;">1</span><span class="texatom" id="MathJax-Span-4"><span class="mrow" id="MathJax-Span-5"><span class="mo" id="MathJax-Span-6"><span style="font-family: STIXGeneral, &quot;Arial Unicode MS&quot;, serif; font-size: 83%; font-style: normal; font-weight: normal;">、</span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.741em;"></span></span></span><span style="border-left: 0.004em solid; display: inline-block; overflow: hidden; width: 0px; height: 1.361em; vertical-align: -0.282em;"></span></span></nobr></span><script type="math/tex" id="MathJax-Element-1">1、</script>2、…，而括号内的配置规则则是基于正则表达式。例如 <code>10.46.135.25:8189/newapp/sample?id=1</code> 这样的 URL 请求便会被第 390 行的 rewrite 规则重新整理为<code>10.46.135.25:8189/newapp/index.php/sample?id=1</code>。</p>

<h4>nginx</h4>

<p>如果webserver是nginx，修改<code>webserver/conf/vhost/php.conf</code>文件，如下所示：</p>

<pre><code class="ruby">location /newapp/ {
    root            /home/work/odp_dingwenchao/webroot;
    index           index.php;
    fastcgi_pass    <span class="symbol"><span class="symbol">unix:</span></span>/home/work/odp_dingwenchao/var/php-cgi.sock;
    <span class="keyword"><span class="keyword">include</span></span>         fastcgi.conf;
    rewrite ^<span class="regexp"><span class="regexp">/newapp(/</span></span>[^\?]*)?((\?.*)?)<span class="variable"><span class="variable">$ </span></span>/newapp/index.php<span class="variable"><span class="variable">$1</span></span><span class="variable"><span class="variable">$2</span></span> <span class="keyword"><span class="keyword">break</span></span>;
}
</code></pre>

<p>把newapp改成你app-cg 时指定的 conf.php 文件中 APP_NAME 即可。</p>

<h3>重启webserver</h3>

<p>由于修改了 webserver 的配置，因此，我们需要重启 webserver 服务器，才能使配置生效。顺利重启 webserver 之后，便可访问部署到开发机上的 app-cg 示例了。结果如下图所示。</p>

<pre><code class="undefined">Goodbye World!
</code></pre>

<p>10.46.135.25是第一章例子中安装 ODP 环境的开发机——cq01-ksarch-rdtest00.vm 的 IP，8189 是安装 ODP 时指定的 lighttpd 服务器端口， <code>/newapp/sample?id=1</code> 这个访问路径和刚才配置的 URL rewrite 规则还有接下来要讲的 AP 框架路由协议有关，到现在为止，我们已经成功的将 app-cg 生成的示例在 ODP 环境中运行了起来，下一章，我们就来详细的讲解 app-cg 产生的示例代码，了解 AP 框架和 SAF 框架的应用。</p>

            </div>
                <div class="bs-docs-section">
              <div class="page-header">
          <h1 id="AP框架">AP 框架
            <a class="btn btn-edit btn-primary pull-right">
              <span class="glyphicon glyphicon-edit"></span> 编辑本段
            </a>
          </h1>
        </div>
                <h3>一、什么是框架</h3>

<p>框架（Framework）是整个或部分系统的可重用设计，表现为一组抽象构件及构件实例间交互的方法；另一种定义认为，框架是可被应用开发者定制的应用骨架。前者是从应用方面而后者是从目的方面给出的定义。</p>

<p>可以说，一个框架是一个可复用的设计构件，它规定了应用的体系结构，阐明了整个设计、协作构件之间的依赖关系、责任分配和控制流程，表现为一组抽象类以及其实例之间协作的方法，它为构件复用提供了上下文(Context)关系。因此构件库的大规模重用也需要框架。</p>

<h3>二、为什么要使用框架</h3>

<p>因为软件系统发展到今天已经很复杂了，特别是服务器端软件，涉及到的知识，内容，问题太多。在某些方面使用别人成熟的框架，就相当于让别人帮你完成一些基础工作，你只需要集中精力完成系统的业务逻辑设计。而且框架一般是成熟、稳健的，他可以处理系统很多细节问题，比如，事务处理，安全性，数据流控制等问题。还有框架一般都经过很多人使用，所以结构很好，所以扩展性也很好，而且它是不断升级的，你可以直接享受别人升级代码带来的好处。</p>

<p>框架一般处在低层应用平台（如J2EE）和高层业务逻辑之间的中间层。</p>

<p>PHP开发框架把PHP Web程序开发摆到了流水线上。换句话说，PHP开发框架有助于促进快速软件开发（RAD），这节约了我们的时间，有助于创建更为稳定的程序，并减少开发者编写重复代码的劳动。这些框架还通过确保正确的数据库操作以及只在表现层编程的方式帮助初学者创建稳定的程序。PHP开发框架使得我们可以花更多的时间去创造真正的Web程序，而不是编写重复性的代码。</p>

<p>PHP开发框架背后的思想被称为“模型—视图—控制器”（MVC）。MVC是这样一种架构模式，它隔离了业务逻辑与UI，允许其一改变而另一者不受影响。（也可以说是关注点的隔离）在MVC中，模型负责数据，视图负责表现，控制器则是程序主体或者说是负责业务逻辑。从本质上说，MVC拆分了一个程序的开发过程，这样我们就可以修改独立的每一部分，而其他部分不受影响，这是十分重要的，它使得编写PHP代码更为快捷简单。</p>

<p>我们可能出于不同的考虑而使用PHP开发框架，不过最主要的原因是为了加速开发过程。相似工程之间的代码重用能够节省大家大量的时间和精力。PHP开发框架内置了预建的模块，免去了冗长又令人厌烦的编程工作。这样我们就能够把时间花在开发实际程序上，而不是每一次都要为每一个项目重建基础模块。</p>

<p>稳定性是是我们使用框架的另一个重要原因。尽管简单是PHP最大的资本，也是许多人喜爱这个脚本语言的原因，它也是PHP的“潘多拉之盒”，尤其是对初学者而言，PHP是如此的简单以至于他们会完全没有意识地写出低质量的代码。这样的PHP程序可能在大多数时间内仍正常工作，但可能已在代码中留下了巨大的安全漏洞，使其易受攻击。要时刻牢记PHP是一门很宽松的语言，这个观点十分重要，因此确保不在代码中遗留任何安全漏洞是重中之重，即使程序看起来工作正常。</p>

<p>最后一点，PHP开发框架是可扩展的，并且有许多框架可供选择。你也可以创造你自己的开发框架，不过许多开发者决定从那些流行的知名的开发框架中做选择，因为它们往往有着庞大的支持团队，以及相关的论坛/社区方便你与其他使用同一个框架的开发者相互交流。注意，你应当事先检验你的项目是否需要使用框架，这里提供一份简单的列表以供参考：使用框架能否节省你（和其他任何会使用它的人）的时间和精力？是否能够让程序得到更好的表现？能否提高稳定性？如果你对上面任何一个问题的回答是肯定的，那么使用PHP开发框架对于这个项目就可能是正确的选择。</p>

<h3>三、什么是Ap</h3>

<p>Ap是一个C语言编写的PHP开发框架，也是ODP环境指定使用的PHP开发框架。</p>

<p>目前PHP的框架层出不穷, 其中不乏很多优秀的框架, 比如Zend官方支持的Zend Framework, Yii, CodeIgniter等等。但繁多的框架可选择也造成了我们公司内部出现了基于多种框架的业务产品。这也导致不同的团队维护不同的产品，缺乏统一的技术规范，也增加了运营的成本。Ap框架的出现就是为了统一这个问题。</p>

<p>Ap基于PHP扩展开发，完全由C语言写成（相关内容请参考PHP扩展开发的知识），毫无疑问，Ap的性能比由纯PHP语言编写的开发框架有更好的性能。下面让我们结合上一章中app-cg产生的newapp示例，来了解Ap框架的运行过程以及在Ap框架中代码的分层与编写规范。</p>

<p>首先，让我们进入上一章部署的newapp目录，在ODP环境的app目录下有一个newapp目录，这便是一个可运行在Ap框架中的Controler和Module。app的概念在ODP环境中可以理解为一个子系统。</p>

<pre><code class="ruby">[chenyijie<span class="variable"><span class="variable">@cq01</span></span>-ksarch-rdtest0<span class="number"><span class="number">0</span></span>.vm newapp] <span class="variable"><span class="variable">$ </span></span>ls
actions <span class="constant"><span class="constant">Bootstrap</span></span>.php controllers library models script test
</code></pre>

<p>看到此图，根据以上的介绍，大家可能又会迷惑了，除了controllers和models，为什么又多出来这么多的文件夹呢？其实，从概念上MVC只是一种设计模式，是从设计的角度来理解的一种概念，而从代码实现的角度，代码的分层有其独立的规划，两者虽有联系，但却不能混为一谈。</p>

<p>Ap框架中代码的分层需要遵从《社区业务层规范》与《ODP App规范》，先不展开，让我们先来了解一下Ap框架的运行的流程。</p>

<p style="text-align: center; margin: 30px 0px; text-indent: 0px;"><img src="./ODP_files/odp_3_2.jpg" alt="Ap框架的运行流程图"><div class="legend">图 2 : Ap框架的运行流程图</div></p><div class="legend">图 2 : Ap框架的运行流程图</div><p></p>

<p>图中看到了bootstrap，没错，不用怀疑，这个指的便是newapp目录中唯一的Bootstrap.php文件，当Ap框架运行起来的时候，它会先去读取app目录下每个app中的Bootstrap.php文件，做app初始化的工作。Bootstrap.php文件相当于一个app在Ap框架中运行的配置文件，Bootstrap 也叫做引导程序。它是Ap提供的一个全局配置的入口, 在Bootstrap中,你可以做很多全局自定义的工作。</p>

<p>Bootstrap.php文件的内容如下：</p>

<pre><code class="php"><span class="preprocessor"><span class="preprocessor">&lt;?php</span></span>
<span class="comment"><span class="comment">/**
*<span class="phpdoc"><span class="phpdoc"> @name</span></span> Bootstrap
*<span class="phpdoc"><span class="phpdoc"> @desc</span></span> 所有在Bootstrap类中, 以_init开头的方法, 都会被Ap调用,
* 这些方法, 都接受一个参数:Ap_Dispatcher $dispatcher
* 调用的次序, 和申明的次序相同
*<span class="phpdoc"><span class="phpdoc"> @author</span></span> 何威(he_wei@baidu.com)
*/</span></span>
<span class="class"><span class="keyword"><span class="class"><span class="keyword">class</span></span></span><span class="class"> <span class="title"><span class="title">Bootstrap</span></span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title"><span class="title">Ap_Bootstrap_Abstract</span></span>{</span></span>
    <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">_initRoute</span></span><span class="params"><span class="params">(Ap_Dispatcher <span class="variable"><span class="variable">$dispatcher</span></span>)</span></span> {</span></span>
        <span class="comment"><span class="comment">//在这里注册自己的路由协议,默认使用static路由</span></span>
    }

    <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">_initPlugin</span></span><span class="params"><span class="params">(Ap_Dispatcher <span class="variable"><span class="variable">$dispatcher</span></span>)</span></span> {</span></span>
        <span class="comment"><span class="comment">//注册saf插件</span></span>
        <span class="variable"><span class="variable">$objPlugin</span></span> = <span class="keyword"><span class="keyword">new</span></span> Saf_ApUserPlugin();
        <span class="variable"><span class="variable">$dispatcher</span></span>-&gt;registerPlugin(<span class="variable"><span class="variable">$objPlugin</span></span>);
    }

    <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">_initView</span></span><span class="params"><span class="params">(Ap_Dispatcher <span class="variable"><span class="variable">$dispatcher</span></span>)</span></span>{</span></span>
        <span class="comment"><span class="comment">//在这里注册自己的view控制器，例如smarty,firekylin</span></span>
        <span class="variable"><span class="variable">$dispatcher</span></span>-&gt;disableView();
        <span class="comment"><span class="comment">//禁止ap自动渲染模板</span></span>
    }

    <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">_initDefaultName</span></span><span class="params"><span class="params">(Ap_Dispatcher <span class="variable"><span class="variable">$dispatcher</span></span>)</span></span> {</span></span>
        <span class="comment"><span class="comment">//设置路由默认信息</span></span>
        <span class="variable"><span class="variable">$dispatcher</span></span>-&gt;setDefaultModule(<span class="string"><span class="string">'Main'</span></span>);
        <span class="variable"><span class="variable">$dispatcher</span></span>-&gt;setDefaultController(<span class="string"><span class="string">'Main'</span></span>);
    }
}
</code></pre>

<p>由文件中的注释我们也已经可以从大体上了解到配置的意义。_initRoute函数是用于选择Ap框架提供的请求路由规则的，Ap总共提供了四种路由规则，这里使用了默认的static路由规则。其实这里的路由规则指的便是前端页面中的URL请求到服务器端Ap框架中一个模块的一个动作的映射关系。</p>

<p>“默认的路由协议Ap_Route_Static, 就是分析请求中的request_uri,在去除掉base_uri以后, 获取到真正的负载路由信息的request_uri片段,具体的策略是, 根据"/"对request_uri分段,依次得到Module,Controller,Action, 在得到Module以后,还需要根据Ap_Application::$modules来判断Module是否是合法的Module,如果不是, 则认为Module并没有体现在request_uri中,而把原Module当做Controller,原Controller当做Action。”——这段话来自odp.bae.baidu.com，是Ap框架作者对默认路由协议的解释，看起来非常专业，初学者可能看不懂，那这段话到底是什么意思呢？让我们结合第二章中newapp的例子，来初步解说一下。</p>

<pre><code class="ruby">如果用户使用的是nginx服务器，请确保被路由的location配置中已经<span class="keyword"><span class="keyword">include</span></span>了fastcgi.conf或者fastcgi_params两个文件之一的配置，并且fastcgi.conf或者fast_params文件中已经配置了如下配置项：

fastcgi_param  <span class="constant"><span class="constant">PATH_INFO</span></span>          <span class="variable"><span class="variable">$fastcgi_script_name</span></span>;
</code></pre>

<p>还记得我们初次运行newapp时，在浏览器里输入的URL地址么。</p>

<pre><code class="ruby"><span class="number"><span class="number">10.46</span></span>.<span class="number"><span class="number">135.25</span></span><span class="symbol"><span class="symbol">:</span></span><span class="number"><span class="number">8189</span></span>/newapp/sample<span class="number"><span class="number">?i</span></span>d=<span class="number"><span class="number">1</span></span>
</code></pre>

<p>当这个URL请求到达ODP中的lighttpd服务器后，lighttpd首先会将此URL根据lighttpd.conf文件中最后配置的rewrite规则，将这个URL改写为</p>

<pre><code class="ruby"><span class="number"><span class="number">10.46</span></span>.<span class="number"><span class="number">135.25</span></span><span class="symbol"><span class="symbol">:</span></span><span class="number"><span class="number">8189</span></span>/newapp/index.php/sample<span class="number"><span class="number">?i</span></span>d=<span class="number"><span class="number">1</span></span>
</code></pre>

<p>然后将改写后的URL进一步交给Ap框架的Router（关于这一点可以看下ODP环境中webroot/newapp/路径下的index.php文件，Ap框架便是在这个文件中被初始化的）。Router根据Bootstrap.php中配置的路由规则对URL进行解析，根据Ap的默认配置，10.46.135.28:8189/newapp/index.php部分不参与路由，根据Static路由规则，/sample?id=1字符串将参与路由，但是sample既不是Module也不是Controller，而仅仅是一个Action，那么什么是Action呢？</p>

<p>Action是模板跟PHP逻辑之间的桥梁，同时Action也是整个PHP业务层中唯一跟控制器框架有数据流通，和产生耦合的一层。</p>

<p>Action通常会对应到一个具体页面，Action层主要做的工作如下：</p>

<p>解析页面传回的参数，跟具体页面相关的权限判断等逻辑(通常为判断这个页面用户是否登录，等级等)，调用对应的Service接口，渲染模板变量。</p>

<p>可以见到，在我们的整个业务层逻辑结构中，Action层是一个非常”薄”的Action，Action不能包含业务逻辑，仅仅能包含于具体页面相关的逻辑。</p>

<p>以上对Action的解释来源于《ODP App规范》文件。其实，Action可以理解为Ap框架在完成URL解析后找到的一个业务接口，就好像银行一样，Ap框架的Router相当于大堂经理，但是Router这个大堂经理只能将你引导到自动叫号机器，这里的自动叫号机器可以理解为Module，虽然Module的概念在现阶段ODP开发中并没有利用起来，稍后介绍这个问题，而自动叫号机上运行的排队叫号程序便是Controller，由Controller告诉你应该去哪个窗口办理相关业务，而Action就可以理解为这个办理业务的窗口。记住Action仅仅指的是这个窗口，而并非窗口后面真正办理业务的银行工作人员，Action是很“薄”的一层，Action层可以做的事情在《社区业务层规范》中有清晰的定义，虽然在Action层中也可以让他实现具有窗口后的银行工作人员的职能的功能，但是这样是违反规范的，而且也不符合分层设计的意义，在具体的编码实现阶段，我们一定要根据《社区业务层规范》中的说明，理解每层设计需要完成的工作，不要随意按照自己的理解进行代码开发，这是工作中需要非常注意的！</p>

<p>在“sample?id=1”字符串中，“?id=1”代表使用GET方法给action传递的参数的键值对，在这个request_uri既没有提到Module又没有提到Controller，那Ap是怎样找到sample这个aciton对应的实现代码并执行的呢？我们来看下Bootstrap.php中25到29行的内容，这里指定了Ap的Router将使用默认的Module和Controller都为Main，也就是说如果我们没有在URL中指定Module和Controller，那么Ap框架的Router将使用默认的Module和Controller来寻找action对应的实现文件。下面，我们来看一下默认的Controller是怎样找到sample这个Action的实现文件的。让我们进入newapp/controllers目录。</p>

<pre><code class="ruby">[chenyijie<span class="variable"><span class="variable">@cq01</span></span>-ksarch-rdtest0<span class="number"><span class="number">0</span></span>.vm controllers] <span class="variable"><span class="variable">$ </span></span>ls
<span class="constant"><span class="constant">Api</span></span>.php <span class="constant"><span class="constant">Main</span></span>.php
</code></pre>

<p>用vi 打开Main.php文件，这便是Main Controller的内容：</p>

<pre><code class="java">&lt;?php
<span class="javadoc"><span class="javadoc">/**
 * <span class="javadoctag"><span class="javadoctag">@name</span></span> Main_Controller
 * <span class="javadoctag"><span class="javadoctag">@desc</span></span> 主控制器,也是默认控制器
 * <span class="javadoctag"><span class="javadoctag">@author</span></span> 何威(he_wei<span class="javadoctag"><span class="javadoctag">@baidu</span></span>.com)
 */</span></span>
<span class="class"><span class="keyword"><span class="class"><span class="keyword">class</span></span></span><span class="class"> <span class="title"><span class="title">Controller_Main</span></span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title"><span class="title">Ap_Controller_Abstract</span></span> {</span></span>
    <span class="keyword"><span class="keyword">public</span></span> $actions = array(
        <span class="string"><span class="string">'sample'</span></span> =&gt; <span class="string"><span class="string">'actions/Sample.php'</span></span>,
    );
}

?&gt;
</code></pre>

<p>在第九行中，我们看到sample这个页面请求被ApRouter处理后通过Main这个默认的Controller最终被映射到了actions目录中的Sample.php文件。Controller的内容仅仅是指定了URL中action与后台对应接口文件的映射关系，看起来更像是一个配置文件。在这里，我们可以补充一个小实验，将上一章中访问newapp的URL补齐：10.46.135.25:8189/newapp/Main/sample?id=1</p>

<pre><code class="undefined">Goodbye World!
</code></pre>

<p>效果与使用10.46.135.25:8189/newapp/sample?id=1是一致的，但是让我们再来看一下：10.46.135.25:8189/newapp/Main/sample?id=1</p>

<pre><code class="undefined">Goodbye World!
</code></pre>

<p>当我们不指定Module时，也得到了同样的访问效果，这也印证了Module的概念在Ap的Router中没有被利用起来的事实，大家可以先忽略Module在URL中的作用吧！</p>

<p>Ap框架默认的Controller和Module都是Index，如果我们没有在Bootstrap.php文件中的_initDefaultName中对默认的Controller和Module进行设置的话。因此本例中，我们如果使用了Index和Main以外的名字作为Controller的话，将在浏览器中看不到任何效果。</p>

<p>至此，我们已经知道了URL请求是怎样通过Ap框架找到了实现的过程，Router的其他几种路由规则，请大家参考 <a href="http://odp.baidu.com/ap_manual/ap.routes.usage.html">这个</a> 网址来进一步了解。</p>

<p>接下来，我们来具体介绍一个业务的具体实现，以及《社区业务层规范》，根据上面的指引，你一定想看看actions/Sample.php文件的内容。</p>

<pre><code class="php"><span class="preprocessor"><span class="preprocessor">&lt;?php</span></span>
<span class="comment"><span class="comment">/**
 *<span class="phpdoc"><span class="phpdoc"> @name</span></span> Action_Sample
 *<span class="phpdoc"><span class="phpdoc"> @desc</span></span> sample action, 和url对应
 *<span class="phpdoc"><span class="phpdoc"> @author</span></span> 何威(he_wei@baidu.com)
 */</span></span>
<span class="class"><span class="keyword"><span class="class"><span class="keyword">class</span></span></span><span class="class"> <span class="title"><span class="title">Action_Sample</span></span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title"><span class="title">Ap_Action_Abstract</span></span> {</span></span>

    <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">execute</span></span><span class="params"><span class="params">()</span></span> {</span></span>
        <span class="comment"><span class="comment">//1. check if user is login as needed</span></span>
        <span class="variable"><span class="variable">$arrUserinfo</span></span> = Saf_SmartMain::getUserInfo(); 
        <span class="keyword"><span class="keyword">if</span></span> (<span class="keyword"><span class="keyword">empty</span></span>(<span class="variable"><span class="variable">$arrUserinfo</span></span>)) {
            <span class="comment"><span class="comment">//ouput error</span></span>
        }

        <span class="comment"><span class="comment">//2. get and validate input params</span></span>
        <span class="variable"><span class="variable">$arrRequest</span></span> = Saf_SmartMain::getCgi();
        <span class="variable"><span class="variable">$arrInput</span></span> = <span class="variable"><span class="variable">$arrRequest</span></span>[<span class="string"><span class="string">'get'</span></span>];
        <span class="keyword"><span class="keyword">if</span></span>(!<span class="keyword"><span class="keyword">isset</span></span>(<span class="variable"><span class="variable">$arrInput</span></span>[<span class="string"><span class="string">'id'</span></span>])){
            <span class="comment"><span class="comment">//output error</span></span>
        }
        Bd_Log::debug(<span class="string"><span class="string">'request input'</span></span>, <span class="number"><span class="number">0</span></span>, <span class="variable"><span class="variable">$arrInput</span></span>);

        <span class="comment"><span class="comment">//3. call PageService</span></span>
        <span class="variable"><span class="variable">$objServicePageSample</span></span> = <span class="keyword"><span class="keyword">new</span></span> Service_Page_Sample();
        <span class="variable"><span class="variable">$arrPageInfo</span></span> = <span class="variable"><span class="variable">$objServicePageSample</span></span>-&gt;execute(<span class="variable"><span class="variable">$arrInput</span></span>);

        <span class="comment"><span class="comment">//4. chage data to out format</span></span>
        <span class="variable"><span class="variable">$arrOutput</span></span> = <span class="variable"><span class="variable">$arrPageInfo</span></span>;

        <span class="comment"><span class="comment">//5. build page</span></span>
        <span class="comment"><span class="comment">//smarty模板，以下渲染模板的代码依赖于提供一个tpl模板</span></span>
        <span class="comment"><span class="comment">//$tpl = Bd_TplFactory::getInstance();</span></span>
        <span class="comment"><span class="comment">//$tpl-&gt;assign($arrOutput);</span></span>
        <span class="comment"><span class="comment">//$tpl-&gt;display('en/newapp/index.tpl');</span></span>
        <span class="comment"><span class="comment">//这里直接输出,作为示例</span></span>
        <span class="variable"><span class="variable">$strOut</span></span> = <span class="variable"><span class="variable">$arrOutput</span></span>[<span class="string"><span class="string">'data'</span></span>];
        <span class="keyword"><span class="keyword">echo</span></span> <span class="variable"><span class="variable">$strOut</span></span>;
        <span class="comment"><span class="comment">//notice日志信息打印，只需要添加日志信息，saf会自动打一条log</span></span>
        Bd_Log::addNotice(<span class="string"><span class="string">'out'</span></span>, <span class="variable"><span class="variable">$arrOutput</span></span>);
    }
}
</code></pre>

<p>可见Sample.php文件中只有一个类Action_Sample，且只有一个execute()方法。这种设计是Ap框架指定的，《ODPApp规范》中指定了Action的命名规范必须已Action_作为前缀，其实，大家可以试试将Sample.php文件中类名的Action_前缀去掉，或者将execute()方法名修改为其他任意的方法名，则都将导致ODP环境log目录中的php-error.log文件中产生错误信息。php-error.log文件是所有PHP错误的输出文件,大家以后遇到问题，需要经常关注这个文件来排查，非常重要。产生的错误信息如下图所示：</p>

<pre><code class="bash">[25-Jun-2012 12:28:22] PHP Fatal error: Uncaught exception <span class="string"><span class="string">'Ap_Exception_LoadFailed_Action'</span></span> with message <span class="string"><span class="string">'Could not find
action Action_Sample in /home/chenyijie/odpExample/app/newapp/actions/Sample.php'</span></span> <span class="keyword"><span class="keyword">in</span></span> /home/chenyijie/odpExample/webroot/
newapp/index.php:8
Stack trace:
<span class="comment"><span class="comment">#0 /home/chenyijie/odpExample/webroot/newapp/index.php(8): Ap_Application-&gt;run()</span></span>
<span class="comment"><span class="comment">#1 {main}</span></span>
    thrown <span class="keyword"><span class="keyword">in</span></span> /home/chenyijie/odpExample/webroot/newapp/index.php on line 8
</code></pre>

<p>改变Action类名后的php-error.log中显示的错误信息</p>

<pre><code class="perl">[<span class="number"><span class="number">25</span></span>-Jun-<span class="number"><span class="number">2012</span></span> <span class="number"><span class="number">13</span></span>:<span class="number"><span class="number">19</span></span>:<span class="number"><span class="number">05</span></span>] PHP Fatal error: Class Action_Sample contains <span class="number"><span class="number">1</span></span> abstract method <span class="keyword"><span class="keyword">and</span></span> must therefore be declared
abstract <span class="keyword"><span class="keyword">or</span></span> implement the remaining methods (Ap_Action_Abstract::execute) in /home/chenyijie/odpExample/app/newapp/
actions/Sample.php on line <span class="number"><span class="number">7</span></span>
[<span class="number"><span class="number">25</span></span>-Jun-<span class="number"><span class="number">2012</span></span> <span class="number"><span class="number">13</span></span>:<span class="number"><span class="number">19</span></span>:<span class="number"><span class="number">05</span></span>] PHP Stack trace:
[<span class="number"><span class="number">25</span></span>-Jun-<span class="number"><span class="number">2012</span></span> <span class="number"><span class="number">13</span></span>:<span class="number"><span class="number">19</span></span>:<span class="number"><span class="number">05</span></span>] PHP  <span class="number"><span class="number">1</span></span>. <span class="string"><span class="string">{main}</span></span>() /home/chenyijie/odpExample/webroot/newapp/<span class="keyword"><span class="keyword">index</span></span>.php:<span class="number"><span class="number">0</span></span>
[<span class="number"><span class="number">25</span></span>-Jun-<span class="number"><span class="number">2012</span></span> <span class="number"><span class="number">13</span></span>:<span class="number"><span class="number">19</span></span>:<span class="number"><span class="number">05</span></span>] PHP  <span class="number"><span class="number">2</span></span>. Ap_Application-&gt;run() /home/chenyijie/odpExample/webroot/newapp/<span class="keyword"><span class="keyword">index</span></span>.php:<span class="number"><span class="number">8</span></span>
[<span class="number"><span class="number">25</span></span>-Jun-<span class="number"><span class="number">2012</span></span> <span class="number"><span class="number">13</span></span>:<span class="number"><span class="number">19</span></span>:<span class="number"><span class="number">05</span></span>] PHP  <span class="number"><span class="number">3</span></span>. Ap_Application-&gt;run() /home/chenyijie/odpExample/webroot/newapp/<span class="keyword"><span class="keyword">index</span></span>.php:<span class="number"><span class="number">8</span></span>
</code></pre>

<p>让我们回到Sample.php文件，第11行，调用了SAF框架的getUserInfo函数，来获得用户的登录信息，这里指的用户登录信息是使用passport服务而得到的用户信息，passport服务是公司外部用户登录与用户数据维护服务，指的便是百度账号，公司内部使用UUAP服务作为内部员工登录与用户信息维护服务，SAF目前已经支持passport服务与UUAP服务。此处的arrUserInfo肯定是空的。第17行Saf_SmartMain::getCgi()函数返回页面中通过GET和POST方法传递到的服务器端的信息，是以Key-Value的形式传递的。我们可以简单的将$arrRequest的内容通过var_dump()函数打印出来：</p>

<pre><code class="php"><span class="keyword"><span class="keyword">array</span></span>
  <span class="string"><span class="string">'get'</span></span> =&gt;
    <span class="keyword"><span class="keyword">array</span></span>
      <span class="string"><span class="string">'id'</span></span> =&gt; string <span class="string"><span class="string">'1'</span></span> (length=<span class="number"><span class="number">1</span></span>)
  <span class="string"><span class="string">'post'</span></span> =&gt;
    <span class="keyword"><span class="keyword">array</span></span>
      <span class="keyword"><span class="keyword">empty</span></span>
  <span class="string"><span class="string">'request_param'</span></span> =&gt;
    <span class="keyword"><span class="keyword">array</span></span>
      <span class="string"><span class="string">'id'</span></span> =&gt; string <span class="string"><span class="string">'1'</span></span> (length=<span class="number"><span class="number">1</span></span>)
</code></pre>

<p>可见，<code>10.46.135.25:8189/newsapp/Main/sample?id=1</code> 请求中，问号后面的部分被SAF解析为id和1的键值对，并将其封装于一个array中。框架SAF框架将页面通过get与post方法提交的信息做了分离与整合，request_param这个array中便是整合的内容，而不区分提交的方法。这里提到了SAF框架，下面让我们来稍微了解一下：</p>

<p>SAF是一个业务层框架，设计的目的主要是为了把业务逻辑开发过程中一些共性的部分抽取出来建立成统一的框架。框架包含控制器组件，通用业务组件（参数处理，session处理，打日志等），配置组件，日志组件等等。SAF的主要的具体功能如验证用户登录信息，接收用户提交的数据，更改用户的信息，记录用户操作行为（以便统计分析与数据挖掘）等。SAF作为框架是对业务层一些公共业务的抽象，和Ap作为开发框架没有可比性，大家不要混淆，甚至可以将SAF理解为Ap框架开发中提供的工具类库。下一章将对SAF框架的使用进行详细的讲解。</p>

<p>第22行，通过Bd_Log库的debug静态函数打印了一条日志信息，大家不要被debug所迷惑，可能会疑问是否需要在上线或release时将这些日志去掉。其实完全没有必要，debug静态函数的输出内容相当于trace跟踪信息，适时的在我们的代码中用Bd_Log::debug()输出信息，有助于我们进行问题定位与追踪，也是一种非常重要的调试手段。而Bd_Log库从字面上理解，其便是被设计用来进行日志打印的，将在后面使用通用库的章节中进行讲解。</p>

<p>第25行 <code>$objServicePageSample = new Service_Page_Sample();</code> 以及26行 <code>$arrPageInfo = $objServicePageSample-&gt;execute($arrInput);</code> 中Action层调用了PS层的类，来进行后续的处理，同时将从页面传递过来的参数通过一个array（这里是$arrInnput）传递到PS层。大家可能会疑问，我们没有在Sample.php中看见任何的include或者是require语句，Sample.php是怎样找到Service_Page_Sample这个类的呢？这便要说到Ap框架的类加载机制了。</p>

<p>Ap框架规定类名中必须包含路径信息,也就是以下划线"_"分割的目录信息。Ap将依照类名中的目录信息,完成类的自动加载，而不需要通过include与require语句载入类的具体实现的文件。在《ODP App规范》中规定，源代码中禁止出现include与require语句，而是所有的类都通过Ap框架的类加载机制来载入。</p>

<p>在Ap框架加载类时，设置了一个默认的路径，称为Ap目录映射规则，规则的内容如下：</p>

<table class="table table-striped table-bordered">
<thead>
<tr>
  <th>类型</th>
  <th>后缀</th>
  <th>映射路径</th>
</tr>
</thead>
<tbody>
<tr>
  <td>控制器</td>
  <td>Controller</td>
  <td>默认模块下为{项目路径}/controllers/, 否则为{项目路径}/modules/{模块名}/controllers/</td>
</tr>
<tr>
  <td>数据模型</td>
  <td>Model</td>
  <td>{项目路径}/models/</td>
</tr>
</tbody>
</table>

<p>可见数据模型的类寻址路径是从models目录开始的。结合以上信息，Service_Page_Sample这个类的类名反映了其路径地址，可见这个类的真实路径为：</p>

<pre><code class="undefined">{项目路径}/models/service/page/Sample.php
</code></pre>

<p>Ap支持大小写敏感和不敏感两种方式来处理文件路径，默认大小写是不敏感的因此，在app-cg生成的newapp示例中的文件名如“service”、“page”都是小写的文件夹名称，但是根据Service_Page_Sample这个类名依然能正确找到Sample.php这个PS层的类。在models文件夹中的类的类名都以这种方式命名，以符合Ap框架自动加载类的要求。</p>

<p>26行调用完毕以后，<span>$</span>arrPageInfo便存储了业务处理完成后的结果，这便是用户需要的数据，在第34到36行中，示例给出了使用smarty模板技术将<span>$</span>arrPageInfo（注意此处示例将<span>$</span>arrPageInfo的内容复制给了<span>$</span>arrOutput）中的内容注入到页面.tpl文件中的示例代码，但是注释掉了。在示例中，只是简单的使用echo语句将<span>$</span>arrPageInfo中data键对应的值显示到了页面上，就是大家看到的“GoodBye
World!”字符串。现在让我们结合smarty技术来展现这个字符串。修改34到40行的代码如下：</p>

<pre><code class="php"><span class="number"><span class="number">32</span></span>         <span class="comment"><span class="comment">//5. build page</span></span>
<span class="number"><span class="number">33</span></span>         <span class="comment"><span class="comment">//smarty模板，以下渲染模板的代码依赖于提供一个tpl模板</span></span>
<span class="number"><span class="number">34</span></span>         <span class="variable"><span class="variable">$tpl</span></span> = Bd_TplFactory::getInstance();
<span class="number"><span class="number">35</span></span>         <span class="variable"><span class="variable">$tpl</span></span>-&gt;assign(<span class="string"><span class="string">'arrOutput'</span></span>,<span class="variable"><span class="variable">$arrOutput</span></span>[<span class="string"><span class="string">'data'</span></span>]); <span class="comment"><span class="comment">//主要是修改此行代码</span></span>
<span class="number"><span class="number">36</span></span>         <span class="variable"><span class="variable">$tpl</span></span>-&gt;display(<span class="string"><span class="string">'newapp/index.tpl'</span></span>);
<span class="number"><span class="number">37</span></span> 
<span class="number"><span class="number">38</span></span>         <span class="comment"><span class="comment">//这里直接输出,作为示例</span></span>
<span class="number"><span class="number">39</span></span>         <span class="comment"><span class="comment">//$strOut = $arrOutput['data'];</span></span>
<span class="number"><span class="number">40</span></span>         <span class="comment"><span class="comment">//echo $strOut;</span></span>
</code></pre>

<p>这里assign函数可以用来将业务层的处理结果交给.tpl模板文件。而display函数则指定了使用哪个.tpl文件来展现<span>$</span>arroutput[‘data’]中的内容。这里使用相对路径直接使用newapp/index.tpl找到template中newapp文件夹下的index.tpl文件，可见tpl模板的寻址是根据template文件夹的路径作为基准的。</p>

<p>下面让我们到template文件夹使用mkdir命令建立newapp文件夹，并在其中使用vi建立并编辑index.tpl文件，内容如下：</p>

<pre><code class="xml"><span class="tag"><span class="tag">&lt;<span class="title"><span class="title">html</span></span>&gt;</span></span>
<span class="tag"><span class="tag">&lt;<span class="title"><span class="title">head</span></span>&gt;</span></span>
    <span class="tag"><span class="tag">&lt;<span class="title"><span class="title">META</span></span> <span class="attribute"><span class="attribute">http-equiv</span></span>=<span class="value"><span class="value">"Content-Type"</span></span> <span class="attribute"><span class="attribute">content</span></span>=<span class="value"><span class="value">"text/html; charset=utf-8"</span></span>&gt;</span></span>
    <span class="tag"><span class="tag">&lt;<span class="title"><span class="title">title</span></span>&gt;</span></span>ODP环境smarty模板技术试验<span class="tag"><span class="tag">&lt;/<span class="title"><span class="title">title</span></span>&gt;</span></span>
<span class="tag"><span class="tag">&lt;/<span class="title"><span class="title">head</span></span>&gt;</span></span>
<span class="tag"><span class="tag">&lt;<span class="title"><span class="title">body</span></span>&gt;</span></span>
    <span class="tag"><span class="tag">&lt;<span class="title"><span class="title">h1</span></span>&gt;</span></span>{%$arrOutput%}<span class="tag"><span class="tag">&lt;/<span class="title"><span class="title">h1</span></span>&gt;</span></span>
<span class="tag"><span class="tag">&lt;/<span class="title"><span class="title">body</span></span>&gt;</span></span>
<span class="tag"><span class="tag">&lt;/<span class="title"><span class="title">html</span></span>&gt;</span></span>
</code></pre>

<p>smarty模板技术中，.tpl文件内容可以直接包含HTML代码，在第7行中使用<code>{%</code> <code>%}</code>符号将Action中注入的<span>$</span>arrOutput的内容取出，聪明的你一定注意到了<span>$</span>arrOutput变量的名字和<span>$</span>tpl-&gt;assign('arrOutput',<span>$</span>arrOutput['data']);语句中第一个参数设置的字符串一致。其实用于取Action注入的变量值的符号<code>{%</code> <code>%}</code>是可配置的，配置文件在ODP环境中conf文件夹下的smarty.conf文件的第38和39行，我们当然可以按照自己的喜好来设置这两个符号，但是前端FIS规范中规定ODP中smarty模板必须使用<code>{%</code> <code>%}</code>符号作为开始与结束的取变量通配符。因此，smarty.conf文件的内容不要轻易修改，我们也要严格按照规范的要求来编写符合规范的代码。OK，下面，就让我们看看使用smarty模板技术展现业务处理结果的效果吧，让我们重新访问那个熟悉的URL：<code>10.46.135.25:8189/newapp/Main/sample?id=1</code></p>

<pre><code class="undefined">Goodbye World!
</code></pre>

<p>怎么样，效果出来了么？标签页的title变成了index.tpl中设置的“ODP环境smarty模板技术实验”，而且字号也变为了<code>&lt;h1&gt;</code>。这里也可以看出，Smarty模板正是MVC中的Viewer了。下一章，我们将重点讲解《社区业务层规范》，并结合newapp中models目录中的代码分析ODP中业务代码的分层设计。</p>

            </div>
                <div class="bs-docs-section">
              <div class="page-header">
          <h1 id="业务层规范">业务层规范
            <a class="btn btn-edit btn-primary pull-right">
              <span class="glyphicon glyphicon-edit"></span> 编辑本段
            </a>
          </h1>
        </div>
                <h3>一、什么是业务层规范</h3>

<p>目前百度大社区缺乏一个统一的业务层框架以及规范。每个产品线都有自己的一套习惯/规范。同时，新产品开发时在业务分层，逻辑拆分以及部署规范方面也都要重新开始摸索和积累。这样子一方面造成大产品线之间会有很多差异，另外一方面新产品也会把老产品踩过的雷又踩一遍。</p>

<p>我们梳理这个业务层规范主要是为了规范化业务分层、逻辑拆分、接口约定、模块的目录/命名结构，以及部署同构这一系列，应用开发、部署过程中所面临的问题。</p>

<p>以上两段话摘自《社区业务层规范》中的背景，我们大致可以了解到这样一个事实：业务层代码开发的结构比较灵活，凡是业务层代码中可以被Ap框架的自动加载器加载的类都可以在Ap框架中运行，类之间的接口设计也具有极大的自由。</p>

<p>业务层规范侧重于统一具体业务/应用开发过程中需要处理的诸如如何分层，层次之间接口如何约定，部署环境，以及业务/应用内部的目录，命名组织等问题。而作为规范，我们只需要遵守便可，下面先总体介绍一下业务开发的总体分层结构。</p>

<h3>二、分层结构</h3>

<p>一个应用的逻辑可拆分为模板，Action，PageService，DataService，Dao这5个层次，其中模板为视图层，模板和Dao可选。</p>

<p style="text-align: center; margin: 30px 0px; text-indent: 0px;"><img src="./ODP_files/odp_4_1.jpg" alt="ODP业务分层图"><div class="legend">图 3 : ODP业务分层图</div></p><div class="legend">图 3 : ODP业务分层图</div><p></p>

<p>模板和Action层大家已经有了初步的概念，那么PageService、DataService、DAO层又是如何呢，首先让我们来看一下这几层对应的源代码文件的位置。项目文件夹newapp中的models目录中有两个目录分别为dao和service而service目录中又有两个目录page和data，这种目录结构也清晰的对应了以上的分层设计。而在这些目录中均有一个Sample.php文件，这些便是app-cg生成的各层的示例代码源文件，但是打开来看的话，虽然每个Sample.php中都只有一个类，但是类名却不一样的，因为类名包含了相对于models目录的路径信息，但是类名中最后一个“_”后面部分的字符串和文件名是相同，这和Java中类的设计有一定的相似性，Ap框架的类名中前面的路径部分可以想象成Java中的package名，而Java中有package这个关键字简化了类名，其实Java中类的完整名字是包含包结构信息的。</p>

<p>OK，现在让我们来自顶向下的介绍各层的示例代码与规范。</p>

<p>在newapp的 models/service/page 目录下可以看到 <code>SampleApi.php</code>，<code>Sample.php</code> 两个文件，<code>SampleApi.php</code> 文件中包含的是用于子系统之间调用的接口，比如两个不同的app之间，一个app需要调用另一个app的业务，便是通过PageService层提供的API接口进行的，而Sample.php文件中包含的是Action层对PageService层的调用接口。Sample.php的内容如下：</p>

<pre><code class="php"><span class="preprocessor"><span class="preprocessor">&lt;?php</span></span>
<span class="comment"><span class="comment">/**
 *<span class="phpdoc"><span class="phpdoc"> @name</span></span> Service_Page_Sample
 *<span class="phpdoc"><span class="phpdoc"> @desc</span></span> sample page service, 和action对应，组织页面逻辑，组合调用data service
 *<span class="phpdoc"><span class="phpdoc"> @author</span></span> 何威(he_wei@baidu.com)
 */</span></span>
<span class="class"><span class="keyword"><span class="class"><span class="keyword">class</span></span></span><span class="class"> <span class="title"><span class="title">Service_Page_Sample</span></span> {</span></span>
    <span class="keyword"><span class="keyword">private</span></span> <span class="variable"><span class="variable">$objServiceDataSample</span></span>;
    <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">__construct</span></span><span class="params"><span class="params">()</span></span>{</span></span>
        <span class="variable"><span class="variable">$this</span></span>-&gt;objServiceDataSample = <span class="keyword"><span class="keyword">new</span></span> Service_Data_Sample();
    }

    <span class="comment"><span class="comment">//set注入</span></span>
    <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">__set</span></span><span class="params"><span class="params">(<span class="variable"><span class="variable">$property</span></span>,<span class="variable"><span class="variable">$value</span></span>)</span></span>{</span></span>
        <span class="variable"><span class="variable">$this</span></span>-&gt;<span class="variable"><span class="variable">$property</span></span> = <span class="variable"><span class="variable">$value</span></span>;
    }

    <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">execute</span></span><span class="params"><span class="params">(<span class="variable"><span class="variable">$arrInput</span></span>)</span></span>{</span></span>
        Bd_Log::debug(<span class="string"><span class="string">'sample page service called'</span></span>);
        <span class="variable"><span class="variable">$arrResult</span></span> = <span class="keyword"><span class="keyword">array</span></span>();
        <span class="variable"><span class="variable">$arrResult</span></span>[<span class="string"><span class="string">'errno'</span></span>] = <span class="number"><span class="number">0</span></span>;
        <span class="keyword"><span class="keyword">try</span></span>{
            <span class="variable"><span class="variable">$intId</span></span> = intval(<span class="variable"><span class="variable">$arrInput</span></span>[<span class="string"><span class="string">'id'</span></span>]);
            <span class="keyword"><span class="keyword">if</span></span>(<span class="variable"><span class="variable">$intId</span></span> &lt;= <span class="number"><span class="number">0</span></span>){
                <span class="comment"><span class="comment">//参数错误的时候，从配置文件取消息</span></span>
                <span class="variable"><span class="variable">$strData</span></span> = Bd_Conf::getAppConf(<span class="string"><span class="string">'sample/msg'</span></span>);
                <span class="variable"><span class="variable">$arrResult</span></span>[<span class="string"><span class="string">'data'</span></span>] = <span class="variable"><span class="variable">$strData</span></span>;
            } <span class="keyword"><span class="keyword">else</span></span> <span class="keyword"><span class="keyword">if</span></span>(<span class="variable"><span class="variable">$this</span></span>-&gt;objServiceDataSample-&gt;isExist(<span class="variable"><span class="variable">$intId</span></span>)){
                <span class="comment"><span class="comment">//以下获取数据的方式提供3种示例，3选1</span></span>
                <span class="comment"><span class="comment">//1. 调用本地DS</span></span>
                <span class="variable"><span class="variable">$strData</span></span> = <span class="variable"><span class="variable">$this</span></span>-&gt;objServiceDataSample-&gt;getSample(<span class="variable"><span class="variable">$intId</span></span>);
                <span class="comment"><span class="comment">//2. 子系统交互,注意：请确保conf/saf.conf中的api_lib配置成Newpro, 否则会出错</span></span>
                <span class="comment"><span class="comment">//$strData = $this-&gt;objServiceDataSample-&gt;callOtherApp($intId);</span></span>
                <span class="comment"><span class="comment">//3. 调用本地库</span></span>
                <span class="comment"><span class="comment">//$objUtil = new App2_Util();</span></span>
                <span class="comment"><span class="comment">//$strData = $objUtil-&gt;getUtilMsg();</span></span>
                <span class="variable"><span class="variable">$arrResult</span></span>[<span class="string"><span class="string">'data'</span></span>] = <span class="variable"><span class="variable">$strData</span></span>;
            }<span class="keyword"><span class="keyword">else</span></span>{
                <span class="variable"><span class="variable">$arrResult</span></span>[<span class="string"><span class="string">'errno'</span></span>] = <span class="number"><span class="number">222</span></span>;
                <span class="comment"><span class="comment">//示例错误码</span></span>
            }
        }<span class="keyword"><span class="keyword">catch</span></span>(<span class="keyword"><span class="keyword">Exception</span></span> <span class="variable"><span class="variable">$e</span></span>){
            Bd_Log::warning(<span class="variable"><span class="variable">$e</span></span>-&gt;getMessage(), <span class="variable"><span class="variable">$e</span></span>-&gt;getCode());
            <span class="variable"><span class="variable">$arrResult</span></span>[<span class="string"><span class="string">'errno'</span></span>] = <span class="variable"><span class="variable">$e</span></span>-&gt;getCode();
        }
        <span class="keyword"><span class="keyword">return</span></span> <span class="variable"><span class="variable">$arrResult</span></span>;
    }
}
</code></pre>

<p>PageService层主要做一个具体的请求相关的业务逻辑处理，PageService是在DataService的接口基础上，跟具体业务逻辑相关的接口封装。一个Action层的类会严格对应于一个PageService层的类。但是一个PageService的类可能会被多个Action层的类调用（比如说pc版的Action和wap版的Action）。PageService只暴露一个接口execute接口，采用函数参数形式，接口固定为：</p>

<p>public execute($arrParams)；输入为array，输出为array。</p>

<p>PageService层的类中的execute函数里必须进行异常捕获，并且返回值格式固定为：array('errno'=&gt; 0, 'data'=&gt; $arrData)其中errno为错误号，无异常发生则返回0，否则返回错误号；data里返回PageService获取的数据。</p>

<p>以上提到的都是《ODP App规范》中对PageService层类的强制要求。这里所说的data里返回PageService获取的数据，一般情况下是DataService层的接口传过来的数据。</p>

<p>注意到第22行到第26行，对Action层传入的参数$arrInput进行了参数验证，如果id（这个id便是我们通过URL中“?”后面的条件传递到服务器的参数）为null或者id的值为零或负数，则使用Bd_Conf库函数读取ODP环境conf/app/newapp目录下的global.conf配置文件中sample项中msg的值，让我们先来看一下global.conf这个配置文件的内容:</p>

<pre><code class="css"><span class="attr_selector"><span class="attr_selector">[ap]</span></span>
<span class="tag"><span class="tag">modules</span></span><span class="pseudo"><span class="pseudo">:Main</span></span>
<span class="attr_selector"><span class="attr_selector">[.library]</span></span>
<span class="tag"><span class="tag">namespace</span></span>: <span class="tag"><span class="tag">Newapp</span></span>

<span class="attr_selector"><span class="attr_selector">[service]</span></span>
<span class="attr_selector"><span class="attr_selector">[.app_newapp]</span></span>
#默认是本地<span class="tag"><span class="tag">php</span></span>调用，如果改成<span class="tag"><span class="tag">http</span></span>, 请添加相关<span class="tag"><span class="tag">ral</span></span> <span class="tag"><span class="tag">service</span></span>配置
<span class="tag"><span class="tag">proxy</span></span> : <span class="tag"><span class="tag">php</span></span>

<span class="attr_selector"><span class="attr_selector">[sample]</span></span>
<span class="tag"><span class="tag">msg</span></span>: <span class="tag"><span class="tag">GoodBye</span></span> <span class="tag"><span class="tag">World</span></span>!(<span class="tag"><span class="tag">from</span></span> <span class="tag"><span class="tag">conf</span></span>)
</code></pre>

<p>可以看到，是字符串“GoodBye World!(from conf)”，这里提到了通用库Bd_Conf，ODP环境集成了公司已经实现的绝大部分通用库，Bd_Conf是针对配置读取设计的通用库，Bd_Log是针对日志打印设计的通用库，还有Bd_Db是用于数据库交互的通用库，这些通用库是作为ODP环境的PHP扩展的形式存在的，通用库提供了一系列的静态函数供用户调用，这也是使用ODP的一大优势，ODP环境在安装的时候便已经默认将这些通用库都安装好了，我们只需要查相应的通用库手册，便可以使用这些通用库，非常方便。</p>

<p>那么，这段代码的运行效果如何呢？让我们在浏览器中测试一下，访问如下两个URL：</p>

<p><a href="http://10.46.135.25:8189/newapp/Main/sample">http://10.46.135.25:8189/newapp/Main/sample</a></p>

<p><a href="http://10.46.135.25:8189/newapp/Main/sample?id=-1">http://10.46.135.25:8189/newapp/Main/sample?id=-1</a></p>

<p>效果如下图所示：（如果你还是用上一章的那个index.tpl文件作为渲染模板的话）</p>

<pre><code class="cs">Goodbye World!(<span class="keyword"><span class="keyword">from</span></span> conf)
</code></pre>

<p>第27行，调用了objServiceDataSample对象的isExist()函数，而objServiceDataSample对象从第10行可以看到正是Service_Data_Sample类的实例，而Service_Data_Sample类便是对应了DataService层的接口。Service_Data_Sample类从前面的介绍可以了解到其命名反映了路径信息，因此说明这个类的源文件对应了models目录中service文件夹下data目录中的Sample.php文件。下面让我继续进行DataService层的介绍。</p>

<p>DataService层，主要是在DAO这一层的基础上提供一个比较细粒度的接口封装，或者说提供原子功能的接口封装。对于DataService层，最细粒度的接口为，具体一个DAO的接口，加上对应的cache操作逻辑。不过通常来说，DataService层主要做如下工作：</p>

<p>（一）具体数据库（dao）和cache的数据组合，拼装</p>

<p>（二）逻辑上的一个原子操作</p>

<p>（三）可以被多个业务逻辑调用的细粒度接口</p>

<p>如果具体的php模块不跟数据库交互，而是与一个后端服务交互，则在DataService封装与具体服务相关的命令逻辑。</p>

<p>以上的介绍摘自《社区业务层规范》，可以看出来DataService层的定义与DAO层具有一定的依赖关系，特别是在使用数据库的时候。DataService层的功能具体的来说可能是对DAO层返回的数据进行拼装，比如多表级联查询的功能便可以被DataService层取代，大家都知道多表查询级联查询极占数据库的资源，但是可以通过在DataService层通过将DAO层返回的各单张表中记录的数据进行拼接和裁剪，使得数据达到多表查询一样的效果，也是一种做法。当然这里阐述的只是DataService层一个很小的功能点，DataService层中Sample.php文件的实现如下：</p>

<pre><code class="php"><span class="preprocessor"><span class="preprocessor">&lt;?php</span></span>
<span class="comment"><span class="comment">/**
 *<span class="phpdoc"><span class="phpdoc"> @name</span></span> Service_Data_Sample
 *<span class="phpdoc"><span class="phpdoc"> @desc</span></span> sample data service, 按主题组织数据, 提供细粒度数据接口
 *<span class="phpdoc"><span class="phpdoc"> @author</span></span> 何威(he_wei@baidu.com) 
 */</span></span>
<span class="class"><span class="keyword"><span class="class"><span class="keyword">class</span></span></span><span class="class"> <span class="title"><span class="title">Service_Data_Sample</span></span> {</span></span>
    <span class="keyword"><span class="keyword">private</span></span> <span class="variable"><span class="variable">$objDaoSample</span></span>;
    <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">__construct</span></span><span class="params"><span class="params">()</span></span>{</span></span>
        <span class="variable"><span class="variable">$this</span></span>-&gt;objDaoSample = <span class="keyword"><span class="keyword">new</span></span> Dao_Sample();
    }
    <span class="comment"><span class="comment">//set注入</span></span>
    <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">__set</span></span><span class="params"><span class="params">(<span class="variable"><span class="variable">$property</span></span>,<span class="variable"><span class="variable">$value</span></span>)</span></span>{</span></span>
        <span class="variable"><span class="variable">$this</span></span>-&gt;<span class="variable"><span class="variable">$property</span></span> = <span class="variable"><span class="variable">$value</span></span>;
    }
    <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">isExist</span></span><span class="params"><span class="params">(<span class="variable"><span class="variable">$intId</span></span>)</span></span>{</span></span>
        <span class="keyword"><span class="keyword">if</span></span>(<span class="variable"><span class="variable">$intId</span></span> &gt; <span class="number"><span class="number">0</span></span> &amp;&amp; <span class="variable"><span class="variable">$intId</span></span> &lt; <span class="number"><span class="number">100</span></span>){
            <span class="keyword"><span class="keyword">return</span></span> <span class="keyword"><span class="keyword">true</span></span>;
        }
        <span class="keyword"><span class="keyword">return</span></span> <span class="keyword"><span class="keyword">false</span></span>;
    }
    <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">getSample</span></span><span class="params"><span class="params">(<span class="variable"><span class="variable">$intId</span></span>)</span></span>{</span></span>
        Bd_Log::debug(<span class="string"><span class="string">"sample data service getSample called"</span></span>); 
        <span class="variable"><span class="variable">$strData</span></span> = <span class="variable"><span class="variable">$this</span></span>-&gt;objDaoSample-&gt;getSampleById(<span class="variable"><span class="variable">$intId</span></span>);
        <span class="keyword"><span class="keyword">return</span></span> <span class="variable"><span class="variable">$strData</span></span>;
    }
    <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">addSample</span></span><span class="params"><span class="params">(<span class="variable"><span class="variable">$strData</span></span>)</span></span>{</span></span>
        Bd_Log::debug(<span class="string"><span class="string">"sample data service submitSample called"</span></span>);
        <span class="variable"><span class="variable">$arrFields</span></span> = <span class="keyword"><span class="keyword">array</span></span>(<span class="string"><span class="string">'data'</span></span>=&gt;<span class="variable"><span class="variable">$strData</span></span>);
        <span class="keyword"><span class="keyword">return</span></span> <span class="variable"><span class="variable">$this</span></span>-&gt;objDaoSample-&gt;addSample(<span class="variable"><span class="variable">$arrFields</span></span>);
    }
    <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">callOtherApp</span></span><span class="params"><span class="params">(<span class="variable"><span class="variable">$intId</span></span>)</span></span>{</span></span>
        <span class="comment"><span class="comment">//跨子系统调用,这里调用自己作为示例</span></span>
        <span class="variable"><span class="variable">$arrRet</span></span> = Saf_Api_Server::call(<span class="string"><span class="string">'newapp'</span></span>, <span class="string"><span class="string">'getSample'</span></span>, <span class="keyword"><span class="keyword">array</span></span>(<span class="string"><span class="string">'id'</span></span> =&gt; <span class="variable"><span class="variable">$intId</span></span>), <span class="keyword"><span class="keyword">null</span></span>, <span class="keyword"><span class="keyword">null</span></span>);
        <span class="keyword"><span class="keyword">if</span></span>(<span class="keyword"><span class="keyword">false</span></span> === <span class="variable"><span class="variable">$arrRet</span></span>) {<span class="comment"><span class="comment">//异常逻辑处理</span></span>
            <span class="variable"><span class="variable">$arrErrorCodes</span></span> = Saf_Api_Server::getLastError();
            <span class="variable"><span class="variable">$arrErrNo</span></span> = array_keys(<span class="variable"><span class="variable">$arrErrorCodes</span></span>);
            <span class="variable"><span class="variable">$intErrNo</span></span> = <span class="variable"><span class="variable">$arrErrNo</span></span>[<span class="number"><span class="number">0</span></span>];
            <span class="variable"><span class="variable">$strErrMsg</span></span> = <span class="variable"><span class="variable">$arrErrorCodes</span></span>[<span class="variable"><span class="variable">$intErrNo</span></span>];
            <span class="keyword"><span class="keyword">if</span></span>(<span class="variable"><span class="variable">$intErrNo</span></span> == Saf_Api_Server:: METHOD_FAILED){
                <span class="variable"><span class="variable">$intErrNo</span></span> = Saf_Api_Server::getServiceError();
            }
            Bd_Log::warning(<span class="variable"><span class="variable">$strErrMsg</span></span>, <span class="variable"><span class="variable">$intErrNo</span></span>, <span class="variable"><span class="variable">$arrParams</span></span>);
            <span class="keyword"><span class="keyword">return</span></span> <span class="keyword"><span class="keyword">false</span></span>;
        } <span class="keyword"><span class="keyword">else</span></span> {
            <span class="comment"><span class="comment">//获取数据成功，正常逻辑处理</span></span>
            <span class="keyword"><span class="keyword">return</span></span> <span class="variable"><span class="variable">$arrRet</span></span>[<span class="string"><span class="string">'data'</span></span>];
        }
    }
}
</code></pre>

<p>第10行，和PageService层的Sample.php使用同样的方法得到了下一层——DAO层对应类的实例，getSample()、addSample()函数都是对DAO层提供接口的细粒度封装。</p>

<p>由于DataService层与DAO层的联系，我们可以将DAO层的Sample.php代码结合起来看：</p>

<pre><code class="php"><span class="preprocessor"><span class="preprocessor">&lt;?php</span></span>
<span class="comment"><span class="comment">/**
 *<span class="phpdoc"><span class="phpdoc"> @name</span></span> Dao_Sample
 *<span class="phpdoc"><span class="phpdoc"> @desc</span></span> sample dao, 可以访问数据库，文件，其它系统等
 *<span class="phpdoc"><span class="phpdoc"> @author</span></span> 何威(he_wei@baidu.com)
 */</span></span>
<span class="class"><span class="keyword"><span class="class"><span class="keyword">class</span></span></span><span class="class"> <span class="title"><span class="title">Dao_Sample</span></span> {</span></span>
    <span class="keyword"><span class="keyword">const</span></span> TABLE = <span class="string"><span class="string">'tblSample'</span></span>;
    <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">__construct</span></span><span class="params"><span class="params">()</span></span>{</span></span>
    }

    <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">getSampleById</span></span><span class="params"><span class="params">(<span class="variable"><span class="variable">$intId</span></span>, <span class="variable"><span class="variable">$arrFields</span></span> = null)</span></span>{</span></span>
        <span class="keyword"><span class="keyword">return</span></span> <span class="string"><span class="string">'GoodBye World!'</span></span>;
    }

    <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">addSample</span></span><span class="params"><span class="params">(<span class="variable"><span class="variable">$arrFields</span></span>)</span></span> {</span></span> 
        <span class="keyword"><span class="keyword">return</span></span> <span class="keyword"><span class="keyword">true</span></span>;
    }

    <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">updateSampleById</span></span><span class="params"><span class="params">(<span class="variable"><span class="variable">$intId</span></span>, <span class="variable"><span class="variable">$arrFields</span></span>)</span></span> {</span></span>
        <span class="keyword"><span class="keyword">return</span></span> <span class="keyword"><span class="keyword">true</span></span>;
    }

    <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">deleteSampleById</span></span><span class="params"><span class="params">(<span class="variable"><span class="variable">$intId</span></span>)</span></span> {</span></span>
        <span class="keyword"><span class="keyword">return</span></span> <span class="keyword"><span class="keyword">true</span></span>;
    }

    <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">getSampleListByConds</span></span><span class="params"><span class="params">(<span class="variable"><span class="variable">$arrConds</span></span>, <span class="variable"><span class="variable">$arrFields</span></span>, <span class="variable"><span class="variable">$intLimit</span></span>, <span class="variable"><span class="variable">$intOffset</span></span>, <span class="variable"><span class="variable">$arrOrderBy</span></span>)</span></span> {</span></span>
        <span class="keyword"><span class="keyword">return</span></span> <span class="keyword"><span class="keyword">true</span></span>;
    }
}
</code></pre>

<p>在DAO层Sample.php示例中大家可以看到方法的名字中出现了get、add、update、delete这些关键字，是不是觉得很熟悉呢？没错这些方法正是对应了数据库表的增删改查操作，只不过示例中的代码并没有实现，只是简单的返回了true或者字符串，关于DAO层结合数据库开发，我们将在接下来的章节里详细讲述，这里先介绍一下DAO层：</p>

<p>DAO也就是Data Access Object的简称。这一层在很多产品线也通常会叫做ORM或者DAL等。</p>

<p>通常来说，DAO这一层对应于具体的，无逻辑的数据操作。例如对于数据库来说，一个DAO通常对应于具体一张表上的增删改查操作（如果涉及到分表，则对应于一组表）。即一个DAO通常会有多个接口，每个接口对应一个具体这张表上的操作。</p>

<p>其实结合DataService层的代码还可以看到，DAO层提供的是最基础的调用接口，而传入接口的参数则是由DataService层相应的调用设置的。</p>

<p>现在大家已经对ODP中App开发的分层结构有了大体的了解，下面还要强调一下ODP App开发中最重要的一个强制性规范：</p>

<p>逻辑分层之间的调用关系，只能向后依赖，不能向前依赖或者跨层之间依赖。此次逻辑分层从前到后，依次为：Action、PageService、DataService、Dao。具体来说便是指，Dao不能依赖于DataService,PageService,Action；DataService不能依赖于PageService和Action；PageService不能依赖于Action。Action不能直接调用DataService，也不能直接调用Dao；PageService不能直接调用Dao。我们在开发中务必检查自己的分层代码是否符合这一规范，ODP环境也提供了layerproxy组件工具用于辅助我们来检查静态代码是否符合规范中分层调用的要求。</p>

<p>本章中的具体内容请参考《社区业务层规范》和《ODP App规范》两个文档。规范文档的 <a href="http://docs.babel.baidu.com/site/ksarch#page=1&amp;path=%2F%E5%90%84%E6%96%B9%E5%90%91%2FODP%2F%E8%A7%84%E8%8C%83%E4%B8%8E%E6%A8%A1%E5%BC%8F">下载地址</a> 为：</p>

            </div>
                <div class="bs-docs-section">
              <div class="page-header">
          <h1 id="数据库交互">数据库交互
            <a class="btn btn-edit btn-primary pull-right">
              <span class="glyphicon glyphicon-edit"></span> 编辑本段
            </a>
          </h1>
        </div>
                <h3>一、概述</h3>

<p>数据库是经常被使用到的技术，ODP环境对数据库的支持体现在提供了Bd_Db库，Bd_Db库是基础库中的一个组件，ODP环境的其他基础库在后面的章节中另行介绍，本章将结合app-cg生成的newapp示例，介绍ODP环境中数据库的使用。</p>

<h3>二、配置</h3>

<p>ODP环境中与数据库有关的配置文件放在ODP环境中conf目录下的db文件夹内。其中包含了两个文件global.conf与cluster.conf。global.conf文件中只是配置了一个全局的Hook类，用于在数据库Db对象初始化前触发，做一些初始化前的环境设置工作，而cluster.conf文件则是主要的数据库配置文件，对文件中的配置项，文件中的注释部分都已经给出了较详细的说明，这里我们来看一下那些我们必须配置的配置项：</p>

<table class="table table-striped table-bordered">
<thead>
<tr>
  <th>配置项</th>
  <th>说明</th>
  <th>示例值</th>
</tr>
</thead>
<tbody>
<tr>
  <td>username</td>
  <td>被连接数据库的用户名</td>
  <td>root</td>
</tr>
<tr>
  <td>password</td>
  <td>被连接数据库的密码</td>
  <td>Pass123(也可以为空)</td>
</tr>
<tr>
  <td>default_db</td>
  <td>指定链接的数据库名称</td>
  <td>newapp</td>
</tr>
<tr>
  <td>ip</td>
  <td>被连接数据库主机的IP地址</td>
  <td>10.46.135.28</td>
</tr>
<tr>
  <td>port</td>
  <td>被连接数据库的对外端口</td>
  <td>3305</td>
</tr>
</tbody>
</table>

<p>以上配置代表以root的身份连接10.46.135.28:3305机器上的newapp数据库。</p>

<p>newapp数据库只是一个示例的数据库，其中包含一张表user，相应的建表与初始化脚本如下:</p>

<pre><code class="sql"><span class="operator"><span class="keyword"><span class="operator"><span class="keyword">CREATE</span></span></span><span class="operator"> DATABASE <span class="string"><span class="string">`newapp`</span></span> ;</span></span>
USE `newapp`;
<span class="comment"><span class="comment">/*Table structure for table `user` */</span></span>
<span class="operator"><span class="keyword"><span class="operator"><span class="keyword">DROP</span></span></span><span class="operator"> <span class="keyword"><span class="keyword">TABLE</span></span> IF <span class="keyword"><span class="keyword">EXISTS</span></span> <span class="string"><span class="string">`user`</span></span>;</span></span>
<span class="operator"><span class="keyword"><span class="operator"><span class="keyword">CREATE</span></span></span><span class="operator"> <span class="keyword"><span class="keyword">TABLE</span></span> <span class="string"><span class="string">`user`</span></span> (
    <span class="string"><span class="string">`user_id`</span></span> <span class="keyword"><span class="keyword">int</span></span>(<span class="number"><span class="number">11</span></span>) unsigned <span class="keyword"><span class="keyword">NOT</span></span> <span class="keyword"><span class="keyword">NULL</span></span> AUTO_INCREMENT,
    <span class="string"><span class="string">`user_account`</span></span> varbinary(<span class="number"><span class="number">30</span></span>) <span class="keyword"><span class="keyword">NOT</span></span> <span class="keyword"><span class="keyword">NULL</span></span>,
    <span class="string"><span class="string">`user_name`</span></span> varbinary(<span class="number"><span class="number">30</span></span>) <span class="keyword"><span class="keyword">NOT</span></span> <span class="keyword"><span class="keyword">NULL</span></span>,
    <span class="keyword"><span class="keyword">PRIMARY</span></span> <span class="keyword"><span class="keyword">KEY</span></span> (<span class="string"><span class="string">`user_id`</span></span>)
) ENGINE=MyISAM AUTO_INCREMENT=<span class="number"><span class="number">2</span></span> <span class="keyword"><span class="keyword">DEFAULT</span></span> CHARSET=utf8 <span class="keyword"><span class="keyword">COLLATE</span></span>=utf8_unicode_ci;</span></span>
<span class="comment"><span class="comment">/*Data for the table `user` */</span></span>
<span class="operator"><span class="keyword"><span class="operator"><span class="keyword">insert</span></span></span><span class="operator">  <span class="keyword"><span class="keyword">into</span></span> <span class="string"><span class="string">`user`</span></span>(<span class="string"><span class="string">`user_id`</span></span>,<span class="string"><span class="string">`user_account`</span></span>,<span class="string"><span class="string">`user_name`</span></span>) <span class="keyword"><span class="keyword">values</span></span> (<span class="number"><span class="number">1</span></span>,<span class="string"><span class="string">'chenyijie'</span></span>,<span class="string"><span class="string">'Michael'</span></span>);</span></span>
<span class="operator"><span class="keyword"><span class="operator"><span class="keyword">insert</span></span></span><span class="operator">  <span class="keyword"><span class="keyword">into</span></span> <span class="string"><span class="string">`user`</span></span>(<span class="string"><span class="string">`user_id`</span></span>,<span class="string"><span class="string">`user_account`</span></span>,<span class="string"><span class="string">`user_name`</span></span>) <span class="keyword"><span class="keyword">values</span></span> (<span class="number"><span class="number">2</span></span>,<span class="string"><span class="string">'chenyijie'</span></span>,<span class="string"><span class="string">'CHEN Yijie'</span></span>);</span></span>
</code></pre>

<p>表结构如下：</p>

<pre><code class="sql">mysql&gt; <span class="operator"><span class="keyword"><span class="operator"><span class="keyword">select</span></span></span><span class="operator"> * <span class="keyword"><span class="keyword">from</span></span> <span class="keyword"><span class="keyword">user</span></span>;</span></span>
+<span class="comment"><span class="comment">---------+--------------+------------+</span></span>
| user_id | user_account | user_name  |
+<span class="comment"><span class="comment">---------+--------------+------------+</span></span>
|       1 | chenyijie    | Michael    |
|       2 | chenyijie    | CHEN Yijie |
+<span class="comment"><span class="comment">---------+--------------+------------+</span></span>
</code></pre>

<h3>三、数据库交互示例</h3>

<p>接下来我们在ODP环境的app/newapp/script目录下创建一个Base.php的文件用于编写Bd_Db库的使用代码。使用Bd_Db库，首先我们需要查看《PHP
DB库接口文档》，这个文档的下载地址如下：</p>

<p>http://docs.babel.baidu.com/doc/a9324fff-adc9-41f3-9ee8-43a40b80748a</p>

<p>下面我们对《PHP DB库接口文档》中提到的select、selectCount、insert、getInsertID、update、delete这六个最常用的接口的使用进行具体的演示。</p>

<p>Base.php文件内容如下：</p>

<pre><code class="php"><span class="preprocessor"><span class="preprocessor">&lt;?php</span></span>
<span class="class"><span class="keyword"><span class="class"><span class="keyword">class</span></span></span><span class="class"> <span class="title"><span class="title">Base</span></span> {</span></span>
    <span class="keyword"><span class="keyword">private</span></span> <span class="variable"><span class="variable">$_db</span></span> = <span class="keyword"><span class="keyword">null</span></span>;

    <span class="comment"><span class="comment">/*
    * 构造函数
    *
    *<span class="phpdoc"><span class="phpdoc"> @return</span></span>  成功：  _db连接对象
    *          失败：  返回false
    **/</span></span>
    <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">__construct</span></span><span class="params"><span class="params">()</span></span> {</span></span>
        <span class="variable"><span class="variable">$this</span></span>-&gt;_db = Bd_Db_ConnMgr::getConn(<span class="string"><span class="string">'ClusterOne'</span></span>);
    }
    <span class="comment"><span class="comment">/*
     * 插入记录
     *
     *<span class="phpdoc"><span class="phpdoc"> @return</span></span> 成功： 影响行数  失败： 返回false
    **/</span></span>
    <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">insert</span></span><span class="params"><span class="params">(<span class="variable"><span class="variable">$tbl</span></span>, <span class="variable"><span class="variable">$row</span></span>, <span class="variable"><span class="variable">$options</span></span>=NULL, <span class="variable"><span class="variable">$onDup</span></span>=NULL)</span></span> {</span></span>
        <span class="variable"><span class="variable">$ret</span></span> = <span class="variable"><span class="variable">$this</span></span>-&gt;_db-&gt;insert(<span class="variable"><span class="variable">$tbl</span></span>, <span class="variable"><span class="variable">$row</span></span>, <span class="variable"><span class="variable">$options</span></span>, <span class="variable"><span class="variable">$onDup</span></span>);
        <span class="keyword"><span class="keyword">return</span></span> <span class="variable"><span class="variable">$ret</span></span>;
    }
    <span class="comment"><span class="comment">/*
     * 删除记录
     *
     *<span class="phpdoc"><span class="phpdoc"> @return</span></span> 成功： 影响行数
     * 失败： 返回false
    **/</span></span>
    <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">delete</span></span><span class="params"><span class="params">(<span class="variable"><span class="variable">$tbl</span></span>, <span class="variable"><span class="variable">$conds</span></span>=NULL, <span class="variable"><span class="variable">$options</span></span>=NULL, <span class="variable"><span class="variable">$appends</span></span>=NULL)</span></span> {</span></span>
        <span class="variable"><span class="variable">$ret</span></span> = <span class="variable"><span class="variable">$this</span></span>-&gt;_db-&gt;delete(<span class="variable"><span class="variable">$tbl</span></span>, <span class="variable"><span class="variable">$conds</span></span>, <span class="variable"><span class="variable">$options</span></span>, <span class="variable"><span class="variable">$appends</span></span>);
        <span class="keyword"><span class="keyword">return</span></span> <span class="variable"><span class="variable">$ret</span></span>;
    }
    <span class="comment"><span class="comment">/*
     * 更新记录
     *
     *<span class="phpdoc"><span class="phpdoc"> @return</span></span> 成功： 影响行数
     * 失败： 返回false
    **/</span></span>
    <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">update</span></span><span class="params"><span class="params">(<span class="variable"><span class="variable">$tbl</span></span>, <span class="variable"><span class="variable">$row</span></span>, <span class="variable"><span class="variable">$conds</span></span>=NULL, <span class="variable"><span class="variable">$options</span></span>=NULL, <span class="variable"><span class="variable">$appends</span></span>=NULL)</span></span> {</span></span>
        <span class="variable"><span class="variable">$ret</span></span> = <span class="variable"><span class="variable">$this</span></span>-&gt;_db-&gt;update(<span class="variable"><span class="variable">$tbl</span></span>, <span class="variable"><span class="variable">$row</span></span>, <span class="variable"><span class="variable">$conds</span></span>, <span class="variable"><span class="variable">$options</span></span>, <span class="variable"><span class="variable">$appends</span></span>);
        <span class="keyword"><span class="keyword">return</span></span> <span class="variable"><span class="variable">$ret</span></span>;
    }

    <span class="comment"><span class="comment">/*
     * 查询记录
     *
     *<span class="phpdoc"><span class="phpdoc"> @return</span></span> 成功：查询结果
     * 失败： 返回false
     **/</span></span>
    <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">select</span></span><span class="params"><span class="params">(<span class="variable"><span class="variable">$tbl</span></span>, <span class="variable"><span class="variable">$fields</span></span>, <span class="variable"><span class="variable">$conds</span></span>=NULL, <span class="variable"><span class="variable">$options</span></span>=NULL, <span class="variable"><span class="variable">$appends</span></span>=NULL,
                        <span class="variable"><span class="variable">$fetchType</span></span>=Bd_DB::FETCH_ASSOC, <span class="variable"><span class="variable">$bolUseResult</span></span>=false)</span></span> {</span></span>
        <span class="variable"><span class="variable">$ret</span></span> = <span class="variable"><span class="variable">$this</span></span>-&gt;_db-&gt;select(<span class="variable"><span class="variable">$tbl</span></span>, <span class="variable"><span class="variable">$fields</span></span>, <span class="variable"><span class="variable">$conds</span></span>, <span class="variable"><span class="variable">$options</span></span>, <span class="variable"><span class="variable">$appends</span></span>, <span class="variable"><span class="variable">$fetchType</span></span>, <span class="variable"><span class="variable">$bolUseResult</span></span>);
        <span class="keyword"><span class="keyword">return</span></span> <span class="variable"><span class="variable">$ret</span></span>;
    }

    <span class="comment"><span class="comment">/*
     * 查询记录总数
     *
     *<span class="phpdoc"><span class="phpdoc"> @return</span></span> 成功： 记录总数 66
     * 失败： 返回false
     **/</span></span>
    <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">selectCount</span></span><span class="params"><span class="params">(<span class="variable"><span class="variable">$tbl</span></span>, <span class="variable"><span class="variable">$conds</span></span>=NULL, <span class="variable"><span class="variable">$options</span></span>=NULL, <span class="variable"><span class="variable">$appends</span></span>=NULL)</span></span> {</span></span>
        <span class="variable"><span class="variable">$ret</span></span> = <span class="variable"><span class="variable">$this</span></span>-&gt;_db-&gt;selectCount(<span class="variable"><span class="variable">$tbl</span></span>, <span class="variable"><span class="variable">$conds</span></span>, <span class="variable"><span class="variable">$options</span></span>, <span class="variable"><span class="variable">$appends</span></span>);
        <span class="keyword"><span class="keyword">return</span></span> <span class="variable"><span class="variable">$ret</span></span>;
    }

    <span class="comment"><span class="comment">/*
     * 获取刚插入记录id
     *
     *<span class="phpdoc"><span class="phpdoc"> @return</span></span> 成功： 新记录ID
     * 失败： 返回false
     **/</span></span>

    <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">getInsertID</span></span><span class="params"><span class="params">()</span></span> {</span></span>
        <span class="variable"><span class="variable">$ret</span></span> = <span class="variable"><span class="variable">$this</span></span>-&gt;_db-&gt;getInsertID();
        <span class="keyword"><span class="keyword">return</span></span> <span class="variable"><span class="variable">$ret</span></span>;
    }
}
<span class="comment"><span class="comment">//必须使用init组件的init()函数来初始化ODP环境，否则无法使用基础库及其他组件库。</span></span>
Bd_Init::init(); 
<span class="variable"><span class="variable">$dbTest</span></span> = <span class="keyword"><span class="keyword">new</span></span> Base();

<span class="preprocessor"><span class="preprocessor">?&gt;</span></span>
</code></pre>

<p>在 Base 类的构造函数中，第12行，我们使用 Bd_Db_ConnMgr 类提供的 getConn 静态函数来获得一个数据库的连接对象 getConn 函数传入的参数便是我们在db目录下的 <code>cluster.conf</code> 文件中配置的组名字，getConn函数会自动读取这个组名字下的配置，来初始化db连接对象。<code>cluster.conf</code> 位于 {ODP_ROOT_PATH}/conf/db/。<code>cluster.conf</code> 文件内容如下：</p>

<pre><code class="ruby"><span class="comment"><span class="comment">#################</span></span>
<span class="comment"><span class="comment"># DB库的示例配置</span></span>
<span class="comment"><span class="comment">#################</span></span>

<span class="comment"><span class="comment"># 集群配置1，组与名称相同</span></span>

[<span class="constant"><span class="constant">ClusterOne</span></span>]

<span class="comment"><span class="comment"># 名称</span></span>
cluster_name <span class="symbol"><span class="symbol">:</span></span> <span class="constant"><span class="constant">ClusterOne</span></span>
<span class="comment"><span class="comment"># 连接超时，毫秒级，但暂不支持毫秒，此处向上取整</span></span>
<span class="comment"><span class="comment"># 900ms 取整为 1s</span></span>
connect_timeout_ms <span class="symbol"><span class="symbol">:</span></span> <span class="number"><span class="number">900</span></span>

<span class="comment"><span class="comment"># 当某台机器被标为故障后，将其封禁的时间，单位是秒</span></span>
<span class="comment"><span class="comment"># 留空表示不封禁故障主机，因此也不会记录相关信息，性能有微小提高</span></span>
retry_interval_s <span class="symbol"><span class="symbol">:</span></span> <span class="number"><span class="number">20</span></span>
<span class="comment"><span class="comment"># 负载均衡选择器类名，留空表示使用默认的随机选择器</span></span>
balance_strategy <span class="symbol"><span class="symbol">:</span></span>

<span class="comment"><span class="comment">#登录MySql的用户名和密码</span></span>
username <span class="symbol"><span class="symbol">:</span></span> <span class="constant"><span class="constant">XXXXX</span></span>
password <span class="symbol"><span class="symbol">:</span></span> <span class="constant"><span class="constant">XXXXX</span></span> 

<span class="comment"><span class="comment">#默认数据库</span></span>
default_db <span class="symbol"><span class="symbol">:</span></span> newapp
<span class="comment"><span class="comment"># MySql连接标识，参见mysqli_options()的参数说明</span></span>
connect_flag <span class="symbol"><span class="symbol">:</span></span> <span class="constant"><span class="constant">MYSQLI_CLIENT_COMPRESS</span></span> | <span class="constant"><span class="constant">MYSQLI_CLIENT_FOUND_ROWS</span></span>
<span class="comment"><span class="comment"># 钩子，留空表示无需钩子</span></span>
<span class="comment"><span class="comment"># 钩子的使用参见Bd_DB库的手册</span></span>
<span class="comment"><span class="comment"># 查询前钩子</span></span>
hook_before_query <span class="symbol"><span class="symbol">:</span></span>
<span class="comment"><span class="comment"># 查询后钩子</span></span>
hook_after_query <span class="symbol"><span class="symbol">:</span></span>
<span class="comment"><span class="comment"># 失败处理钩子</span></span>
hook_on_fail <span class="symbol"><span class="symbol">:</span></span>
<span class="comment"><span class="comment"># 连接失败处理钩子</span></span>
hook_on_connect_fail <span class="symbol"><span class="symbol">:</span></span>
<span class="comment"><span class="comment">#主机信息数组</span></span>
[.<span class="variable"><span class="variable">@host</span></span>]
ip <span class="symbol"><span class="symbol">:</span></span> <span class="number"><span class="number">10.46</span></span>.<span class="number"><span class="number">135.28</span></span>
port <span class="symbol"><span class="symbol">:</span></span> <span class="number"><span class="number">3306</span></span>
</code></pre>

<p>大家可以根据以上的配置修改默认的cluster.conf文件内容</p>

<p>对各接口中出现的参数在《PHP_DB库接口文档》中有如下的解释及使用示例：</p>

<pre><code class="bash"><span class="variable"><span class="variable">$tables</span></span> 数据表列表，可以是数组或者字符串
<span class="variable"><span class="variable">$fields</span></span> 字段列表，可以是数组或者字符串
<span class="variable"><span class="variable">$conds</span></span> 条件列表，可以是数组或者字符串
<span class="variable"><span class="variable">$options</span></span> 选项列表，可以是数组或者字符串
<span class="variable"><span class="variable">$appends</span></span> 结尾操作列表，可以是数组或者字符串
</code></pre>

<p>说明：</p>

<p>tables数组用于构建FROM子句，每个元素是一张表，比如：</p>

<pre><code class="php"><span class="variable"><span class="variable">$tables</span></span> = <span class="keyword"><span class="keyword">array</span></span>(
    <span class="string"><span class="string">'user as a'</span></span>,
    <span class="string"><span class="string">'order as b'</span></span>
);
</code></pre>

<p>fields数组用于构建SELECT子句，每个元素是一个字段，比如：</p>

<pre><code class="php"><span class="variable"><span class="variable">$fields</span></span> = <span class="keyword"><span class="keyword">array</span></span>(
    <span class="string"><span class="string">'a.id as uid'</span></span>,
    <span class="string"><span class="string">'a.name as uname'</span></span>,
    <span class="string"><span class="string">'b.id as oid'</span></span>
);
</code></pre>

<p>conds数组用于构建WHERE子句，每个元素是一个条件，使用AND进行拼接。如果某元素是key-value型，则会根据value的类型进行自动转码，比如：</p>

<pre><code class="php"><span class="variable"><span class="variable">$conds</span></span> = <span class="keyword"><span class="keyword">array</span></span>(
    <span class="string"><span class="string">'a.name = '</span></span> =&gt; <span class="string"><span class="string">'Robin Li'</span></span>, <span class="comment"><span class="comment">// 字符串，自动转码并加引号</span></span>
    <span class="string"><span class="string">'b.id &gt;'</span></span> =&gt; <span class="number"><span class="number">1000</span></span>,          <span class="comment"><span class="comment">// 数字，不作处理</span></span>
    <span class="string"><span class="string">'b.isok != '</span></span> =&gt; <span class="keyword"><span class="keyword">NULL</span></span>,      <span class="comment"><span class="comment">// NULL</span></span>
    <span class="string"><span class="string">'b.count &gt; 100'</span></span>            <span class="comment"><span class="comment">// 非key-value型</span></span>
);
</code></pre>

<p>options数组用于设置SQL的前置选项，具体选项参见MySQL手册，比如：</p>

<pre><code class="php"><span class="variable"><span class="variable">$option</span></span> = <span class="keyword"><span class="keyword">array</span></span>(
    <span class="string"><span class="string">'DISTINCT'</span></span>,
    <span class="string"><span class="string">'SQL_NO_CACHE'</span></span>
);
</code></pre>

<p>appends数组用于设置SQL的后置操作，具体选项参见MySQL手册，比如：</p>

<pre><code class="php"><span class="variable"><span class="variable">$appends</span></span> = <span class="keyword"><span class="keyword">array</span></span>(
    <span class="string"><span class="string">'ORDER BY b.id'</span></span>,
    <span class="string"><span class="string">'LIMIT 5'</span></span>
);
</code></pre>

<p>下面来看看怎样在Base.php中通过这些参数的传递获得我们想要的数据库的操作。</p>

<p>对Base类的select接口的使用在Base.php文件后面（？&gt;之前）添加如下代码：</p>

<pre><code class="php"><span class="variable"><span class="variable">$param</span></span> = <span class="keyword"><span class="keyword">array</span></span>(
   <span class="string"><span class="string">'fields'</span></span>  =&gt; <span class="keyword"><span class="keyword">array</span></span>(<span class="string"><span class="string">'*'</span></span>,),
   <span class="comment"><span class="comment">//或者在array中传入列名比如array('user_id', 'user_account', 'user_name'),</span></span>
);
<span class="variable"><span class="variable">$result_select</span></span> = <span class="variable"><span class="variable">$dbTest</span></span>-&gt;select(<span class="string"><span class="string">'user'</span></span>, <span class="variable"><span class="variable">$param</span></span>[<span class="string"><span class="string">'fields'</span></span>],
<span class="variable"><span class="variable">$param</span></span>[<span class="string"><span class="string">'conds'</span></span>],<span class="variable"><span class="variable">$param</span></span>[<span class="string"><span class="string">'options'</span></span>],<span class="variable"><span class="variable">$param</span></span>[<span class="string"><span class="string">'appends'</span></span>]);
var_dump(<span class="variable"><span class="variable">$result_select</span></span>);
</code></pre>

<p>对select接口调用的结果如下：</p>

<pre><code class="php"><span class="keyword"><span class="keyword">array</span></span>(<span class="number"><span class="number">2</span></span>) {
    [<span class="number"><span class="number">0</span></span>]=&gt;
    <span class="keyword"><span class="keyword">array</span></span>(<span class="number"><span class="number">3</span></span>) {
        [<span class="string"><span class="string">"user_id"</span></span>]=&gt;
        string(<span class="number"><span class="number">1</span></span>) <span class="string"><span class="string">"1"</span></span>
        [<span class="string"><span class="string">"user_account"</span></span>]=&gt;
        string(<span class="number"><span class="number">9</span></span>) <span class="string"><span class="string">"chenyijie"</span></span>
        [<span class="string"><span class="string">"user_name"</span></span>]=&gt;
        string(<span class="number"><span class="number">7</span></span>) <span class="string"><span class="string">"Michael"</span></span>
    }
    [<span class="number"><span class="number">1</span></span>]=&gt;
    <span class="keyword"><span class="keyword">array</span></span>(<span class="number"><span class="number">3</span></span>) {
        [<span class="string"><span class="string">"user_id"</span></span>]=&gt;
        string(<span class="number"><span class="number">1</span></span>) <span class="string"><span class="string">"2"</span></span>
        [<span class="string"><span class="string">"user_account"</span></span>]=&gt;
        string(<span class="number"><span class="number">9</span></span>) <span class="string"><span class="string">"chenyijie"</span></span>
        [<span class="string"><span class="string">"user_name"</span></span>]=&gt;
        string(<span class="number"><span class="number">10</span></span>) <span class="string"><span class="string">"CHEN Yijie"</span></span>
    }

}
</code></pre>

<p>对Base类的selectCount接口的使用在Base.php文件后面（?&gt;之前）添加如下代码：</p>

<pre><code class="perl">echo <span class="string"><span class="string">"selectCount Function Examplen"</span></span>;
<span class="variable"><span class="variable">$result_selectCount</span></span> = <span class="variable"><span class="variable">$dbTest</span></span>-&gt;selectCount(<span class="string"><span class="string">'user'</span></span>);
var_dump(<span class="variable"><span class="variable">$result_selectCount</span></span>);
</code></pre>

<p>对selectCount接口调用的结果如下：</p>

<pre><code class="php">selectCount <span class="function"><span class="keyword"><span class="function"><span class="keyword">Function</span></span></span><span class="function"> <span class="title"><span class="title">Example</span></span>
<span class="title"><span class="title">int</span></span><span class="params"><span class="params">(<span class="number"><span class="number">2</span></span>)</span></span>
</span></span></code></pre>

<p>因为目前只有数据库里初始的两条数据，因此返回值为int(2)。</p>

<p>对Base类的insert接口的使用在Base.php文件后面（？&gt;之前）添加如下代码：</p>

<pre><code class="php"><span class="variable"><span class="variable">$user_array</span></span> = <span class="keyword"><span class="keyword">array</span></span>(
    <span class="string"><span class="string">'user_account'</span></span>    =&gt; <span class="string"><span class="string">'chenyijie'</span></span>,
    <span class="string"><span class="string">'user_name'</span></span>       =&gt; <span class="string"><span class="string">'CHENYIJIE'</span></span>,
);
<span class="variable"><span class="variable">$result_insert</span></span> = <span class="variable"><span class="variable">$dbTest</span></span>-&gt;insert(<span class="string"><span class="string">'user'</span></span>, <span class="variable"><span class="variable">$user_array</span></span>);
<span class="keyword"><span class="keyword">echo</span></span> <span class="string"><span class="string">"insert Function Examplen"</span></span>;
var_dump(<span class="variable"><span class="variable">$result_insert</span></span>);
</code></pre>

<p>对insert接口调用的结果如下：</p>

<pre><code class="php">insert <span class="function"><span class="keyword"><span class="function"><span class="keyword">Function</span></span></span><span class="function"> <span class="title"><span class="title">Example</span></span>
<span class="title"><span class="title">int</span></span><span class="params"><span class="params">(<span class="number"><span class="number">1</span></span>)</span></span>
</span></span></code></pre>

<p>让我们来看一下数据库中是否成功插入了：</p>

<pre><code class="sql">mysql&gt; <span class="operator"><span class="keyword"><span class="operator"><span class="keyword">select</span></span></span><span class="operator"> * <span class="keyword"><span class="keyword">from</span></span> <span class="keyword"><span class="keyword">user</span></span>;</span></span>
+<span class="comment"><span class="comment">---------+--------------+------------+</span></span>
| user_id | user_account | user+name  |
+<span class="comment"><span class="comment">---------+--------------+------------+</span></span>
|       1 | chenyijie    | Michael    |
|       2 | chenyijie    | CHEN Yijie |
|       3 | chenyijie    | CHENYIJIE  |
+<span class="comment"><span class="comment">---------+--------------+------------+</span></span>
</code></pre>

<p>对Base类的insert接口的使用在Base.php文件后面（？&gt;之前）添加如下代码：</p>

<pre><code class="perl"><span class="variable"><span class="variable">$result_getInsertID</span></span> = <span class="variable"><span class="variable">$dbTest</span></span>-&gt;getInsertID();
echo <span class="string"><span class="string">"getInsertID Function Examplen"</span></span>;
var_dump(<span class="variable"><span class="variable">$result_getInsertID</span></span>);
</code></pre>

<p>对getInsertID接口调用的结果如下：</p>

<pre><code class="php">getInsertID <span class="function"><span class="keyword"><span class="function"><span class="keyword">Function</span></span></span><span class="function"> <span class="title"><span class="title">Example</span></span>
<span class="title"><span class="title">int</span></span><span class="params"><span class="params">(<span class="number"><span class="number">3</span></span>)</span></span>
</span></span></code></pre>

<p>对Base类的update接口的使用在Base.php文件后面（？&gt;之前）添加如下代码：</p>

<pre><code class="php"><span class="variable"><span class="variable">$conds</span></span> = <span class="keyword"><span class="keyword">array</span></span>(
    <span class="string"><span class="string">'user_id='</span></span> =&gt; <span class="string"><span class="string">'3'</span></span>,
);
<span class="variable"><span class="variable">$update_arr</span></span> = <span class="keyword"><span class="keyword">array</span></span>(
    <span class="string"><span class="string">'user_name'</span></span>   =&gt; <span class="string"><span class="string">'CCCCCCCCCCC'</span></span>,
);
<span class="variable"><span class="variable">$result_update</span></span> = <span class="variable"><span class="variable">$dbTest</span></span>-&gt;update(<span class="string"><span class="string">'user'</span></span>, <span class="variable"><span class="variable">$update_arr</span></span>, <span class="variable"><span class="variable">$conds</span></span>);
<span class="keyword"><span class="keyword">echo</span></span> <span class="string"><span class="string">"update Function Examplen"</span></span>;
var_dump(<span class="variable"><span class="variable">$result_update</span></span>);
</code></pre>

<p>对update接口调用的结果如下：</p>

<pre><code class="php">update <span class="function"><span class="keyword"><span class="function"><span class="keyword">Function</span></span></span><span class="function"> <span class="title"><span class="title">Example</span></span>
<span class="title"><span class="title">int</span></span><span class="params"><span class="params">(<span class="number"><span class="number">1</span></span>)</span></span>
</span></span></code></pre>

<p>让我们来看一下数据库中的结果：</p>

<pre><code class="sql">mysql&gt; <span class="operator"><span class="keyword"><span class="operator"><span class="keyword">select</span></span></span><span class="operator"> * <span class="keyword"><span class="keyword">from</span></span> <span class="keyword"><span class="keyword">user</span></span>;</span></span>
+<span class="comment"><span class="comment">---------+--------------+-------------+</span></span>
| user_id | user_account | user_name   |
+<span class="comment"><span class="comment">---------+--------------+-------------+</span></span>
|       1 | chenyijie    | Michael     |
|       2 | chenyijie    | CHEN Yijie  |
|       3 | chenyijie    | CCCCCCCCCCC |
+<span class="comment"><span class="comment">---------+--------------+-------------+</span></span>
</code></pre>

<p>对Base类的delete接口的使用在Base.php文件后面（？&gt;之前）添加如下代码：</p>

<pre><code class="php"><span class="variable"><span class="variable">$conds</span></span> = <span class="keyword"><span class="keyword">array</span></span>(
    <span class="string"><span class="string">'user_id='</span></span> =&gt; <span class="string"><span class="string">'3'</span></span>,
);
<span class="variable"><span class="variable">$result_delete</span></span> = <span class="variable"><span class="variable">$dbTest</span></span>-&gt;delete(<span class="string"><span class="string">'user'</span></span>, <span class="variable"><span class="variable">$conds</span></span>);
<span class="keyword"><span class="keyword">echo</span></span> <span class="string"><span class="string">"delete Function Examplen"</span></span>;
var_dump(<span class="variable"><span class="variable">$result_delete</span></span>);
</code></pre>

<p>对delete接口调用的结果如下：</p>

<pre><code class="php">delete <span class="function"><span class="keyword"><span class="function"><span class="keyword">Function</span></span></span><span class="function"> <span class="title"><span class="title">Example</span></span>
<span class="title"><span class="title">int</span></span><span class="params"><span class="params">(<span class="number"><span class="number">1</span></span>)</span></span>
</span></span></code></pre>

<p>让我们来看一下数据库中的结果：</p>

<pre><code class="sql">mysql&gt; <span class="operator"><span class="keyword"><span class="operator"><span class="keyword">select</span></span></span><span class="operator"> * <span class="keyword"><span class="keyword">from</span></span> <span class="keyword"><span class="keyword">user</span></span>;</span></span>
+<span class="comment"><span class="comment">---------+--------------+------------+</span></span>
| user_id | user_account | user+name  |
+<span class="comment"><span class="comment">---------+--------------+------------+</span></span>
|       1 | chenyijie    | Michael    |
|       2 | chenyijie    | CHEN Yijie |
+<span class="comment"><span class="comment">---------+--------------+------------+</span></span>
</code></pre>

<p>对于BD_Db库提供的其他接口的使用请参考 <a href="http://docs.babel.baidu.com/doc/a9324fff-adc9-41f3-9ee8-43a40b80748a">PHP_DB库接口文档</a> 及手册平台 <a href="http://man.baidu.com/inf/odp/lib/db">Bd_Db库</a> 的介绍。</p>

            </div>
                <div class="bs-docs-section">
              <div class="page-header">
          <h1 id="SAF框架">SAF 框架
            <a class="btn btn-edit btn-primary pull-right">
              <span class="glyphicon glyphicon-edit"></span> 编辑本段
            </a>
          </h1>
        </div>
                <h3>一、概述</h3>

<p>SAF是ODP环境提供的业务层框架，SAF框架建立的目的是为了把业务逻辑开发过程中一些共性的问题抽取出来，并提供统一的解决方案。SAF框架包含控制器组件，通用业务组件（参数处理，session处理，日志打印等）以及通用配置组件。</p>

<p>可以将SAF框架理解为一个工具库，SAF为我们提供了很多的通用功能例如验证用户的登录信息，接收用户提交的数据，更改用户的信息，记录用户的操作行为等。</p>

<h3>二、配置</h3>

<p>针对一个ODP环境中的app来说, SAF框架的配置文件分为两个部分。</p>

<p>一部分为当前ODP环境下所有app所共享的全局配置文件，对应ODP环境conf目录下的saf.conf文件。</p>

<p>另一部分为app所独有的配置文件，其中的部分配置会覆盖saf.conf文件中的配置,以newapp为例，对应ODP环境conf目录下的/app/newapp/global.conf中或./odp/conf/app/newapp.conf配置中除api_lib配置项, 只有全局配置生效外, 其他配置项均可以在app的配置中进行配置,app域的配置将覆盖全局配置。</p>

<p>saf.conf全局配置中hook_name定义了全局钩子函数，app配置中的hook_name可定义app钩子函数.执行顺序为先执行全局钩子函数再执行app钩子函数。</p>

<p>我们先看一个SAF全局配置的例子（odp/conf/saf.conf）:</p>

<pre><code class="php"><span class="comment"><span class="comment">#SESSION类型为SESSION1</span></span>
session_type:<span class="number"><span class="number">1</span></span>
<span class="comment"><span class="comment">#passport存储长度，默认32</span></span>
passport_save_len:<span class="number"><span class="number">128</span></span>

<span class="comment"><span class="comment">#需要转为GB2312</span></span>
cgi_oe:GB2312
<span class="comment"><span class="comment">#接收CGI为UTF-8格式</span></span>
cgi_ie:UTF-<span class="number"><span class="number">8</span></span>

<span class="comment"><span class="comment">#通用流程配置，支持session可裁剪，值为0和1，不配置则默认为1，表示不被裁剪掉</span></span>
[action]
session : <span class="number"><span class="number">1</span></span>

<span class="comment"><span class="comment">#以上配置项支持APP域的配置，App域配置将覆盖全局配置</span></span>
[<span class="keyword"><span class="keyword">GLOBAL</span></span>]
<span class="comment"><span class="comment">#自定义钩子名称</span></span>
<span class="comment"><span class="comment">#支持App域配置，先执行全局Hook，再执行App的Hook</span></span>
hook_name:Saf_Base_Testhook
<span class="comment"><span class="comment">#产品线需要修改这里的配置</span></span>
<span class="comment"><span class="comment">#改为产品线的基础库名</span></span>
api_lib:wiki
</code></pre>

<table class="table table-striped table-bordered">
<thead>
<tr>
  <th>项目</th>
  <th>含义</th>
</tr>
</thead>
<tbody>
<tr>
  <td>cgi_oe/cgi_ie</td>
  <td>为cgi进行自动转码, 如不需要统一转将这两行配置码注释掉即可</td>
</tr>
<tr>
  <td>action</td>
  <td>配置每个请求需要处理的流程 e.g. 当前环境不需要session服务,所以将其设置为0(cgi: 进行统一参数校验, session: 进行统一session处理,log: 统一notice日志打印)</td>
</tr>
<tr>
  <td>GLOBAL hook_name</td>
  <td>填写全局Hook的类名, ODP环境下请求都会执行的钩子函数(后续详细讲解)</td>
</tr>
<tr>
  <td>Api_lib</td>
  <td>产品线phplib的前缀, 跨系统api调用时标记产品线前缀用</td>
</tr>
</tbody>
</table>

<p>再来看一个app配置的例子(odp/conf/app/newapp/global.conf文件中saf配置写在[saf]项下即可):</p>

<pre><code class="css"><span class="attr_selector"><span class="attr_selector">[ap]</span></span>
<span class="tag"><span class="tag">modules</span></span><span class="pseudo"><span class="pseudo">:Main</span></span>
<span class="attr_selector"><span class="attr_selector">[.library]</span></span>
<span class="tag"><span class="tag">namespace</span></span>: <span class="tag"><span class="tag">Newapp</span></span>
<span class="attr_selector"><span class="attr_selector">[service]</span></span>
<span class="attr_selector"><span class="attr_selector">[.app_newapp]</span></span>
#默认是本地<span class="tag"><span class="tag">php</span></span>调用，如果改成<span class="tag"><span class="tag">http</span></span>, 请添加相关<span class="tag"><span class="tag">ral</span></span> <span class="tag"><span class="tag">service</span></span>配置
<span class="tag"><span class="tag">proxy</span></span> : <span class="tag"><span class="tag">php</span></span>

<span class="attr_selector"><span class="attr_selector">[sample]</span></span>
<span class="tag"><span class="tag">msg</span></span>: <span class="tag"><span class="tag">GoodBye</span></span> <span class="tag"><span class="tag">World</span></span>!(<span class="tag"><span class="tag">from</span></span> <span class="tag"><span class="tag">conf</span></span>)
<span class="attr_selector"><span class="attr_selector">[saf]</span></span>
<span class="tag"><span class="tag">hook_name</span></span>: <span class="tag"><span class="tag">Newapp_Hook</span></span>
<span class="attr_selector"><span class="attr_selector">[.action]</span></span>
<span class="tag"><span class="tag">cgi</span></span>: 1
<span class="tag"><span class="tag">session</span></span>: 1
<span class="tag"><span class="tag">log</span></span>: 1
</code></pre>

<p>其中14-19行是我们自己手动添加的newapp这个app和SAF有关的配置，配置中</p>

<table class="table table-striped table-bordered">
<thead>
<tr>
  <th>项目</th>
  <th>含义</th>
</tr>
</thead>
<tbody>
<tr>
  <td>hook_name</td>
  <td>填写对应钩子的类名,全局钩子执行后会执行app钩子(钩子相关后续章节会详细讲解)</td>
</tr>
<tr>
  <td>action</td>
  <td>覆盖全局action配置 e.g.当前app需要session流程用来检查登陆信息,所以将其设为1</td>
</tr>
</tbody>
</table>

<h3>三、接口调用</h3>

<p>SAF框架中的接口使用了统一的静态调用方式, 一旦ODP Init组件的Bd_Init::init()函数执行完成，便可以对SAF框架的接口进行调用，以newapp为例，在前面也提到了webroot/newapp/index.php文件，对于ODP环境中的app来说，Bd_Init::init()函数便是在这个文件中被执行的，因此，我们得以在ODP app 的models目录下的代码中使用SAF框架提供的一系列静态函数。</p>

<p>下面以newapp为例，使用一些常用的例子来作说明,完整SAF框架的接口文档请参考手册平台（man.baidu.com）上ODP手册中的相关文档。</p>

<ol>
<li>获取”登陆用户信息” &amp;&amp; 获取cgi(GET POST)数据</li>
</ol>

<p>(actions/Sample.php)</p>

<pre><code class="php"><span class="number"><span class="number">7</span></span>  <span class="class"><span class="keyword"><span class="class"><span class="keyword">class</span></span></span><span class="class"> <span class="title"><span class="title">Action_Sample</span></span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title"><span class="title">Ap_Action_Abstract</span></span> {</span></span>
<span class="number"><span class="number">8</span></span>  
<span class="number"><span class="number">9</span></span>      <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">execute</span></span><span class="params"><span class="params">()</span></span> {</span></span>
<span class="number"><span class="number">10</span></span>         <span class="comment"><span class="comment">//1. check if user is login as needed</span></span>
<span class="number"><span class="number">11</span></span>         <span class="variable"><span class="variable">$arrUserinfo</span></span> = Saf_SmartMain::getUserInfo();
<span class="number"><span class="number">12</span></span>         <span class="keyword"><span class="keyword">if</span></span> (<span class="keyword"><span class="keyword">empty</span></span>(<span class="variable"><span class="variable">$arrUserinfo</span></span>)) {
<span class="number"><span class="number">13</span></span>             <span class="comment"><span class="comment">//ouput error</span></span>
<span class="number"><span class="number">14</span></span>         }
<span class="number"><span class="number">15</span></span>
<span class="number"><span class="number">16</span></span>         <span class="comment"><span class="comment">//2. get and validate input params</span></span>
<span class="number"><span class="number">17</span></span>         <span class="variable"><span class="variable">$arrRequest</span></span> = Saf_SmartMain::getCgi();
<span class="number"><span class="number">18</span></span>         <span class="variable"><span class="variable">$arrInput</span></span> = <span class="variable"><span class="variable">$arrRequest</span></span>[<span class="string"><span class="string">'get'</span></span>];
<span class="number"><span class="number">19</span></span>         <span class="keyword"><span class="keyword">if</span></span>(!<span class="keyword"><span class="keyword">isset</span></span>(<span class="variable"><span class="variable">$arrInput</span></span>[<span class="string"><span class="string">'id'</span></span>])){\
<span class="number"><span class="number">20</span></span>             <span class="comment"><span class="comment">//output error</span></span>
<span class="number"><span class="number">21</span></span>         }
<span class="number"><span class="number">22</span></span>         Bd_Log::debug(<span class="string"><span class="string">'request input'</span></span>, <span class="number"><span class="number">0</span></span>, <span class="variable"><span class="variable">$arrInput</span></span>);
</code></pre>

<p>第11行，调用 Saf_SmartMain::getUserInfo() 获取在SAF session流程中获得/处理后的用户信息</p>

<p>第17行，调用 Saf_SmartMain::getCgi() 获取在SAF cgi流程中获得/处理后的数据信息</p>

<ol>
<li>通过SAF接口增加NOTICE日志信息（在actions/Sample.php文件类的execute方法最后添加如下代码）</li>
</ol>

<p>(actions/Sample.php)</p>

<pre><code class="php"><span class="comment"><span class="comment">//log记录US相关字段</span></span>
<span class="variable"><span class="variable">$arrUsLog</span></span> = <span class="keyword"><span class="keyword">array</span></span>(
    <span class="string"><span class="string">'usstat'</span></span> =&gt;  <span class="variable"><span class="variable">$response</span></span>[<span class="string"><span class="string">'data'</span></span>][<span class="string"><span class="string">'status'</span></span>],
    <span class="string"><span class="string">'isFiltered'</span></span> =&gt;  (int)<span class="variable"><span class="variable">$response</span></span>[<span class="string"><span class="string">'data'</span></span>][<span class="string"><span class="string">'isFiltered'</span></span>],
    <span class="string"><span class="string">'hasResult'</span></span>  =&gt;  (int)<span class="variable"><span class="variable">$response</span></span>[<span class="string"><span class="string">'data'</span></span>][<span class="string"><span class="string">'hasResult'</span></span>],
    <span class="string"><span class="string">'alaDetail'</span></span>  =&gt;  <span class="variable"><span class="variable">$alaDetailLog</span></span>,
);
Saf_SmartMain::setLogNotice(<span class="variable"><span class="variable">$arrUsLog</span></span>);
</code></pre>

<p>将需要添加至notice log的信息保存为K-&gt;V pair的数组,使用setLogNotice()接口将其添加SAF会在执行log流程时将这部分信息一并打印在NOTICE日志中。</p>

<h3>四、钩子Hook</h3>

<p>SAF框架提供了一个很重要的功能就是钩子（Hook）机制，通过在钩子函数中覆写对应的钩子函数,可以实现对cgi(GET POST等)数据的特殊处理，对登陆信息的校验/修改以及对输出到log日志文件的内容的修改等功能。</p>

<p>前面提到的全局钩子和 app钩子, 还可以将通用流程与app特殊业务逻辑进行很好的分离。</p>

<p>如在前面‘配置’部分所写到的, 只要在全局/app配置中填写对应钩子的类名,就已经将钩子‘勾上’了。</p>

<p>下面以Saf_Base_Testhook举例说明一下要如何制作一个钩子并在其中实现相关功能。</p>

<p>(phplib/saf/base/Testhook.php)</p>

<pre><code class="php"><span class="preprocessor"><span class="preprocessor">&lt;?php</span></span>
<span class="comment"><span class="comment">//测试勾子类</span></span>
<span class="class"><span class="keyword"><span class="class"><span class="keyword">class</span></span></span><span class="class"> <span class="title"><span class="title">Saf_Base_Testhook</span></span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title"><span class="title">Saf_Base_Hook</span></span>
{</span></span>
    <span class="comment"><span class="comment">//cgi数据处理</span></span>
    <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">cgiAction</span></span><span class="params"><span class="params">()</span></span> {</span></span>
        Saf_SmartMain :: setCgi( <span class="variable"><span class="variable">$arr</span></span> );
    }

    <span class="comment"><span class="comment">//处理用户信息</span></span>
    <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">userInfoAction</span></span><span class="params"><span class="params">()</span></span> {</span></span>
        Saf_SmartMain::setUserInfo( <span class="variable"><span class="variable">$arr</span></span> );
    }
    <span class="comment"><span class="comment">//处理用户passport信息</span></span>
    <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">savePassportAction</span></span><span class="params"><span class="params">()</span></span> {</span></span>
        Saf_SmartMain::setSavePassport( <span class="variable"><span class="variable">$bit</span></span> , <span class="variable"><span class="variable">$v</span></span> );
    }
    <span class="comment"><span class="comment">//处理日志信息</span></span>
    <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">saveLogAction</span></span><span class="params"><span class="params">()</span></span> {</span></span>
        Saf_SmartMain::setLogNotice( <span class="variable"><span class="variable">$arr</span></span> );
    }
}
<span class="preprocessor"><span class="preprocessor">?&gt;</span></span>
</code></pre>

<p>钩子类需要继承一个钩子基类: Saf_Base_Hook，在这个类中可以分别对四个函数进行覆写以达到在对应流程做出对应逻辑处理的目的(具体钩子名称及对应功能如上截图所示)</p>

<p>下面是为实现”在notice日志中打印处理时间”而覆写钩子函数的一个例子:</p>

<pre><code class="perl">/<span class="variable"><span class="variable">**</span></span>
 * 打印notice日志前的钩子
 <span class="variable"><span class="variable">*/</span></span>
function saveLogAction(){
    <span class="variable"><span class="variable">$timer</span></span> = Ap_Registry::get(<span class="string"><span class="string">'timer'</span></span>);
    <span class="variable"><span class="variable">$timer</span></span>-&gt;stop(<span class="string"><span class="string">'totalTime'</span></span>);
    <span class="variable"><span class="variable">$timer</span></span>-&gt;stop(<span class="string"><span class="string">'processTime'</span></span>);
    <span class="variable"><span class="variable">$arrTime</span></span> = <span class="variable"><span class="variable">$timer</span></span>-&gt;getTotalTime();
    Saf_SmartMain::setLogNotice(<span class="variable"><span class="variable">$arrTime</span></span>);
}
</code></pre>

<p>覆写saveLogAction函数,在函数中获取timer信息(基础库介绍中有介绍如何使用)后保存至notice log信息中, SAF进行打印NOTICE日志时会将对应的时间字段答应在日志中。</p>

<p>关于cgiAction:</p>

<p>在cgi流程的钩子中, 先使用Saf_SmartMain::getCgi()函数获取SAF中保存的cgi数据。对数据进行校验修改后, 使用Saf_SmartMain::setCgi($arr)函数将新数据回存。这里需要注意的是, 普通的调用setCgi函数会将传入array与原有数据进行merge。</p>

<p>如果需要排除部分原有数据, 需要使用unsetCgi函数, 如下:</p>

<pre><code class="php"><span class="comment"><span class="comment">//回设get&amp;wiaui</span></span>
<span class="variable"><span class="variable">$arrRequestNew</span></span>[<span class="string"><span class="string">'server'</span></span>] = <span class="variable"><span class="variable">$arrServer</span></span>;
<span class="variable"><span class="variable">$arrRequestNew</span></span>[<span class="string"><span class="string">'wiaui'</span></span>]  = <span class="variable"><span class="variable">$arrWiaui</span></span>;
<span class="variable"><span class="variable">$arrRequestNew</span></span>[<span class="string"><span class="string">'query'</span></span>]  = <span class="variable"><span class="variable">$arrQuery</span></span>;
<span class="variable"><span class="variable">$arrRequestNew</span></span>[<span class="string"><span class="string">'page'</span></span>]  = <span class="variable"><span class="variable">$arrPage</span></span>;
<span class="variable"><span class="variable">$arrRequestNew</span></span>[<span class="string"><span class="string">'route'</span></span>]  = <span class="variable"><span class="variable">$arrRoute</span></span>;
<span class="variable"><span class="variable">$arrRequestNew</span></span>[<span class="string"><span class="string">'sampling'</span></span>]  = <span class="variable"><span class="variable">$arrSampling</span></span>;

Saf_SmartMain::unsetCgi(<span class="keyword"><span class="keyword">array</span></span>(<span class="string"><span class="string">'get'</span></span>,<span class="string"><span class="string">'post'</span></span>,<span class="string"><span class="string">'request_param'</span></span>,<span class="string"><span class="string">'wiaui'</span></span>));
Saf_SmartMain::setCgi(<span class="variable"><span class="variable">$arrRequestNew</span></span>);
</code></pre>

<p>Passport部分：</p>

<pre><code class="bash">[passport]
<span class="comment"><span class="comment">#设置了hook后以hook返回的参数为准，该hook用来获取checkuserlogin需要的参数值, </span></span>
<span class="comment"><span class="comment">#hook没有参数，返回值为array。内容为Bd_Passport :: checkUserLogin需要的参数   </span></span>
<span class="comment"><span class="comment">#如array(null, 0, 0, 0, 0)</span></span>
<span class="comment"><span class="comment">#hook_name : Saf_Base_Testhook::getParam</span></span>
</code></pre>

<p>由于passport::checkuserlogin 接口频繁变动，增加此hook功能。
用户可以通过自定义hook 返回passport::checkuserlogin 所需要的参数。不在需要在saf.conf中配置每一个参数。
返回值必须为array，item顺序为passport::checkuserlogin接口需要的参数值。</p>

<h3>五、Log流程</h3>

<p>如何修改SAF log流程中的默认日志格式?</p>

<p>只需要修改odp/conf/log.conf(全局配置) 或 app conf中的对应log配置(app覆盖全局)即可。</p>

<pre><code class="perl"><span class="keyword"><span class="keyword">format</span></span>: <span class="variable"><span class="variable">%L</span></span>: <span class="variable"><span class="variable">%t</span></span> [<span class="variable"><span class="variable">%f</span></span>:<span class="variable"><span class="variable">%N</span></span>] errno[<span class="variable"><span class="variable">%E</span></span>] logId[<span class="variable"><span class="variable">%l</span></span>] uri[<span class="variable"><span class="variable">%U</span></span>] ip[%{<span class="keyword"><span class="keyword">x</span></span>-forwarded-<span class="keyword"><span class="keyword">for</span></span>}i] ua[%{User-Agent}i] refer[<span class="variable"><span class="variable">%{referer}</span></span>i] cookie[<span class="variable"><span class="variable">%{cookie}</span></span>i]<span class="variable"><span class="variable">%S</span></span> <span class="variable"><span class="variable">%M</span></span>

format_wf: <span class="variable"><span class="variable">%L</span></span>: <span class="variable"><span class="variable">%t</span></span> [<span class="variable"><span class="variable">%f</span></span>:<span class="variable"><span class="variable">%N</span></span>] errno[<span class="variable"><span class="variable">%E</span></span>] logId[<span class="variable"><span class="variable">%l</span></span>] uri[<span class="variable"><span class="variable">%U</span></span>] ip[%{<span class="keyword"><span class="keyword">x</span></span>-forwarded-<span class="keyword"><span class="keyword">for</span></span>}i] ua[%{User-Agent}i] refer[<span class="variable"><span class="variable">%{referer}</span></span>i] cookie[<span class="variable"><span class="variable">%{cookie}</span></span>i]<span class="variable"><span class="variable">%S</span></span> errmsg[<span class="variable"><span class="variable">%M</span></span>]
</code></pre>

<p>format对应NOTICE日志，format_wf 对应WARNING/FATAL日志</p>

<pre><code class="perl">ua[%{User-Agent}i] 这种方式为直接将 <span class="variable"><span class="variable">$_SERVER</span></span> 变量中对应字段打印至日志中
<span class="variable"><span class="variable">%S</span></span> 为 setLogNotice 中所传入array信息会被打印至的位置
<span class="variable"><span class="variable">%M</span></span> 为传入单个string时信息会被打印的位置
</code></pre>

<h3>六、Session流程</h3>

<p>如何保证Session流程可用?保证ral中的passport相关配置正确。ODP安装包集成了这个配置, 只需要注意线上线下所连接后端IP不同</p>

<p>(odp/conf/ral/services/passport.conf)</p>

<p>需要修改passport对应配置，注意这里的apid需要填写转换为十进制后的数字</p>

<p>(odp/conf/passport.conf)</p>

<pre><code class="bash"><span class="comment"><span class="comment">######################</span></span>
<span class="comment"><span class="comment">#    Session2</span></span>
<span class="comment"><span class="comment">######################</span></span>
apid : 1031
</code></pre>

            </div>
                <div class="bs-docs-section">
              <div class="page-header">
          <h1 id="ODP基础库">ODP 基础库
            <a class="btn btn-edit btn-primary pull-right">
              <span class="glyphicon glyphicon-edit"></span> 编辑本段
            </a>
          </h1>
        </div>
                <h3>一、概述</h3>

<p>ODP提供了较为丰富的基础库支持，如配置、日志、字符串、计时器等功能都有对应的基础库实现，上文提到的DB也是以基础库的形式提供的，RAL也有相应的基础库实现。</p>

<p>ODP采用扩展实现了部分基础库的核心功能，并在基础库提供PHP形式的包装，如Conf、String等，这有助于提升ODP整体的性能。</p>

<h3>二、Bd_Init</h3>

<p>Bd_Init组件用于初始化环境，举例如下：</p>

<pre><code class="php">Bd_Init::init()-&gt;bootstrap()-&gt;run();
<span class="comment"><span class="comment">// 单行式初始化启动, 初始化环境+初始化app+运行, 亦可选择分步执行,示例如下</span></span>

<span class="comment"><span class="comment">// 返回一个Ap对象</span></span>
<span class="variable"><span class="variable">$ap</span></span> = Bd_Init::init();
<span class="variable"><span class="variable">$ap</span></span>-&gt;bootstrap()-&gt;run();
</code></pre>

<h3>三、Bd_AppEnv</h3>

<p>Bd_AppEnv 用于提供APP相关的上下文信息，主要是各种路径信息</p>

<pre><code class="php"><span class="comment"><span class="comment">//获取当前app名称</span></span>
Bd_AppEnv::getCurrApp()
<span class="comment"><span class="comment">//获取当前或指定app的上下文环境值(conf/data/code/template)</span></span>
Bd_AppEnv::getEnv(<span class="variable"><span class="variable">$key</span></span>, <span class="variable"><span class="variable">$app</span></span> = <span class="keyword"><span class="keyword">null</span></span>)
<span class="comment"><span class="comment">//提供这个接口是为了方便获取运行环境的路径，直接使用绝对路径不是一个好主意，那样会使程序的可迁移性大大降低</span></span>
<span class="comment"><span class="comment">//而且在类似于orp这样的云平台上，运行环境路径并不保证是完全相同的，程序如果使用绝对路径很有可能无法达到预期效果</span></span>
<span class="comment"><span class="comment">//例如获得data目录</span></span>
Bd_AppEnv::getEnv(<span class="string"><span class="string">"data"</span></span>)
</code></pre>

<h3>四、Bd_Conf</h3>

<p>Bd_Conf (读取配置使用)
Bd_Conf使用百度标准的public/configure语法。他把$ODP_ROOT/conf目录中的配置文件做merge，每一个目录或者文件就是一个节点，他的地位和配置文件中的一个[]是一样的。每个目录中，global.conf的级别等同于这个目录。
Bd_Conf会对配置文件进行热加载，但是值得注意的是，为了避免在一次请求中配置发生变化，一次请求内所使用的配置值在rinit的阶段就决定了。</p>

<pre><code class="ruby">/<span class="regexp"><span class="regexp">/获取当前应用配置下的配置项 (e.g. conf/app</span></span><span class="regexp"><span class="regexp">/newapp/global</span></span>.conf 里面的params配置)
<span class="constant"><span class="constant">Bd_Conf::</span></span>getAppConf(<span class="string"><span class="string">'params'</span></span>) 
/<span class="regexp"><span class="regexp">/使用绝对路径获取配置 (e.g. conf/backend</span></span><span class="regexp"><span class="regexp">/search/passport</span></span>.conf)
<span class="constant"><span class="constant">Bd_Conf::</span></span>getConf(<span class="string"><span class="string">'/backend/search/passport'</span></span>) 
</code></pre>

<h3>五、Bd_Log</h3>

<p>Bd_Log (日志相关操作)</p>

<pre><code class="cs"><span class="comment"><span class="comment">// 打印一条warning日志, 传入string将会被打印在日志格式配置中的 %M 字段中</span></span>
<span class="comment"><span class="comment">// 详见‘SAF- Log流程’部分</span></span>

Bd_Log::warning(<span class="string"><span class="string">'something just went wrong'</span></span>);
<span class="comment"><span class="comment">// 打印一条对应日志, 基本同Bd_Log::warning</span></span>
Bd_Log::fatal/ Bd_Log::debug/ Bd_Log::trace…
</code></pre>

<h3>六、Bd_String</h3>

<p>Bd_String (字符串相关操作)</p>

<ol>
<li><p>提供针对字符串的相关函数，例: 编码检查, 转码, 计算大小, 截断, 字符串编解码等</p></li>
<li><p>在此不做赘述, 详见 odp/php/phplib/bd/String.php</p></li>
</ol>

<h3>七、Bd_Timer &amp; Bd_TimerGroup</h3>

<p>Bd_Timer &amp; Bd_TimerGroup (计时相关)</p>

<ol>
<li><p>Bd_Timer 单体计时器, 支持暂停累加, 详见odp/php/phplib/bd/Timer.php</p></li>
<li><p>Bd_TimerGroup 计时器组，用于综合控制多个定时器,详见odp/php/phplib/bd/TimerGroup.php</p></li>
</ol>

<h3>八、Bd_TplFactory</h3>

<p>Bd_TplFactory (Smarty3封装类)</p>

<p>将Smarty3对象进行了封装, 对应配置存放在 odp/conf/smarty.conf</p>

<p>使用方法:</p>

<pre><code class="php"><span class="comment"><span class="comment">//获取实例</span></span>
<span class="variable"><span class="variable">$tpl</span></span> = Bd_TplFactory::getInstance();
<span class="comment"><span class="comment">//像使用smarty实例一样使用它</span></span>
<span class="variable"><span class="variable">$tpl</span></span>-&gt;assign(<span class="variable"><span class="variable">$name</span></span>, <span class="variable"><span class="variable">$value</span></span>);  
<span class="variable"><span class="variable">$tpl</span></span>-&gt;fetch(<span class="variable"><span class="variable">$tplPath</span></span>); 
</code></pre>

            </div>
                <div class="bs-docs-section">
              <div class="page-header">
          <h1 id="RAL">RAL
            <a class="btn btn-edit btn-primary pull-right">
              <span class="glyphicon glyphicon-edit"></span> 编辑本段
            </a>
          </h1>
        </div>
                <h3>一、概述</h3>

<p>RAL是一个支持多种交互协议和打包格式的php扩展。</p>

<p>RAL规定了一套高度抽象的交互过程规范，将整个后端交互过程分成了交互协议和数据打包/解包两大块，可以支持一些常用的后端交互协议，标准化协议扩充的开发过程，促进代码复用。</p>

<p>RAL集成了负载均衡、健康检查等功能，让上游端不需要再关注这些繁琐的通用逻辑，同时实现版本可以在性能方面有更优的表现。</p>

<h3>二、使用示例</h3>

<p>对RAL安装/配置/接口的说明在 RAL手册 中都有详细的说明, 不在此做过多说明,只用例子说明使用步骤。</p>

<p>需求:newapp中的一个dataService需要从一个通讯协议为nshead+mcpack的后端获取数据</p>

<p>实现:</p>

<p>首先，在ral配置中添加所需后端的相关信息 (e.g. odp/conf/ral/services/newapp.conf)</p>

<pre><code class="ruby">[...<span class="variable"><span class="variable">@Service</span></span>]
<span class="comment"><span class="comment"># 服务名 即ral调用时第一个参数，指明访问后端资源的名称</span></span>
<span class="comment"><span class="comment"># 以下以demoService服务为例,进行说明</span></span>
<span class="constant"><span class="constant">Name</span></span>  <span class="symbol"><span class="symbol">:</span></span>  newappbackend
<span class="comment"><span class="comment"># 默认端口号</span></span>
<span class="constant"><span class="constant">DefaultPort</span></span> <span class="symbol"><span class="symbol">:</span></span> <span class="number"><span class="number">3000</span></span>
<span class="comment"><span class="comment"># 默认重试次数，默认值为0，表示不重试</span></span>
<span class="constant"><span class="constant">DefaultRetry</span></span> <span class="symbol"><span class="symbol">:</span></span> <span class="number"><span class="number">0</span></span>
<span class="comment"><span class="comment"># 默认链接种类 SHORT 短连接；LONG 长连接</span></span>
<span class="constant"><span class="constant">DefaultConnectType</span></span> <span class="symbol"><span class="symbol">:</span></span> <span class="constant"><span class="constant">SHORT</span></span>
<span class="comment"><span class="comment"># 默认连接超时，单位ms，默认200</span></span>
<span class="constant"><span class="constant">DefaultConnectTimeOut</span></span> <span class="symbol"><span class="symbol">:</span></span> <span class="number"><span class="number">100</span></span>
<span class="comment"><span class="comment"># 默认读超时，单位ms，默认500</span></span>
<span class="constant"><span class="constant">DefaultReadTimeOut</span></span> <span class="symbol"><span class="symbol">:</span></span> <span class="number"><span class="number">2300</span></span>
<span class="comment"><span class="comment"># 默认写超时，单位ms，默认500</span></span>
<span class="constant"><span class="constant">DefaultWriteTimeOut</span></span> <span class="symbol"><span class="symbol">:</span></span> <span class="number"><span class="number">1000</span></span>
<span class="comment"><span class="comment"># 实际server配置</span></span>
[....<span class="variable"><span class="variable">@Server</span></span>]
<span class="comment"><span class="comment"># ip地址</span></span>
<span class="constant"><span class="constant">IP</span></span> <span class="symbol"><span class="symbol">:</span></span> <span class="number"><span class="number">10.26</span></span>.<span class="number"><span class="number">178.40</span></span>
</code></pre>

<p>其次，封装一个负责与该后端通讯的类，实现使用ral与后端交互 (e.g. Newapp_Backend.php)</p>

<pre><code class="php"><span class="class"><span class="keyword"><span class="class"><span class="keyword">class</span></span></span><span class="class"> <span class="title"><span class="title">Newapp_Backend</span></span>{</span></span>
    <span class="comment"><span class="comment">/**
     * 请求后端
     *<span class="phpdoc"><span class="phpdoc"> @param</span></span> string $server name 服务器名
     *<span class="phpdoc"><span class="phpdoc"> @parma</span></span> mixed  $input  请求数据  
     *<span class="phpdoc"><span class="phpdoc"> @param</span></span> int    $logid  LOG_ID
     *<span class="phpdoc"><span class="phpdoc"> @return</span></span>  array(data,errno)
     */</span></span>
    <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">request</span></span><span class="params"><span class="params">(<span class="variable"><span class="variable">$service</span></span>, <span class="variable"><span class="variable">$input</span></span>, <span class="variable"><span class="variable">$logid</span></span> = null)</span></span>
    {</span></span>
        <span class="keyword"><span class="keyword">if</span></span>(<span class="keyword"><span class="keyword">isset</span></span>(<span class="variable"><span class="variable">$logid</span></span>)) {
            ral_set_logid(<span class="variable"><span class="variable">$logid</span></span>);
        }

        <span class="variable"><span class="variable">$arrResult</span></span> = <span class="keyword"><span class="keyword">array</span></span>();

        <span class="variable"><span class="variable">$arrResult</span></span>[<span class="string"><span class="string">'data'</span></span>] = ral(<span class="variable"><span class="variable">$service</span></span>, <span class="string"><span class="string">''</span></span>, <span class="variable"><span class="variable">$input</span></span>, <span class="string"><span class="string">''</span></span>);
        <span class="variable"><span class="variable">$arrResult</span></span>[<span class="string"><span class="string">'errno'</span></span>] = <span class="number"><span class="number">0</span></span>;
        <span class="keyword"><span class="keyword">if</span></span>(<span class="variable"><span class="variable">$arrResult</span></span>[<span class="string"><span class="string">'data'</span></span>] === <span class="keyword"><span class="keyword">false</span></span>) {
            <span class="variable"><span class="variable">$arrResult</span></span>[<span class="string"><span class="string">'data'</span></span>] === <span class="keyword"><span class="keyword">array</span></span>();
            <span class="variable"><span class="variable">$arrResult</span></span>[<span class="string"><span class="string">'errno'</span></span>] = <span class="variable"><span class="variable">$this</span></span>-&gt;getErrno();
        }
        <span class="keyword"><span class="keyword">return</span></span> <span class="variable"><span class="variable">$arrResult</span></span>;
    }
}
</code></pre>

<p>最后，在对应dataService中通过使用上一步中的封装类获取后端数据</p>

<pre><code class="perl"><span class="variable"><span class="variable">$backend</span></span> = new Newapp_Backend();
<span class="variable"><span class="variable">$arrRequest</span></span> = <span class="variable"><span class="variable">$backend</span></span>-&gt;request(<span class="variable"><span class="variable">$service</span></span>,<span class="variable"><span class="variable">$arrRequestParams</span></span>[<span class="string"><span class="string">'query'</span></span>][<span class="string"><span class="string">'logid'</span></span>]);
</code></pre>

<h3>三、注意</h3>

<p>ral在使用http协议请求后端时默认会使用POST方法,如果需要使用GET请求需要传$method字段为“get”, 如下:</p>

<pre><code class="bash"><span class="variable"><span class="variable">$result</span></span> = ral(<span class="variable"><span class="variable">$service</span></span>, <span class="string"><span class="string">'get'</span></span>, <span class="variable"><span class="variable">$input</span></span>, <span class="string"><span class="string">''</span></span>);
</code></pre>

            </div>
                <div class="bs-docs-section">
              <div class="page-header">
          <h1 id="Ksarch服务">Ksarch 服务
            <a class="btn btn-edit btn-primary pull-right">
              <span class="glyphicon glyphicon-edit"></span> 编辑本段
            </a>
          </h1>
        </div>
                <h3>一、概述</h3>

<p><a href="http://wiki.babel.baidu.com/twiki/bin/view/Ps/Ns/KsarchStartGuide">通用服务</a> 是由ksarch团队提供的面向大社区的服务，涵盖了提交、检索、cache、redis、计数、通评、好友、动态、相册、tag以及反作弊相关的服务，目前已经应用于30多条产品线。</p>

<p>由于ksarch提供了非常多的服务，因此教程无法完全覆盖，只针对通用的提交服务在ODP环境中的使用做一个介绍，而这一部分的介绍采用了使用
提交服务的一个Demo。</p>

<p>本章在上一章的基础上使用了 <a href="http://man.baidu.com/inf/odp/ralrpc">ralrpc库</a> 来调用ksarch的通用服务，ralrpc库是ODP环境对使用RAL的一个封装库，相当于RAL在ODP中的一个客户端。关于ralrpc的内容参考以下链接：</p>

<h3>二、KSARCH提交服务简介</h3>

<p><a href="http://man.baidu.com/ksarch/commit">提交服务</a> 的作用是，将用户的提交信息转发给产品线的各个子系统。在提交系统中，用户的提交信息会以队列的形式保存起来，并顺序地发给各个后端子系统。所以提交服务也可以认为是消息转发服务。</p>

<p>提交服务设计的初衷是通过将一个用户请求由同步方式变为异步的方式来提高系统的响应，减少用户的等待时间以达到改善用户体验的目的。具体来说便是，前端（通常是浏览器）提交过来的请求，服务器端业务逻辑处理中通常需要与多个后端子系统进行数据交互才能完成对一个请求的处理，后端的子系统常见的包括数据库、cache、或者其他webserver等。在这个过程中，如果按顺序逐个调用后端子系统并等待其响应再返回，那会花很长时间，影响用户体验。基于这种情景，便有了提交服务的产生。</p>

<p>提交服务提供的acm/transfer异步转发的模式，可以将这个问题得以解决，具体来说便是将前端提交过来信息（在commit服务中称之为命令）先发送给acm/transfer服务器，acm将之记录在服务器上的特殊文件（称之为di文件）里，然后马上返回成功信息给前端处理用户请求的ODP服务器，而处理前端请求的ODP服务器在接收到acm/transfer服务器发来的成功信息以后，也马上返回给用户成功的信息，这样在前端用户看来，自己对网站的一次操作已经完成了，而实际上，这时acm/transfer服务器中的transfer程序才开始从di文件中将acm记录下来的命令内容读出，再转发给后端的各个子系统。这里的命令，大家可以想象为SQL语句指令（如果后端子系统是mysql数据库的话）。</p>

<p>在这个过程中，用户始终会收到请求处理成功的信息，而这种成功的可靠性，是通过acm/transfer服务的处理机制来保证的，当一个已经写入di文件的命令被转发到后端子系统后，子系统无法成功处理时，acm/transfer会一直重试，直到此命令在后端子系统中执行成功才会结束，当然，这一机制的前提是这个在子系统中将被执行的命令是能够正确执行的，这一点则只能由使用commit提交服务的用户（这里指使用提交服务的产品线开发人员）来保证了。同时，acm/transfer也是多线程并行处理的运行模式，这也将大大提高对前端命令的处理能力。</p>

<h3>三、ODP环境中使用KSARCH通用提交服务示例</h3>

<p>根据第二到第四章的介绍，我们已经很清楚一个由浏览器端发起的请求在ODP环境中的处理与执行流程：</p>

<ol>
<li><p>浏览器端发起请求</p></li>
<li><p>ODP环境中lighhtpd服务器接收请求并根据配置文件配置的rewrite规则将请求进行转发</p></li>
<li><p>通过controller控制器找到对应的action</p></li>
<li><p>通过action执行相应的业务逻辑model（又分为：ps——&gt;ds——&gt;dao）</p></li>
</ol>

<p>在这个过程中我们在DS层可能会使用cache服务来缓存粗粒度的页面内容，在DAO层可能会使用数据库来持久化用户提交的信息。这两层的数据处理过程都需要时间，而采用上面的流程则需要等待最后一层完成数据的处理过程才能返回通知前端用户处理完成的信息，这是一种同步的处理方式。在这一章中，我们将使用KSARCH提供的通用提交服务来对这个流程进行改进，使之成为异步的处理方式。虽然在介绍通用提交服务时，我们提到了acm/transfer支持mysql的提交命令，具体来说，便是用户通过线下的acm/transfer命令配置系统（由KSARCH提供的MIS系统）配置了某一命令的命令号以及和该命令相关的字段以及字段值类型，同时，我们根据后端系统还要提供一份transfer.conf的配置文件，用于配置transfer转发命令的格式，对于后端为mysql的应用场景，在我们的程序中，提交给acm/transfer的这个命令号的命令将被tansfer根据transfer.conf中的配置，装配成SQL语句然后才转发给后端的mysql数据库。</p>

<p>这是一种比较理想的使用acm/transfer的mysqlso进行异步提交的情形，但是实际使用中，我们完成一个提交的操作往往不是一条SQL语句所能完成的，如果使用mysqlso这种方式，我们需要配置很多的命令，并且为每个命令进行配置，这个过程繁琐而且容易出错，因此，目前建议大家只是简单的使用acm/transfer的记录功能，具体与后端mysql进行交互的逻辑还是由用户自己来完成。具体的做法便是在DS层，用户通过给acm/transfer发一条提交的命令，而该命令使用acm/transfer的httpso在transfer.conf文件中指定transfer将这个命令提交给ci_odp端，相当于对ci_odp端发起了一个http请求。ci_odp是由我们创建的专门用于处理与数据库交互逻辑的一个新的ODP环境后台。改造之后，整个使用提交服务的执行流程将变为如下的步骤：</p>

<ol>
<li><p>浏览器端发起请求;</p></li>
<li><p>ODP环境lighttpd服务器接收请求并根据配置文件配置的rewrite规则将请求进行转发;</p></li>
<li><p>根据被重写后的url找到对应的子系统以及相应的controller控制器;</p></li>
<li><p>控制器根据路由规则找到对应的action，由action层负责实例化PS层类实例,将浏览器传递的数据交向下一层，并将数据结果返回给模版;</p></li>
<li><p>ServicePage（PS）层类对action层传入的数据进行一些参数校验，然后调用ServiceData（DS）层类的接口以获取所需数据;</p></li>
<li><p>DS层类方法中通过调用Bd_RalRpc::create静态方法获得一个使用commit服务的实例对象，然后调用此对象的call方法把命令转发给acm;</p></li>
<li><p>acm接收到ODP端转发过来的命令之后，根据用户配置好的acm配置文件中的命令号和命令参数对转发过来的命令进行参数检测和写di文件操作，并将处理结果状态返回给ODP端，ODP端提示用户提交完成后便结束程序;</p></li>
<li><p>transfer读取di文件，根据transfer.conf文件中的配置将di文件中记录的命令转发给后端ci_odp端；</p></li>
<li><p>ci_odp端接收到transfer发过来的http请求后，重复步骤2、3、4;</p></li>
<li><p>找到action后，读取ci_odp/conf/task/taskcmd.conf配置文件，实例化相应的操作类进行相关写操作，最后在dao层类方法与mysql数据库进行数据交互。</p></li>
</ol>

<h3>四、ODP环境中使用KSARCH通用服务示例</h3>

<p>我们来看看一个普通的HTTP请求，在使用KSARCH提交服务的ODP环境中是如何被处理的，首先有如下的一个页面的源码：</p>

<p>可以看到该页面的form表单的action项中，指定了 <code>action="/uc/myAcmTransfer/test?"</code> 。接收此请求的ODP环境lighttpd服务器的配置文件配置的rewrite规则为：</p>

<pre><code class="perl"><span class="string"><span class="string">"^/uc/myAcmTransfer(/[^?]<span class="variable"><span class="variable">*)</span></span>?((?.<span class="variable"><span class="variable">*)</span></span>?)<span class="variable"><span class="variable">$"</span></span> =&gt; "</span></span>/task/<span class="keyword"><span class="keyword">index</span></span>.php<span class="variable"><span class="variable">$2</span></span>&amp;c=<span class="keyword"><span class="keyword">index</span></span>&amp;a=myacmtransfer<span class="string"><span class="string">",
</span></span></code></pre>

<p>根据这个配置，该请求将被转发到/home/wiki/odp/webroot/task/index.php脚本进行处理，也就是重定向到了task子系统。</p>

<p>在task子系统中，Bootstrap.php文件定义了AP框架的路由配置规则：</p>

<pre><code class="php"><span class="variable"><span class="variable">$route</span></span> = <span class="keyword"><span class="keyword">new</span></span> Ap_Route_Simple(<span class="string"><span class="string">"m"</span></span>, <span class="string"><span class="string">"c"</span></span>, <span class="string"><span class="string">"a"</span></span>);
</code></pre>

<p>根据该路由规则，用户请求的uri可以得到如下分解：</p>

<pre><code class="php"><span class="string"><span class="string">'module'</span></span>     =&gt;  <span class="string"><span class="string">'默认模块'</span></span>,
<span class="string"><span class="string">'controller'</span></span> =&gt;  <span class="string"><span class="string">'index'</span></span>,
<span class="string"><span class="string">'action'</span></span>     =&gt;  <span class="string"><span class="string">'myacmtransfer'</span></span>,
</code></pre>

<p>根据该路由规则，AP框架找到了home/wiki/odp/app/task/controllers目录的Index.php文件，在该文件的数组actions中找到键myacmtransfer所对应的值，该Demo配置了"myacmtransfer"=&gt;"actions/submit/MyAcmTransfer.php",因此最终这个请求被转发到了home/wiki/odp/app/task/actions/submit目录下的MyAcmTransfer.php文件来处理，MyAcmTransfer.php文件中有如下语句：</p>

<pre><code class="java"><span class="class"><span class="keyword"><span class="class"><span class="keyword">class</span></span></span><span class="class"> <span class="title"><span class="title">Action_MyAcmTransfer</span></span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title"><span class="title">Ap_Action_Abstract</span></span>{</span></span>

    <span class="keyword"><span class="keyword">public</span></span> function execute(){
        $arrInput = Saf_SmartMain::getCgi(); 
        $objPageService =  Bd_LayerProxy::getProxy(<span class="string"><span class="string">'Service_Page_Submit_MyAcmTransfer'</span></span>); 
        $arrPageInfo = $objPageService-&gt;execute($arrInput);
    }
}
</code></pre>

<p>根据“Service_Page_Submit_MyAcmTransfer”，转到/models/service/page/submit目录下的MyAcmTransfer.php脚本，该文件中有如下语句：</p>

<pre><code class="php"><span class="class"><span class="keyword"><span class="class"><span class="keyword">class</span></span></span><span class="class">  <span class="title"><span class="title">Service_Page_Submit_MyAcmTransfer</span></span>{</span></span>
    <span class="comment"><span class="comment">/**
     *<span class="phpdoc"><span class="phpdoc"> @brief</span></span> 调用Service_Data层接口发命令
     */</span></span>   
    <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">execute</span></span><span class="params"><span class="params">(<span class="variable"><span class="variable">$arrInput</span></span>)</span></span>) {</span></span>
        <span class="keyword"><span class="keyword">try</span></span> {   
            <span class="variable"><span class="variable">$reqCgi</span></span> = <span class="variable"><span class="variable">$arrInput</span></span>;
            <span class="variable"><span class="variable">$reqParams</span></span> = <span class="variable"><span class="variable">$reqCgi</span></span>[<span class="string"><span class="string">'request_param'</span></span>];
            <span class="variable"><span class="variable">$obj</span></span> = Bd_LayerProxy::getProxy(<span class="string"><span class="string">'Service_Data_InsertInfo'</span></span>);
            <span class="variable"><span class="variable">$bolRet</span></span> = <span class="variable"><span class="variable">$obj</span></span>-&gt;insertData(<span class="variable"><span class="variable">$reqParams</span></span>);
            <span class="keyword"><span class="keyword">if</span></span> (<span class="variable"><span class="variable">$bolRet</span></span>) {
                <span class="keyword"><span class="keyword">echo</span></span> <span class="string"><span class="string">"acm commit success!n"</span></span>.<span class="string"><span class="string">"inserted data,name:"</span></span>.<span class="variable"><span class="variable">$reqParams</span></span>[<span class="string"><span class="string">'name'</span></span>].<span class="string"><span class="string">",age:"</span></span>.<span class="variable"><span class="variable">$reqParams</span></span>[<span class="string"><span class="string">'age'</span></span>];
                <span class="variable"><span class="variable">$intOut</span></span> = <span class="number"><span class="number">0</span></span>;
             }
         } <span class="keyword"><span class="keyword">catch</span></span>  ( Ak_Error <span class="variable"><span class="variable">$e</span></span> ) { 
             <span class="variable"><span class="variable">$intOut</span></span> = <span class="number"><span class="number">1</span></span>;
         }
         <span class="keyword"><span class="keyword">return</span></span> <span class="variable"><span class="variable">$intOut</span></span>;
    }
}
</code></pre>

<p>该PS层类负责从上一个页面接收表单数据并做数据校验等操作，后续的读写逻辑需要提交到DS层，所以根据Service_Data_InsertInfo转到执行/models/service/data下的InsertInfo.php文件进行处理。</p>

<p>InsertInfo.php文件中有如下语句：</p>

<pre><code class="php"><span class="class"><span class="keyword"><span class="class"><span class="keyword">class</span></span></span><span class="class"> <span class="title"><span class="title">Service_Data_InsertInfo</span></span>{</span></span>
    <span class="comment"><span class="comment">//写数据的命令号</span></span>
    <span class="keyword"><span class="keyword">const</span></span> CMD_INSERTDATA = <span class="number"><span class="number">10604863</span></span>;

    <span class="comment"><span class="comment">/**
     *<span class="phpdoc"><span class="phpdoc"> @brief</span></span> 发命令写数据
     *<span class="phpdoc"><span class="phpdoc"> @return</span></span> 大于0表示成功，否则表示失败
     **/</span></span>

    <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">insertData</span></span><span class="params"><span class="params">(<span class="variable"><span class="variable">$reqParams</span></span>)</span></span> {</span></span>
        <span class="variable"><span class="variable">$arrInfo</span></span>[<span class="string"><span class="string">'command_no'</span></span>] = <span class="keyword"><span class="keyword">self</span></span>::CMD_INSERTDATA;
        <span class="variable"><span class="variable">$arrInfo</span></span>[<span class="string"><span class="string">'name'</span></span>] = <span class="variable"><span class="variable">$reqParams</span></span>[<span class="string"><span class="string">'name'</span></span>];
        <span class="variable"><span class="variable">$arrInfo</span></span>[<span class="string"><span class="string">'age'</span></span>] = <span class="variable"><span class="variable">$reqParams</span></span>[<span class="string"><span class="string">'age'</span></span>];
        <span class="variable"><span class="variable">$commitInitParam</span></span> = <span class="keyword"><span class="keyword">array</span></span>(<span class="string"><span class="string">'pid'</span></span> =&gt; <span class="string"><span class="string">'wiki08'</span></span>,);
        <span class="comment"><span class="comment">// 通过ralrpc创建一个使用acm/transfer的客户端实例</span></span>
        <span class="variable"><span class="variable">$commit</span></span> = Bd_RalRpc::create(<span class="string"><span class="string">'Commit'</span></span>, <span class="variable"><span class="variable">$commitInitParam</span></span>);
        <span class="keyword"><span class="keyword">if</span></span> (<span class="variable"><span class="variable">$commit</span></span> == <span class="keyword"><span class="keyword">null</span></span>) {
            <span class="comment"><span class="comment">//throw Ak_Error();</span></span>
        }
        <span class="variable"><span class="variable">$commit_data</span></span> = <span class="variable"><span class="variable">$arrInfo</span></span>;
        <span class="variable"><span class="variable">$bolRet</span></span> = <span class="variable"><span class="variable">$commit</span></span>-&gt;<span class="variable"><span class="variable">$commandName</span></span>(<span class="variable"><span class="variable">$commit_data</span></span>);
        <span class="keyword"><span class="keyword">return</span></span> <span class="variable"><span class="variable">$bolRet</span></span>;
    }
}
</code></pre>

<p>可以看到这个命令是一个写数据到数据库的命令，该层inserData函数的行为却不直接写数据库，而是通过ODP提供的RALRPC库函数将命令发送到acm/transfer服务器来进行提交操作。对于用户来说，不是通过该请求直接由ODP服务端发起数据库的写操作，而通过将命令提交给acm/transfer服务端，由acm/transfer端发起数据库的写操作，也就是异步提交机制，用户将在成功发送命令之后得到提交成功的反馈信息，而不再需要关心acm/transfer服务端后续的具体写操作。语句中的常量CMD_INSERTDATA是命令号，每一个异步请求都对应一个命令号。</p>

<p>那么acm/transfer端接收到前端ODP服务器发来的这个命令后又做了哪些事情呢。</p>

<p><a href="http://man.baidu.com/ksarch/commit">acm/transfer</a> 负责从前端ODP服务器接收数据，并根据相关配置把数据转发给ci_odp端。接收数据设计的命令号以及命令中发送的相关字段都是通过acm/transfer端的数据库来存储的。主要涉及到两个表：commit_commands和commit_fields，前者存储了命令号及其名称，后者存储了每一个命令对应的数据信息字段及每一个字段的相关校验信息。该Demo中的对应的数据存储如下：</p>

<p>首先需要在transfer的transfer.conf配置文件中修改task_cmds_num，将它的值修改为当前值加上新加的命令号个数；</p>

<p>然后，需要修改task.cmd配置中第一部分的[cmd_list]，增加命令类型 <code>@cmd :10604863</code>。</p>

<p>最后，需要修改task.cmd文件第三部分配置命令号对应的转发uri：</p>

<pre><code class="ruby">[<span class="number"><span class="number">10604863</span></span>]
uri <span class="symbol"><span class="symbol">:</span></span> /task/commit<span class="number"><span class="number">?t</span></span>ransid={{<span class="comment"><span class="comment">#TRANSID}}&amp;ie=gbk</span></span>
</code></pre>

<p>ci_odp端根据acm/transfer端的命令号转发配置uri，类似odp端的步骤(2)、(3)、(4)，依次在ci_odp的lighttpd配置文件lighttpd_ci_odp.conf，home/wiki/ci_odp/app/task/controllers/Index.php中找到：</p>

<pre><code class="sql">"^/task/<span class="operator"><span class="keyword"><span class="operator"><span class="keyword">commit</span></span></span><span class="operator">((?.*)?)$<span class="string"><span class="string">"=&gt; "</span></span>/task/index.php$<span class="number"><span class="number">2</span></span>&amp;a=<span class="keyword"><span class="keyword">commit</span></span><span class="string"><span class="string">",
"</span></span><span class="keyword"><span class="keyword">commit</span></span><span class="string"><span class="string">"=&gt;"</span></span>actions/<span class="keyword"><span class="keyword">Commit</span></span>.php<span class="string"><span class="string">",
</span></span></span><span class="string"></span></span></code></pre>

<p>转到/ci_odp/app/task/actions下的Commit.php，该文件会进行数据校验、读取配置文件ci_odp/conf/task/taskcmd.conf，实例化操作类等相关操作。该Demo中不用重新建立Commit.php，因为该文件在之前的系统中已经存在，我们只需要在taskcmd.conf中配置对应的命令号和操作类即可，该Demo增加的配置如下：</p>

<pre><code class="css"><span class="attr_selector"><span class="attr_selector">[.10604863]</span></span>
<span class="tag"><span class="tag">service</span></span> : <span class="tag"><span class="tag">Service_Page_Commit_InsertData</span></span>
<span class="attr_selector"><span class="attr_selector">[..param]</span></span>
<span class="attr_selector"><span class="attr_selector">[...name]</span></span>
<span class="tag"><span class="tag">type</span></span> : <span class="tag"><span class="tag">string</span></span>
<span class="attr_selector"><span class="attr_selector">[...age]</span></span>
<span class="tag"><span class="tag">type</span></span> : <span class="tag"><span class="tag">string</span></span>
</code></pre>

<p>根taskcmd.conf中命令的配置，转到执行/models/service/page/commit下的InsertData.php，该Demo在文件中有如下语句：</p>

<pre><code class="php"><span class="class"><span class="keyword"><span class="class"><span class="keyword">class</span></span></span><span class="class"> <span class="title"><span class="title">Service_Page_Commit_InsertData</span></span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title"><span class="title">Service_Page_Commit_Base</span></span> {</span></span>
    <span class="keyword"><span class="keyword">private</span></span> <span class="variable"><span class="variable">$_dsInsertData</span></span>;

        <span class="keyword"><span class="keyword">private</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">_init</span></span><span class="params"><span class="params">()</span></span>{</span></span>
            <span class="keyword"><span class="keyword">if</span></span>(is_null(<span class="variable"><span class="variable">$this</span></span>-&gt;_dsInsertData)){
                <span class="variable"><span class="variable">$this</span></span>-&gt;_dsInsertData =  Bd_LayerProxy::getProxy(<span class="string"><span class="string">'Service_Data_InsertData'</span></span>);
            }
        }

    <span class="comment"><span class="comment">// 调用ds层的写逻辑</span></span>
    <span class="keyword"><span class="keyword">protected</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">process</span></span><span class="params"><span class="params">()</span></span> {</span></span>
        <span class="variable"><span class="variable">$this</span></span>-&gt;_init();
        <span class="variable"><span class="variable">$strNmae</span></span> = <span class="variable"><span class="variable">$this</span></span>-&gt;arrCommand[<span class="string"><span class="string">'name'</span></span>];
        <span class="variable"><span class="variable">$strAge</span></span> = <span class="variable"><span class="variable">$this</span></span>-&gt;arrCommand[<span class="string"><span class="string">'age'</span></span>];
        <span class="variable"><span class="variable">$arrFields</span></span> = <span class="keyword"><span class="keyword">array</span></span>(
            <span class="string"><span class="string">'name'</span></span> =&gt; <span class="variable"><span class="variable">$strNmae</span></span>,
            <span class="string"><span class="string">'age'</span></span> =&gt; <span class="variable"><span class="variable">$strAge</span></span>,
        );
        <span class="variable"><span class="variable">$this</span></span>-&gt;_dsInsertData-&gt;insertData(<span class="variable"><span class="variable">$arrFields</span></span>);
    }
}
</code></pre>

<p>该PS层的类继承Service_Page_Commit_Base类，负责接收Commit.php中传递过来的数据信息，并调用DS层的写逻辑。</p>

<p>转到执行/models/service/data下的InsertData.php，该Demo有如下语句：</p>

<pre><code class="php"><span class="class"><span class="keyword"><span class="class"><span class="keyword">class</span></span></span><span class="class"> <span class="title"><span class="title">Service_Data_InsertData</span></span>{</span></span>
    <span class="keyword"><span class="keyword">private</span></span> <span class="variable"><span class="variable">$_daoDemo</span></span> = <span class="keyword"><span class="keyword">null</span></span>;
    <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">__construct</span></span><span class="params"><span class="params">()</span></span> {</span></span>
        <span class="variable"><span class="variable">$this</span></span>-&gt;_daoDemo =  Bd_LayerProxy::getProxy(<span class="string"><span class="string">'Dao_Demo'</span></span>);
    }

    <span class="comment"><span class="comment">/**
     * 该函数调用dao层接口插入数据
     */</span></span>
    <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">insertData</span></span><span class="params"><span class="params">(<span class="variable"><span class="variable">$arrFields</span></span>)</span></span> {</span></span>
        <span class="variable"><span class="variable">$out</span></span> = <span class="variable"><span class="variable">$this</span></span>-&gt;_daoDemo-&gt;insertDataDao(<span class="variable"><span class="variable">$arrFields</span></span>);
    }
}
</code></pre>

<p>Service_Data层只是封装了写数据逻辑，具体的写操作需要调用Dao层下的Demo.php。</p>

<pre><code class="php"><span class="class"><span class="keyword"><span class="class"><span class="keyword">class</span></span></span><span class="class"> <span class="title"><span class="title">Dao_Demo</span></span> {</span></span>
    <span class="keyword"><span class="keyword">private</span></span> <span class="variable"><span class="variable">$_db</span></span>;
    <span class="keyword"><span class="keyword">const</span></span> DATABASE = <span class="string"><span class="string">'wiki'</span></span>;<span class="comment"><span class="comment">//数据库名</span></span>
    <span class="keyword"><span class="keyword">const</span></span> TABLE = <span class="string"><span class="string">'tblYangDailiang'</span></span>;<span class="comment"><span class="comment">//操作表</span></span>
    <span class="comment"><span class="comment">//构造函数，获取数据库实例</span></span>
    <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">__construct</span></span><span class="params"><span class="params">()</span></span>{</span></span>
        <span class="variable"><span class="variable">$this</span></span>-&gt;_db = Wiki_Common_Db::getDB(<span class="keyword"><span class="keyword">self</span></span>::DATABASE);
    }
    <span class="comment"><span class="comment">//写入数据库</span></span>
    <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">insertDataDao</span></span><span class="params"><span class="params">(<span class="variable"><span class="variable">$arrFields</span></span>)</span></span> {</span></span>
        <span class="variable"><span class="variable">$arrFields</span></span> = Wiki_Common_Filter::check(<span class="variable"><span class="variable">$arrFields</span></span>, <span class="keyword"><span class="keyword">self</span></span>::<span class="variable"><span class="variable">$arrCheckMapping</span></span>);
        <span class="variable"><span class="variable">$this</span></span>-&gt;_db-&gt;insert(<span class="keyword"><span class="keyword">self</span></span>::TABLE, <span class="variable"><span class="variable">$arrFields</span></span>);
        <span class="keyword"><span class="keyword">return</span></span> <span class="keyword"><span class="keyword">true</span></span>;
    }
}
</code></pre>

<p>该层封装了与mysql交互的相关细节，最终调用函数insertDataDao将数据写入数据库。至此，一个完整的使用KSARCH通用提交服务的例子完成了。</p>

            </div>
                <div class="bs-docs-section">
              <div class="page-header">
          <h1 id="PhpTest单元测试框架">PhpTest 单元测试框架
            <a class="btn btn-edit btn-primary pull-right">
              <span class="glyphicon glyphicon-edit"></span> 编辑本段
            </a>
          </h1>
        </div>
                <p>ODP 内置单元测试框架，使用方法如下：</p>

<p><a href="http://man.baidu.com/inf/odp/plugins/phptest/">http://man.baidu.com/inf/odp/plugins/phptest/</a></p>

            </div>
                <div class="bs-docs-section">
              <div class="page-header">
          <h1 id="OCM工具">OCM 工具
            <a class="btn btn-edit btn-primary pull-right">
              <span class="glyphicon glyphicon-edit"></span> 编辑本段
            </a>
          </h1>
        </div>
                <p>ocm 组件是用于 ODP 环境查询组件版本的工具，使用方法与ODP 2.3.0环境一致，但是能够查看的信息更多，现在也可以查看ODP环境PHP so扩展的版本信息。下面详细介绍 ODP ocm 组件的功能：</p>

<blockquote class="bs-callout bs-callout-warning">
  <h4>注意</h4>
  
  <p>如果当前机器安装了多个ODP环境，请确保执行的ocm命令是当前ODP环境 <code>{ODP_ROOT}/php/bin/</code> 路径下的 <code>ocm</code> 命令。</p>
  
  <p>如果你已经将其他odp环境的/php/bin目录加入了$PATH环境变量，那么可能取得的结果是错误的。</p>
</blockquote>

<h3>./ocm odp list</h3>

<p>此命令用于查询安装包默认安装的组件以及组件对应的版本号。比如 2.4.0 版本安装包安装完成的ODP环境中执行该命令的结果如下：</p>

<pre><code class="perl">ak             <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">31.0</span></span>
ap             <span class="number"><span class="number">1.1</span></span>.<span class="number"><span class="number">4.1</span></span>
app-cg         <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">3.0</span></span>
autoloader     <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">3.0</span></span>
cacheproxy     <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">1.0</span></span>
conf           <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">5.0</span></span>
<span class="keyword"><span class="keyword">crypt</span></span>          <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">4.1</span></span>
db             <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">14.0</span></span>
i18n           <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">5.0</span></span>
init           <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">6.0</span></span>
layerproxy     <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">2.0</span></span>
<span class="keyword"><span class="keyword">log</span></span>            <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">7.0</span></span>
Lighttpd       <span class="number"><span class="number">1.5</span></span>.<span class="number"><span class="number">0</span></span>.<span class="number"><span class="number">3</span></span>
Nginx          <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">13.2</span></span>
ocm            <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">3.1</span></span>
omp            <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">6.0</span></span>
passport       <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">7.0</span></span>
pcheck         <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">2.0</span></span>
PHP            <span class="number"><span class="number">5.2</span></span>.<span class="number"><span class="number">17</span></span>
phpcas         <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">3.0</span></span>
phptest        <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">3.1</span></span>
pic            <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">6.0</span></span>
profiler       <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">4.0</span></span>
ral            <span class="number"><span class="number">1.2</span></span>.<span class="number"><span class="number">3.1</span></span>
ralrpc         <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">4.0</span></span>
saf            <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">12.0</span></span>
smarty         <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">5.0</span></span>
string         <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">4.0</span></span>
timer          <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">2.0</span></span>
util           <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">2.0</span></span>
uuap           <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">3.0</span></span>
Bd_Conf        <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">5.3</span></span>
Bd_String      <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">2.4</span></span>
comconfig      <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">1.3</span></span>
eAccelerator   <span class="number"><span class="number">0</span></span>.<span class="number"><span class="number">9.6</span></span>.<span class="number"><span class="number">2</span></span>
fcrypt         <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">2.5</span></span>
imagick        <span class="number"><span class="number">3.0</span></span>.<span class="number"><span class="number">1.2</span></span>
magickwand     <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">8.2</span></span>
mc_pack        <span class="number"><span class="number">1.3</span></span>.<span class="number"><span class="number">5.3</span></span>
memcache       <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">1.2</span></span>
memcached      <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">3.2</span></span>
netcomlog      <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">4.2</span></span>
sign           <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">2.2</span></span>
uconv          <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">3.3</span></span>
vcode          <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">1.2</span></span>
xdebug         <span class="number"><span class="number">2.1</span></span>.<span class="number"><span class="number">0</span></span>.<span class="number"><span class="number">2</span></span>
xhprof         <span class="number"><span class="number">0</span></span>.<span class="number"><span class="number">9.2</span></span>.<span class="number"><span class="number">2</span></span>
zookeeper      <span class="number"><span class="number">0</span></span>.<span class="number"><span class="number">2.1</span></span>.<span class="number"><span class="number">2</span></span>
</code></pre>

<h3>./ocm list</h3>

<p>此命令用于查询当前ODP环境安装的组件以及组件对应的版本号，通过该命令与 <code>./ocm odp list</code> 命令结果的比较，用户可以知悉，当前ODP环境是否有对某单一组件进行过升级。比如 2.4.0 版本安装包安装完成的ODP环境中执行该命令的结果如下：</p>

<pre><code class="css"><span class="attr_selector"><span class="attr_selector">[basic-env]</span></span>
 <span class="tag"><span class="tag">Lighttpd</span></span>      1<span class="class"><span class="class">.5</span></span><span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.3</span></span>
 <span class="tag"><span class="tag">PHP</span></span>           5<span class="class"><span class="class">.2</span></span><span class="class"><span class="class">.17</span></span>

<span class="attr_selector"><span class="attr_selector">[common]</span></span>
 <span class="tag"><span class="tag">ak</span></span>            1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.31</span></span><span class="class"><span class="class">.0</span></span>
 <span class="tag"><span class="tag">app</span></span>-<span class="tag"><span class="tag">cg</span></span>        1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.3</span></span><span class="class"><span class="class">.0</span></span>        <span class="tag"><span class="tag">offline</span></span>
 <span class="tag"><span class="tag">layerproxy</span></span>    1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.2</span></span><span class="class"><span class="class">.0</span></span>
 <span class="tag"><span class="tag">omp</span></span>           1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.6</span></span><span class="class"><span class="class">.0</span></span>
 <span class="tag"><span class="tag">passport</span></span>      1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.7</span></span><span class="class"><span class="class">.0</span></span>
 <span class="tag"><span class="tag">pcheck</span></span>        1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.2</span></span><span class="class"><span class="class">.0</span></span>        <span class="tag"><span class="tag">offline</span></span>
 <span class="tag"><span class="tag">phpcas</span></span>        1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.3</span></span><span class="class"><span class="class">.0</span></span>
 <span class="tag"><span class="tag">phptest</span></span>       1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.3</span></span><span class="class"><span class="class">.1</span></span>        <span class="tag"><span class="tag">offline</span></span>
 <span class="tag"><span class="tag">pic</span></span>           1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.6</span></span><span class="class"><span class="class">.0</span></span>
 <span class="tag"><span class="tag">smarty</span></span>        1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.5</span></span><span class="class"><span class="class">.0</span></span>

<span class="attr_selector"><span class="attr_selector">[core]</span></span>
 <span class="tag"><span class="tag">autoloader</span></span>    1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.3</span></span><span class="class"><span class="class">.0</span></span>
 <span class="tag"><span class="tag">cacheproxy</span></span>    1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.1</span></span><span class="class"><span class="class">.0</span></span>
 <span class="tag"><span class="tag">conf</span></span>          1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.5</span></span><span class="class"><span class="class">.0</span></span>
 <span class="tag"><span class="tag">crypt</span></span>         1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.4</span></span><span class="class"><span class="class">.1</span></span>
 <span class="tag"><span class="tag">db</span></span>            1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.14</span></span><span class="class"><span class="class">.0</span></span>
 <span class="tag"><span class="tag">i18n</span></span>          1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.5</span></span><span class="class"><span class="class">.0</span></span>
 <span class="tag"><span class="tag">init</span></span>          1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.6</span></span><span class="class"><span class="class">.0</span></span>
 <span class="tag"><span class="tag">log</span></span>           1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.7</span></span><span class="class"><span class="class">.0</span></span>
 <span class="tag"><span class="tag">ocm</span></span>           1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.3</span></span><span class="class"><span class="class">.1</span></span>
 <span class="tag"><span class="tag">profiler</span></span>      1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.4</span></span><span class="class"><span class="class">.0</span></span>
 <span class="tag"><span class="tag">ralrpc</span></span>        1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.4</span></span><span class="class"><span class="class">.0</span></span>
 <span class="tag"><span class="tag">saf</span></span>           1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.12</span></span><span class="class"><span class="class">.0</span></span>
 <span class="tag"><span class="tag">string</span></span>        1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.4</span></span><span class="class"><span class="class">.0</span></span>
 <span class="tag"><span class="tag">timer</span></span>         1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.2</span></span><span class="class"><span class="class">.0</span></span>
 <span class="tag"><span class="tag">util</span></span>          1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.2</span></span><span class="class"><span class="class">.0</span></span>
 <span class="tag"><span class="tag">uuap</span></span>          1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.3</span></span><span class="class"><span class="class">.0</span></span>

<span class="attr_selector"><span class="attr_selector">[extension]</span></span>
 <span class="tag"><span class="tag">ap</span></span>            1<span class="class"><span class="class">.1</span></span><span class="class"><span class="class">.4</span></span><span class="class"><span class="class">.1</span></span>
 <span class="tag"><span class="tag">Bd_Conf</span></span>       1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.5</span></span><span class="class"><span class="class">.3</span></span>
 <span class="tag"><span class="tag">Bd_String</span></span>     1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.2</span></span><span class="class"><span class="class">.4</span></span>
 <span class="tag"><span class="tag">comconfig</span></span>     1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.1</span></span><span class="class"><span class="class">.3</span></span>
 <span class="tag"><span class="tag">eAccelerator</span></span>  0<span class="class"><span class="class">.9</span></span><span class="class"><span class="class">.6</span></span><span class="class"><span class="class">.2</span></span>
 <span class="tag"><span class="tag">fcrypt</span></span>        1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.2</span></span><span class="class"><span class="class">.5</span></span>
 <span class="tag"><span class="tag">imagick</span></span>       3<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.1</span></span><span class="class"><span class="class">.2</span></span>
 <span class="tag"><span class="tag">magickwand</span></span>    1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.8</span></span><span class="class"><span class="class">.2</span></span>
 <span class="tag"><span class="tag">mc_pack</span></span>       1<span class="class"><span class="class">.3</span></span><span class="class"><span class="class">.5</span></span><span class="class"><span class="class">.3</span></span>
 <span class="tag"><span class="tag">memcache</span></span>      1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.1</span></span><span class="class"><span class="class">.2</span></span>
 <span class="tag"><span class="tag">memcached</span></span>     1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.3</span></span><span class="class"><span class="class">.2</span></span>
 <span class="tag"><span class="tag">netcomlog</span></span>     1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.4</span></span><span class="class"><span class="class">.2</span></span>
 <span class="tag"><span class="tag">ral</span></span>           1<span class="class"><span class="class">.2</span></span><span class="class"><span class="class">.3</span></span><span class="class"><span class="class">.1</span></span>
 <span class="tag"><span class="tag">sign</span></span>          1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.2</span></span><span class="class"><span class="class">.2</span></span>
 <span class="tag"><span class="tag">uconv</span></span>         1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.3</span></span><span class="class"><span class="class">.3</span></span>
 <span class="tag"><span class="tag">vcode</span></span>         1<span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.1</span></span><span class="class"><span class="class">.2</span></span>
 <span class="tag"><span class="tag">xdebug</span></span>        2<span class="class"><span class="class">.1</span></span><span class="class"><span class="class">.0</span></span><span class="class"><span class="class">.2</span></span>        <span class="tag"><span class="tag">offline</span></span>
 <span class="tag"><span class="tag">xhprof</span></span>        0<span class="class"><span class="class">.9</span></span><span class="class"><span class="class">.2</span></span><span class="class"><span class="class">.2</span></span>        <span class="tag"><span class="tag">offline</span></span>
 <span class="tag"><span class="tag">zookeeper</span></span>     0<span class="class"><span class="class">.2</span></span><span class="class"><span class="class">.1</span></span><span class="class"><span class="class">.2</span></span>
</code></pre>

<h3>./ocm info {name}</h3>

<p>此命令用于查询当前ODP环境的版本以及已安装组件的详细信息，比如执行 ./ocm info odp 的结果如下：</p>

<pre><code class="http"><span class="attribute"><span class="attribute">friendly-name</span></span>: <span class="string"><span class="string">    ODP</span></span>
<span class="attribute"><span class="attribute">summary</span></span>: <span class="string"><span class="string">          ODP(Online Development Platform) - 在线业务开发平台</span></span>
<span class="attribute"><span class="attribute">version</span></span>: <span class="string"><span class="string">          2.4.0</span></span>
<span class="attribute"><span class="attribute">authors</span></span>: <span class="string"><span class="string">          odp group(odp@baidu.com)</span></span>
</code></pre>

<p>比如执行 ./ocm info saf 的结果如下：</p>

<pre><code class="ruby">friendly-<span class="symbol"><span class="symbol">name:</span></span>     <span class="constant"><span class="constant">SAF</span></span>(<span class="constant"><span class="constant">Social</span></span> <span class="constant"><span class="constant">Application</span></span> <span class="constant"><span class="constant">Framework</span></span>)
<span class="symbol"><span class="symbol">summary:</span></span>           <span class="constant"><span class="constant">SAF</span></span>(<span class="constant"><span class="constant">Social</span></span> <span class="constant"><span class="constant">Application</span></span> <span class="constant"><span class="constant">Framework</span></span>)社区业务层框架 包含通用业务逻辑和子系统框架
<span class="symbol"><span class="symbol">version:</span></span>           <span class="number"><span class="number">1.0</span></span>.<span class="number"><span class="number">12.0</span></span>
<span class="symbol"><span class="symbol">catalog:</span></span>           core
<span class="symbol"><span class="symbol">context:</span></span>           online
<span class="symbol"><span class="symbol">vendor:</span></span>            <span class="constant"><span class="constant">ODP</span></span>(odp<span class="variable"><span class="variable">@baidu</span></span>.com)
<span class="symbol"><span class="symbol">authors:</span></span>           chenchao(chenchao01<span class="variable"><span class="variable">@baidu</span></span>.com), cuichao(cuichao02<span class="variable"><span class="variable">@baidu</span></span>.com),
           luhaixia(luhaixia<span class="variable"><span class="variable">@baidu</span></span>.com)
</code></pre>

<p>对部分组件信息用此命令查询可能会失败比如 <code>./ocm info php</code></p>

<h3>./ocm list-files {name}</h3>

<p>此命令用于查询ODP环境所安装的单一组件对应的文件列表，比如执行 <code>./ocm list-files ocm</code> 的结果如下：</p>

<pre><code class="undefined">/home/chenyijie/odp/php/bin/ocm
/home/chenyijie/odp/php/phplib/bd/OCMCmd.php
/home/chenyijie/odp/php/phplib/bd/OCM.php
</code></pre>

<div class="alert alert-warning">

<p><strong>注意：</strong></p>

<p>ODP支持在单机上安装多套环境，只要安装目录和端口不冲突即可共存，但强烈建议使用多账户或虚拟机。</p>

<p>默认情况下，安装包将自动安装最新的ODP环境，如需使用特定版本的环境，请配置版本号。</p>

<p>建议将php/bin/、php/sbin/、webserver/bin/目录添加到PATH里面，以方便执行ODP相关的命令。</p>

</div>

            </div>
                <div class="bs-docs-section">
              <div class="page-header">
          <h1 id="常见问题">常见问题
            <a class="btn btn-edit btn-primary pull-right">
              <span class="glyphicon glyphicon-edit"></span> 编辑本段
            </a>
          </h1>
        </div>
                <h3>如何不打印.new日志</h3>

<p>修改<code>conf/log.conf</code>或者<code>conf/app/$appname/log.conf</code>（后者优先级更高），将<code>is_omp</code>配置项的值改成2</p>

<h3>压力大时返回302，压力小时正常</h3>

<p>这是因为命中了webserver的防攻击策略，解决方法：</p>

<ol>
<li>安装delevep版的odp，develop版的odp默认没有配置防攻击</li>
<li>如果是nginx，可以修改<code>webserver/conf/nginx.conf</code>，将<code>policy_frame on</code>改为<code>policy_frame off</code></li>
<li>如果是lighttpd，可以修改<code>webserver/conf/lighttpd.conf</code>，注释掉<code>mod_firewall</code></li>
</ol>

<p>文档详见 nginx.baidu.com/book/nginx_user_manual/module/antiattack.html</p>

<h3>一个啥也没干的app，耗时600ms，且Bd_Log日志打印Unknown Error</h3>

<p>ODP生成的app默认开了session所致，如果你不需要passport session服务，把<code>conf/saf.conf</code>或者<code>conf/app/$appname/saf.conf</code>里面<code>session : 1</code>改成<code>session : 0</code>即可。</p>

<p>如果需要用到session服务，则修改<code>conf/ral/services/passport.conf</code>，将session服务的ip从<code>10.23.247.131</code>（这个ip已经不可用）改成passport提供的可用ip（可以在<a href="http://passport.sys.baidu.com/">http://passport.sys.baidu.com/</a>查询）。</p>

<h3>请求中的参数是utf8，但是通过saf获取到的是gbk</h3>

<p>把<code>conf/saf.conf</code>或者<code>conf/app/$appname/saf.conf</code>中的<code>cgi_oe:GB2312</code>改成<code>cgi_oe:UTF-8</code>。</p>

<h3>每个请求默认会打印一条notice日志，如何关掉</h3>

<p>saf强制的功能，如果不想打日志，只能把saf关掉，修改<code>app/$appname/Bootstrap.php</code>把下面代码删掉：</p>

<pre><code class="php">        <span class="variable"><span class="variable">$objPlugin</span></span> = <span class="keyword"><span class="keyword">new</span></span> Saf_ApUserPlugin();
        <span class="variable"><span class="variable">$dispatcher</span></span>-&gt;registerPlugin(<span class="variable"><span class="variable">$objPlugin</span></span>);
</code></pre>

<h3>php 5.4在cgi模式下语法不生效问题</h3>

<p>一些php 5.4新引入的语法，在cgi下不生效，而在cli模式下却能生效。原因是cgi模式下使用的eaccelerator扩展有bug，解决方案是把eaccelerator换成opcache扩展，so下载地址：</p>

<pre><code class="ruby"><span class="symbol"><span class="symbol">ftp:</span></span>/<span class="regexp"><span class="regexp">/getprod:getprod@product.scm.baidu.com:/data</span></span><span class="regexp"><span class="regexp">/prod-64/inf</span></span><span class="regexp"><span class="regexp">/odp/php</span></span>-ext/opcache/opcache_7-<span class="number"><span class="number">0</span></span>-<span class="number"><span class="number">5</span></span>-<span class="number"><span class="number">1_</span></span>PD_BL/output/php-<span class="number"><span class="number">5.4_</span></span>opcache.so
</code></pre>

<h3>ap中的controller/action名或和app名相同的时候，会被路由到index controller/action</h3>

<p>比如这样的url：<code>/my_app/my_app</code>, 路由结果是<code>action=index</code>，而不是<code>action=my_app</code></p>

<p><code>/my_app/my_app/my_action</code>，路由结果是<code>controller=index, action=my_action</code>，而不是<code>controller=my_app, action=my_action</code>。</p>

<p>这是ap的feature，只要是<code>/$my_app/$my_app/xxxxxxx</code>这样的url都会被当成<code>/$my_app/xxxxxxx</code>来处理。</p>

<p>解决方法：修改nginx rewrite规则，把</p>

<pre><code class="bash">rewrite ^/([^/.]*)(/[^\?]*)?((\?.*)?)$ /<span class="variable"><span class="variable">$1</span></span>/index.php<span class="variable"><span class="variable">$2</span></span><span class="variable"><span class="variable">$3</span></span> <span class="keyword"><span class="keyword">break</span></span>;
</code></pre>

<p>改成</p>

<pre><code class="bash">rewrite ^/([^/.]*)(/[^\?]*)?((\?.*)?)$ /<span class="variable"><span class="variable">$1</span></span>/index.php/<span class="variable"><span class="variable">$1</span></span><span class="variable"><span class="variable">$2</span></span><span class="variable"><span class="variable">$3</span></span> <span class="keyword"><span class="keyword">break</span></span>;
</code></pre>

<p>即rewrite后的url加上<code>/$1</code>这部分。</p>

<h3>http返回结果没有content-length</h3>

<p>需要在nginx配置关闭chunked encoding, 同时关闭problem trace模块的header tracing：</p>

<pre><code class="bash">chunked_transfer_encoding&nbsp;off; <span class="comment"><span class="comment"># 关闭chunked encoding</span></span>

problem_tracing on; <span class="comment"><span class="comment"># 打开problem-trace，保证logid</span></span>
header_tracing off; <span class="comment"><span class="comment"># 禁用响应头中的traceid，打开会使响应头中的Content-Length消失</span></span>
body_tracing off; <span class="comment"><span class="comment"># 禁用响应体中的，打开会对部分静态资源造成影响</span></span>
get_header on; <span class="comment"><span class="comment"># 开启从请求头获取logid的功能，如果请求方logid大于32位，则需要关闭</span></span>
logid_name x_bd_logid; <span class="comment"><span class="comment"># 请求头logid的请求头key</span></span>
tracecode_name tracecode; <span class="comment"><span class="comment"># 响应头中的traceidkey</span></span>

</code></pre>

<h3>&nbsp;Bootstrap报fatal</h3>

<p>报如下错误：</p>

<pre><code class="bash">PHP Fatal error:  Call to a member function setDefaultController() on a non-object <span class="keyword"><span class="keyword">in</span></span> xxx/Bootstrap.php
</code></pre>

<p>原因是<code>setDefaultModule($module)</code>指定的模块必须在conf里面配置，比如指定<code>'Main'</code>：</p>

<pre><code class="php"><span class="variable"><span class="variable">$dispatcher</span></span>-&gt;setDefaultModule(<span class="string"><span class="string">'Main'</span></span>)
  -&gt;setDefaultController(<span class="string"><span class="string">'Main'</span></span>);
</code></pre>

<p>则需要在<code>conf/app/$appname/global.conf</code>里面配置：</p>

<pre><code class="bash">[ap]
modules:Main
</code></pre>

<p>也可以直接去掉<code>setDefaultModule</code>调用，只保留<code>setDefaultController</code>：</p>

<pre><code class="php"><span class="variable"><span class="variable">$dispatcher</span></span>-&gt;setDefaultController(<span class="string"><span class="string">'Main'</span></span>);
</code></pre>

<h3>ap如果输入非法的url，找不到相应的action会报fatal</h3>

<p>fatal对用户来说不是一种友好的方式，可能你会希望能够自定义处理ap的错误，可以写一个error controller，在<code>app/$appname/controllers/Error.php</code>，内容类似于下面：</p>

<pre><code class="php"><span class="preprocessor"><span class="preprocessor">&lt;?php</span></span>

<span class="class"><span class="keyword"><span class="class"><span class="keyword">class</span></span></span><span class="class"> <span class="title"><span class="title">Controller_Error</span></span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title"><span class="title">Ap_Controller_Abstract</span></span> {</span></span>

    <span class="keyword"><span class="keyword">public</span></span> <span class="function"><span class="keyword"><span class="function"><span class="keyword">function</span></span></span><span class="function"> <span class="title"><span class="title">errorAction</span></span><span class="params"><span class="params">()</span></span> {</span></span>
        <span class="variable"><span class="variable">$exception</span></span> = <span class="variable"><span class="variable">$this</span></span>-&gt;getRequest()-&gt;getException();
        <span class="keyword"><span class="keyword">try</span></span> {
            <span class="keyword"><span class="keyword">throw</span></span> <span class="variable"><span class="variable">$exception</span></span>;
        } <span class="keyword"><span class="keyword">catch</span></span> (Ap_Exception_LoadFailed <span class="variable"><span class="variable">$e</span></span>) {
            <span class="keyword"><span class="keyword">echo</span></span> <span class="string"><span class="string">"load fail\n"</span></span>;
        } <span class="keyword"><span class="keyword">catch</span></span> (Ap_Exception <span class="variable"><span class="variable">$e</span></span>) {
            <span class="keyword"><span class="keyword">echo</span></span> <span class="variable"><span class="variable">$e</span></span>-&gt;getMessage() . <span class="string"><span class="string">"\n"</span></span>;
        }
    }
}
</code></pre>

<p>然后在<code>webroot/$appname/index.php</code>，里面开启ap的cacheException开关：</p>

<pre><code class="php"><span class="preprocessor"><span class="preprocessor">&lt;?php</span></span>

<span class="variable"><span class="variable">$objApplication</span></span> = Bd_Init::init();
<span class="variable"><span class="variable">$objApplication</span></span>-&gt;getDispatcher()-&gt;catchException(<span class="keyword"><span class="keyword">true</span></span>); <span class="comment"><span class="comment">//加上这一行</span></span>
<span class="variable"><span class="variable">$objResponse</span></span> = <span class="variable"><span class="variable">$objApplication</span></span>-&gt;bootstrap()-&gt;run();
</code></pre>

<p>还有一种更简单的方式是直接在<code>webroot/$appname/index.php</code>中捕获异步并处理：</p>

<pre><code class="php"><span class="preprocessor"><span class="preprocessor">&lt;?php</span></span>

<span class="variable"><span class="variable">$objApplication</span></span> = Bd_Init::init();
<span class="keyword"><span class="keyword">try</span></span> {
    <span class="variable"><span class="variable">$objResponse</span></span> = <span class="variable"><span class="variable">$objApplication</span></span>-&gt;bootstrap()-&gt;run();
} <span class="keyword"><span class="keyword">catch</span></span> (Ap_Exception_LoadFailed <span class="variable"><span class="variable">$e</span></span>) {
    <span class="keyword"><span class="keyword">echo</span></span> <span class="string"><span class="string">"load fail\n"</span></span>;
} <span class="keyword"><span class="keyword">catch</span></span> (Ap_Exception <span class="variable"><span class="variable">$e</span></span>) {
    <span class="keyword"><span class="keyword">echo</span></span> <span class="variable"><span class="variable">$e</span></span>-&gt;getMessage() . <span class="string"><span class="string">"\n"</span></span>;
}
</code></pre>

<h3>php-fpm/lighttpd/nginx无法在root账号下启动</h3>

<p>这是php-fpm/lighttpd出于安全性考虑的限制，可以在<code>php-fpm.conf</code>里面配置工作账号（默认是注释掉的）</p>

<pre><code class="xml">            Unix user of processes
            <span class="tag"><span class="tag">&lt;<span class="title"><span class="title">value</span></span> <span class="attribute"><span class="attribute">name</span></span>=<span class="value"><span class="value">"user"</span></span>&gt;</span></span>work<span class="tag"><span class="tag">&lt;/<span class="title"><span class="title">value</span></span>&gt;</span></span> 

            Unix group of processes
            <span class="tag"><span class="tag">&lt;<span class="title"><span class="title">value</span></span> <span class="attribute"><span class="attribute">name</span></span>=<span class="value"><span class="value">"group"</span></span>&gt;</span></span>work<span class="tag"><span class="tag">&lt;/<span class="title"><span class="title">value</span></span>&gt;</span></span>
</code></pre>

<p>如果是php 5.4的则是如下配置：</p>

<pre><code class="ini"><span class="comment"><span class="comment">; Unix user/group of processes</span></span>
<span class="comment"><span class="comment">; Note: The user is mandatory. If the group is not set, the default user's group</span></span>
<span class="comment"><span class="comment">;       will be used.</span></span>
<span class="setting"><span class="setting">user = <span class="value"><span class="value">work</span></span></span><span class="value"></span></span>
<span class="setting"><span class="setting">group = <span class="value"><span class="value">work</span></span></span><span class="value"></span></span>
</code></pre>

<p>不过，即使php-fpm做了上面改动可以用root账号启动，也可能出现各种问题，比如日志无法打出来，频繁fork子进程等问题，所以<strong>强烈建议不要用root账号启动php-fpm</strong>。</p>

<p>如果是lighttpd，则是如下配置：</p>

<pre><code class="bash"><span class="comment"><span class="comment"># change uid to &lt;uid&gt; (default: don't care)</span></span>
server.username            = <span class="string"><span class="string">"work"</span></span>

<span class="comment"><span class="comment"># change uid to &lt;uid&gt; (default: don't care)</span></span>
server.groupname           = <span class="string"><span class="string">"work"</span></span>
</code></pre>

<p>如果是nginx，则如下配置：</p>

<pre><code class="bash">user  work;
</code></pre>

<p>如果nginx还无法启动，可能是因为worker进程无法打开日志的问题，在<code>webserver/loadnginx.sh</code>中加上一行就好了</p>

<pre><code class="bash">     19     <span class="keyword"><span class="keyword">if</span></span> <span class="test_condition"><span class="test_condition">[ ! -d <span class="string"><span class="string">"<span class="variable"><span class="variable">$ODP_ROOT</span></span>/log/webserver"</span></span> ]</span></span>
     20     <span class="keyword"><span class="keyword">then</span></span>
     21         mkdir <span class="string"><span class="string">"<span class="variable"><span class="variable">$ODP_ROOT</span></span>/log/webserver"</span></span>
     22     <span class="keyword"><span class="keyword">fi</span></span>
     23     chmod 777 <span class="string"><span class="string">"<span class="variable"><span class="variable">$ODP_ROOT</span></span>/log/webserver"</span></span>   <span class="comment"><span class="comment"># 加上这一行</span></span>
</code></pre>

<p>对于root下nginx无法访问hhvm socket问题，也是因为权限问题，只要修改一下sock文件的权限即可。</p>

<pre><code class="php">chmod <span class="number"><span class="number">777</span></span> <span class="variable"><span class="variable">$ODP_ROOT</span></span>/<span class="keyword"><span class="keyword">var</span></span>/hhvm.sock
</code></pre>

            </div>
                <div class="bs-docs-section">
              <div class="page-header">
          <h1 id="联系我们">联系我们
            <a class="btn btn-edit btn-primary pull-right">
              <span class="glyphicon glyphicon-edit"></span> 编辑本段
            </a>
          </h1>
        </div>
                <h3>需求征集</h3>

<p>ODP 4.0需求征集开始了！
点开<a href="http://ask.babel.baidu.com/ask/question.html?qid=18691">http://ask.babel.baidu.com/ask/question.html?qid=18691</a>，回答“你希望ODP 4.0有哪些功能？”问题，说出你的需求吧！</p>

<h3>提问需知</h3>

<ol>
<li>对于php语法之类的公共问题，请先问<a href="http://www.baidu.com/">百度</a>、<a href="http://www.google.com/">谷歌</a></li>
<li>对于公司内部提供的库的问题，请先问<a href="http://babel.baidu.com/">babel</a>，或直接查<a href="http://man.baidu.com/">man平台手册</a>，或者看这里<a href="http://man.baidu.com/inf/odp/tutorial/#常见问题">ODP常见问题</a></li>
<li>尝试根据<a href="http://agroup.baidu.com/odp-dev/md/article/135557">ODP常见问题排查手册</a>进行排查。</li>
<li>如果你是新人，建议先问问导师</li>
<li>如果你使用某个库的问题，请看看你用的是哪个版本，尝试升级到最新版看看</li>
<li>反馈问题建议优先选择Hi群方式，响应最快</li>
<li>反馈问题时，请尽量给出详细的复现方法及错误日志</li>
<li>如果你发现man平台手册有错误或遗漏，可以告诉我们，也可以自己改（是的，你可以编辑它）</li>
</ol>

<h3>联系方式</h3>

<h4>ODP综合</h4>

<ul>
<li>ODP HI 服务号：<script src="./ODP_files/xp.open.js.下载"></script><a class="xp-follow-account" href="javascript:void(0)" onclick="doFollowHiPu(&#39;BGQiea2ldKmDhDc7B6-6aQ&#39;)"><img src="./ODP_files/followBtn.jpg"><img src="./ODP_files/followBtn(1).jpg"></a></li>
<li>ODP使用者群： 1359528（已满）</li>
<li>ODP使用者群2： 1463765</li>
<li>ODP外部用户群：1500998（供spinoff业务线同学、离职同学加入）</li>
<li>ODP用户邮件组：odp-user@baidu.com</li>
<li><a href="http://gitlab.baidu.com/odp/install-basic-env/issues">ODP需求空间</a></li>
</ul>

<h4>PHP</h4>

<ul>
<li>PHP群：1003069</li>
<li>PHP邮件组：php@baidu.com</li>
</ul>

<h4>HHVM</h4>

<ul>
<li>HHVM使用者群：1409622</li>
<li>HHVM邮件组：hhvm@baidu.com</li>
<li><a href="http://icafe.baidu.com/space/hhvm">HHVM需求空间</a></li>
</ul>

<h4>Nginx</h4>

<ul>
<li>Nginx技术交流群：1394476</li>
<li>Nginx邮件组：nginx@baidu.com</li>
<li><a href="http://nginx.baidu.com/forum/list.php?2">Nginx讨论区</a></li>
</ul>

<h4>RAL</h4>

<ul>
<li><a href="http://gitlab.baidu.com/ral/ral2/issues">RAL需求空间</a></li>
</ul>

            </div>
    
    </div>
  </div>
</div>


<footer class="bs-footer" role="contentinfo">
  <div class="container">

    <p>Web UI 由 <a href="http://getbootstrap.com/" target="_blank">Bootstrap 3.0</a> 框架驱动。</p>
    <ul class="footer-links">
      <li>手册贡献主要为 <a href="mailto:ksarch@baidu.com">ksarch@baidu.com</a> 及其用户。</li>
      <li class="muted">·</li>
    </ul>
    <p>有关手册平台本身的问题，请联系 <a href="baidu://message/?sid=&amp;id=jerry9032">Shen Jiale</a>，手册内容中的问题，请联系相应维护者。</p>
  </div>
</footer>

    <!-- JS and analytics only. -->
    <!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="./ODP_files/bootstrap.js.下载"></script>


<script src="./ODP_files/holder.min.js.下载"></script>
<script src="./ODP_files/highlight.min.js.下载"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script src="./ODP_files/autosuggest.js.下载"></script>
<script>edit_link="?edit=1";</script>
<script src="./ODP_files/application.js.下载"></script>
<script type="text/javascript" src="./ODP_files/MathJax.js.下载"></script>

<!--17313536400978465290122219-->
<script> var _trace_page_logid = 1731353640; </script><div id="MathJax_Font_Test" style="position: absolute; visibility: hidden; top: 0px; left: 0px; width: auto; padding: 0px; border: 0px; margin: 0px; white-space: nowrap; text-align: left; text-indent: 0px; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; font-size: 40px; font-weight: normal; font-style: normal; font-family: MathJax_AMS, Times;">MATHJAX AMS ˆ </div></body></html>